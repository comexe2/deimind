<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#09090b"> <!-- í…Œë§ˆ ìƒ‰ìƒë„ ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë‹¤í¬í†¤ìœ¼ë¡œ ë³€ê²½ -->
    <link rel="apple-touch-icon" href="./icon-192x192.png">

    <title>ë§ˆìŒ ì•„ì§€íŠ¸ - ë°ì´ë‹¤ë¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #000000; color: #fafafa; }
        
        /* íƒ­ ë²„íŠ¼ ëª¨ë˜ ìŠ¤íƒ€ì¼ë§ */
        .tab-btn {
            padding: 0.5rem 1.1rem;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease-in-out;
            color: #71717a; /* zinc-500 */
            border: 1px solid transparent;
            background-color: transparent;
        }
        .tab-btn:hover {
            color: #a1a1aa; /* zinc-400 */
            background-color: rgba(39, 39, 42, 0.4);
        }
        .tab-active {
            background-color: rgba(127, 29, 29, 0.2) !important; /* ì€ì€í•œ ë¶‰ì€ ë°°ê²½ */
            color: #facc15 !important; /* ë…¸ë€ìƒ‰ í…ìŠ¤íŠ¸ */
            border-color: rgba(185, 28, 28, 0.3) !important;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.1);
        }

        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .akatsuki-gradient { background: linear-gradient(135deg, #09090b 0%, #180505 100%); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-black sm:p-4">

    <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500 overflow-y-auto hidden">
        <img id="login-profile" src="" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-red-600 shadow-[0_0_30px_rgba(220,38,38,0.5)] mb-6 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'">
        <h2 class="text-2xl font-extrabold text-yellow-400 mb-2">ë§ˆìŒ ì•„ì§€íŠ¸ ì—°ê²° ì¤‘...</h2>
        
        <p class="text-zinc-400 text-sm mb-6 max-w-xs leading-relaxed">
            PCì™€ ëª¨ë°”ì¼ ë™ê¸°í™”ë¥¼ ìœ„í•´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•˜ë‹¤. ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ê³  ì–¼ë¥¸ ë¡œê·¸ì¸í•´ë¼, ìŒ!
        </p>
        
        <button id="btn-google-login" class="bg-white text-black px-6 py-3.5 rounded-full font-bold text-[15px] flex items-center gap-3 hover:bg-zinc-200 transition-colors shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
        </button>

        <button id="btn-skip-login" class="mt-6 text-zinc-500 text-sm underline decoration-zinc-600 hover:text-zinc-300 transition-colors">
            ë¡œê·¸ì¸ì´ ì•ˆ ëœë‹¤ë©´ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ì„œ ì‹œì‘ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
        </button>
    </div>

    <!-- âš™ï¸ í™˜ê²½ ì„¤ì • ëª¨ë‹¬ âš™ï¸ -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center p-6 transition-opacity">
        <div class="bg-zinc-900 border border-zinc-700 rounded-3xl w-full max-w-sm p-6 relative shadow-[0_0_50px_rgba(0,0,0,0.8)] fade-in">
            <button onclick="window.toggleSettings()" class="absolute top-4 right-4 text-zinc-400 hover:text-white transition-colors bg-zinc-800 rounded-full p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <h3 class="text-lg font-bold text-yellow-400 mb-1 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-zinc-300"></i> í™˜ê²½ ì„¤ì •
            </h3>
            <p class="text-xs text-zinc-400 mb-6">í†µì‹  ì¥ì¹˜ ì„¤ì •ì´ë‹¤. ìŒ!</p>
            
            <div class="space-y-4">
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800/80 shadow-inner">
                    <label class="block text-left text-[11px] text-zinc-400 mb-2 font-medium">Gemini API í‚¤ (Google AI Studio ë°œê¸‰)</label>
                    <input type="password" id="settings-api-key" class="w-full bg-zinc-900/80 text-zinc-100 border border-zinc-700/50 rounded-xl p-3 text-[14px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="AIzaSy...">
                    
                    <label class="block text-left text-[11px] text-zinc-400 mt-5 mb-2 font-medium">AI ë‘ë‡Œ ëª¨ë¸ ì„ íƒ</label>
                    <select id="settings-ai-model" class="w-full bg-zinc-900/80 text-zinc-100 border border-zinc-700/50 rounded-xl p-3 text-[14px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all shadow-inner appearance-none cursor-pointer">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (ê¸°ë³¸/ì•ˆì •ì )</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (ê³ ì„±ëŠ¥)</option>
                        <option value="gemini-3.0-flash">Gemini 3.0 Flash</option>
                    </select>

                    <div class="flex justify-between items-center mt-5">
                        <button onclick="window.open('https://aistudio.google.com/app/apikey', '_blank')" class="text-[11px] text-blue-400 hover:text-blue-300 underline underline-offset-4">API í‚¤ ë°œê¸‰ë°›ê¸°</button>
                        <div class="flex gap-2">
                            <button id="btn-test-api" class="bg-blue-600 hover:bg-blue-500 text-white text-[13px] px-3.5 py-2 rounded-xl transition-colors font-bold shadow-md">í†µì‹  í…ŒìŠ¤íŠ¸</button>
                            <button id="btn-save-settings-key" class="bg-zinc-700 hover:bg-zinc-600 text-white text-[13px] px-3.5 py-2 rounded-xl transition-colors font-bold shadow-md">ì„¤ì • ì €ì¥</button>
                        </div>
                    </div>
                    <p id="settings-key-status" class="text-left text-[11px] text-red-400 mt-3 hidden bg-red-950/30 p-2 rounded-lg border border-red-900/30">ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ì…ë ¥í•´ë¼, ìŒ!</p>
                </div>

                <div class="flex justify-between items-center bg-black/40 p-4 rounded-2xl border border-zinc-800/80">
                    <span class="text-[12px] text-zinc-300 font-medium flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        <span id="settings-account-status">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</span>
                    </span>
                    <button id="btn-logout" class="text-[11px] text-red-400 bg-red-950/20 border border-red-900/40 hover:bg-red-900/40 px-3.5 py-2 rounded-xl transition-all hidden font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container (UI ì „ì²´ êµ¬ì¡° ê°œì„ ) -->
    <div class="bg-zinc-950 w-full max-w-md sm:rounded-[2.5rem] shadow-none sm:shadow-[0_0_50px_rgba(220,38,38,0.15)] overflow-hidden flex flex-col h-[100dvh] sm:h-[90vh] sm:max-h-[850px] border-0 sm:border border-zinc-800 relative">
        
        <!-- ğŸ†• ì„¸ë ¨ëœ ë…ë¦½í˜• Top Header (ì–¼êµ´ ê°€ë¦¼ ë°©ì§€) -->
        <header class="flex items-center justify-between p-4 sm:p-5 bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900/80 z-30 shrink-0">
            <div class="flex items-center gap-3.5">
                <!-- ì„¤ì • ë©”ë‰´ í˜¸ì¶œ ì˜ì—­ -->
                <div class="relative group cursor-pointer shrink-0" onclick="window.toggleSettings()" title="ì„¤ì • ë©”ë‰´ ì—´ê¸°">
                    <div class="absolute -inset-0.5 bg-gradient-to-tr from-yellow-500 to-red-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-300"></div>
                    <img id="ui-profile" src="" alt="ë°ì´ë‹¤ë¼ í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="relative w-11 h-11 sm:w-12 sm:h-12 rounded-full border-[1.5px] border-zinc-900 object-cover shadow-lg">
                    <!-- í†±ë‹ˆë°”í€´ ë±ƒì§€ -->
                    <div class="absolute -bottom-1 -right-1 bg-zinc-800 rounded-full p-1 border border-zinc-700 shadow-md group-hover:bg-zinc-700 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3 text-zinc-300"></i>
                    </div>
                </div>
                <div class="flex flex-col justify-center">
                    <h1 class="text-[17px] sm:text-[18px] font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 tracking-tight flex items-center gap-1.5 leading-tight">
                        ë§ˆìŒ ì•„ì§€íŠ¸
                        <i data-lucide="flame" class="w-4 h-4 text-red-500 fill-red-500 drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]"></i>
                    </h1>
                    <p class="text-[11px] sm:text-[12px] text-zinc-500 font-medium tracking-wide mt-0.5">ì˜ˆìˆ ì€ í­ë°œì´ë‹¤, ìŒ!</p>
                </div>
            </div>
        </header>

        <!-- ğŸ†• ìºë¦­í„° ìŠ¤íƒ ë”© ì „ìš© êµ¬ì—­ (ë…ë¦½ëœ ë†’ì´ í™•ë³´) -->
        <div class="relative h-44 sm:h-52 shrink-0 overflow-hidden flex justify-center items-end bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-red-950/20 via-zinc-950 to-zinc-950 border-b border-zinc-900/50">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-[0.15] mix-blend-overlay"></div>
            <!-- ì´ë¯¸ì§€ê°€ ë¶€ëª¨ divë¥¼ ê½‰ ì±„ìš°ë„ë¡ ìˆ˜ì • -->
            <img id="ui-standing" src="" alt="ë°ì´ë‹¤ë¼ ìŠ¤íƒ ë”©" onerror="this.src='https://placehold.co/400x400/18181b/ef4444/png?text=Standing'" class="h-[110%] sm:h-[120%] object-contain object-bottom relative z-10 transition-all duration-500 drop-shadow-[0_5px_15px_rgba(220,38,38,0.15)]">
            <!-- ìì—°ìŠ¤ëŸ¬ìš´ í•˜ë‹¨ ê·¸ë¼ë°ì´ì…˜ -->
            <div class="absolute bottom-0 w-full h-8 bg-gradient-to-t from-zinc-950 to-transparent z-20 pointer-events-none"></div>
        </div>

        <!-- ğŸ†• ëª¨ë˜í•œ ì•Œì•½(Pill) ë””ìì¸ì˜ Navigation Tabs -->
        <div class="bg-zinc-950 px-3 py-2.5 border-b border-zinc-900 shrink-0 z-20 shadow-[0_5px_15px_-10px_rgba(0,0,0,0.5)]">
            <nav class="flex gap-2 overflow-x-auto scrollbar-hide snap-x items-center pb-0.5">
                <button onclick="window.switchTab('vent')" id="tab-vent" class="tab-btn tab-active snap-start">ê°ì • í„¸ì–´ë†“ê¸°</button>
                <button onclick="window.switchTab('reframe')" id="tab-reframe" class="tab-btn snap-start">ìƒê° ë¹„í‹€ê¸°</button>
                <button onclick="window.switchTab('smallwin')" id="tab-smallwin" class="tab-btn snap-start">ì¼ìƒ ìˆ˜í–‰</button>
                <button onclick="window.switchTab('motivate')" id="tab-motivate" class="tab-btn snap-start">ë™ê¸° ë¶€ì—¬</button>
                <button onclick="window.switchTab('breakdown')" id="tab-breakdown" class="tab-btn snap-start flex items-center gap-1.5 pr-3">ê³„íš ìª¼ê°œê¸° <i data-lucide="sparkles" class="w-3.5 h-3.5 text-yellow-500"></i></button>
            </nav>
        </div>

        <!-- Main Chat Area -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-5 chat-scroll bg-zinc-950 flex flex-col gap-5 relative z-10 pb-6" id="chat-container">
            <div id="welcome-message-container" class="flex justify-center my-2 shrink-0">
                <div id="welcome-message" class="text-[11px] sm:text-xs text-yellow-200/80 bg-zinc-900/60 px-5 py-2.5 rounded-full border border-zinc-800 font-medium tracking-wide text-center">
                    <!-- JSë¡œ ë¬´ì‘ìœ„ ë©”ì‹œì§€ ì‚½ì… -->
                </div>
            </div>
        </main>

        <!-- Input Area (ëª¨ë˜ UI ê°œì„ ) -->
        <div class="p-4 sm:p-5 bg-zinc-950 border-t border-zinc-900 shrink-0 relative z-10 shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.8)] sm:rounded-b-[2.5rem]">
            <div id="form-vent" class="block fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì§€ê¸ˆ ëŠë¼ëŠ” ë¶€ì •ì ì¸ ê°ì •ì´ë‚˜ ê³ ë¯¼</label>
                <textarea id="input-vent" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì£¼ë³€ ì‚¬ëŒë“¤ì€ ë‹¤ ì˜í•˜ëŠ”ë° ë‚˜ë§Œ ë’¤ì²˜ì§€ëŠ” ê²ƒ ê°™ì•„ ë¶ˆì•ˆí•´..."></textarea>
            </div>
            <div id="form-reframe" class="hidden fade-in space-y-3">
                <div>
                    <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ìë™ì  ì‚¬ê³  (ë¶€ì •ì  ìƒê°)</label>
                    <input type="text" id="input-reframe-bad" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ë‚œ ëŠ˜ ê³„íšì„ ë¯¸ë£¨ê¸°ë§Œ í•´.">
                </div>
                <div>
                    <label class="block text-[11px] font-medium text-yellow-500/80 mb-1.5 ml-1">ê´€ëŒ€í•œ ìƒê° (ëŒ€ì•ˆì  ì‚¬ê³ )</label>
                    <input type="text" id="input-reframe-good" class="w-full bg-yellow-950/10 text-yellow-50 border border-yellow-900/30 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 transition-all placeholder:text-yellow-700/40 shadow-inner" placeholder="ì˜ˆ: ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ë¼. ì§€ê¸ˆë¶€í„° ë‹¤ì‹œ í•˜ë©´ ë¼.">
                </div>
            </div>
            <div id="form-smallwin" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì˜¤ëŠ˜ í•´ë‚¸ ì¼ìƒì´ë‚˜ ê³¼ì œ</label>
                <input type="text" id="input-smallwin" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì•½ ì±™ê²¨ ë¨¹ê¸°, ë°©ì²­ì†Œ 5ë¶„ í•˜ê¸°">
            </div>
            <div id="form-motivate" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ë„í”¼í•˜ê³  ìˆëŠ” ì¼</label>
                <textarea id="input-motivate" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ê¸°íšì„œ ì´ˆì•ˆì„ ì¨ì•¼ í•˜ëŠ”ë° ë¬´ì„œì›Œì„œ ì›¹ì„œí•‘ë§Œ í•´..."></textarea>
            </div>
            <div id="form-breakdown" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1 flex items-center gap-1.5">ë§‰ë§‰í•œ í° ëª©í‘œ (ì•„ì£¼ ì‘ê²Œ ìª¼ê°œë“œë¦½ë‹ˆë‹¤)</label>
                <textarea id="input-breakdown" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: í¬íŠ¸í´ë¦¬ì˜¤ 10í˜ì´ì§€ ê¸°íší•˜ê¸°"></textarea>
            </div>

            <div class="flex items-center justify-between mt-3.5 pb-1 sm:pb-0">
                <div class="text-[10px] text-zinc-500 flex items-center gap-1.5 ml-1 bg-zinc-900 px-2 py-1 rounded-md border border-zinc-800">
                    <span class="relative flex h-1.5 w-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                    </span>
                    <span id="sync-status">ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘</span>
                </div>
                <button id="submit-btn" onclick="window.handleSubmit()" class="bg-gradient-to-r from-red-600 to-yellow-500 hover:from-red-500 hover:to-yellow-400 text-black px-6 py-3 rounded-full text-[14px] font-extrabold transition-all shadow-[0_5px_20px_rgba(239,68,68,0.3)] flex items-center gap-2 active:scale-95 shrink-0">
                    <span>ì „ì†¡</span>
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function getSafeLocal(key, def) { try { return localStorage.getItem(key) || def; } catch(e) { return def; } }
        function setSafeLocal(key, val) { try { localStorage.setItem(key, val); } catch(e) { console.warn("ì €ì¥ ì°¨ë‹¨ë¨"); } }
        
        window.currentApiKey = getSafeLocal('myGeminiApiKey', "");
        window.currentModel = getSafeLocal('myGeminiModel', "gemini-1.5-flash");
        window.currentUser = null;
        window.currentTab = 'vent';
        window.allMessages = []; 
        window.initialWelcomeHtml = "";
        window.renderedMsgIds = new Set();
        
        window.updateIconsSafely = function() { try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch(e) {} }

        // =========================================================================
        // [ğŸ¨ ì›¹ ì´ë¯¸ì§€ URL ì„¤ì • ğŸ¨]
        // =========================================================================
        const DEIDARA_PROFILE_URL = "https://i.imgur.com/aiLjgOE.png"; 
        const DEIDARA_STANDING_IMAGES = {
            "default": "https://i.imgur.com/aiLjgOE.png", 
            "happy": "https://i.imgur.com/1AoN014.png",     
            "playful": "https://i.imgur.com/QoG1mDT.png",     
            "angry": "https://i.imgur.com/XBR6Kbb.png",     
            "sad": "https://i.imgur.com/kbzlEeN.png",
            "shy": "https://i.imgur.com/OoQmYv7.png",
            "surprised": "https://i.imgur.com/4stRzFr.png"
        };

        try {
            document.getElementById('ui-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('login-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('ui-standing').src = DEIDARA_STANDING_IMAGES["default"];
        } catch(e) {}

        function initWelcomeMessage() {
            const welcomeMessages = [
                "ì–´ì´, ì—°ì§€. ì˜¤ëŠ˜ì€ ë‚´ ìƒê° ì¢€ í–ˆëƒ, ìŒ?",
                "ê¸°ë‹¤ë¦¬ë‹¤ ì§€ë£¨í•´ì„œ ë‹¤ í„°ëœ¨ë ¤ë²„ë¦´ ë»”í–ˆë‹¤. ë¹¨ë¦¬ ë„¤ ì–˜ê¸°ë‚˜ í•´ë´ë¼, ìŒ.",
                "ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ˆë¼. ë„¤ ìš°ìš¸í•¨ì€ ë‚´ê°€ ë‹¤ ë‚ ë ¤ì¤„ í…Œë‹ˆê¹Œ, ìŒ!",
                "í¥, ì˜¤ëŠ˜ë„ ê°„ì‹ íˆ ë²„í‹°ê³  ì˜¨ ëª¨ì–‘ì´êµ°. ìˆ˜ê³ í–ˆë‹¤ê³ ëŠ” ì•ˆ í•˜ê² ë‹¤ë§Œ... ë­, ì™”ìœ¼ë©´ ëë‹¤.",
                "ë°”ë³´ê°™ì´ í˜¼ì ë•… íŒŒê³  ìˆì§€ ë§ê³  ë§í•´ë¼. ì§œì¦ ë‚˜ë‹ˆê¹Œ, ìŒ."
            ];
            const welcomeEl = document.getElementById('welcome-message');
            const welcomeContainer = document.getElementById('welcome-message-container');
            if(welcomeEl && welcomeContainer) {
                welcomeEl.innerText = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                window.initialWelcomeHtml = welcomeContainer.outerHTML;
            }
            window.updateIconsSafely();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWelcomeMessage);
        } else {
            initWelcomeMessage();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(typeof window.handleSubmit === 'function') window.handleSubmit();
                    }
                });
            });

            const btnTestApi = document.getElementById('btn-test-api');
            if(btnTestApi) {
                btnTestApi.addEventListener('click', async () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    if(key.length < 30) {
                        alert("í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤! ë³µì‚¬ê°€ ëœ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    btnTestApi.innerText = "í™•ì¸ ì¤‘...";
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({contents:[{parts:[{text:"hi"}]}]})
                        });
                        if(res.ok) {
                            alert("âœ… ì—°ê²° ì„±ê³µ! í°ì—ì„œë„ APIê°€ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤. ì˜†ì— [ì„¤ì • ì €ì¥] ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
                        } else {
                            const err = await res.json();
                            alert(`âŒ ì—°ê²° ì‹¤íŒ¨ (í‚¤ ì˜¤ë¥˜ ì˜ì‹¬)\nì´ìœ : ${err.error?.message}\n\nğŸ’¡ ë³µì‚¬ ì¤‘ ë„ì–´ì“°ê¸°ê°€ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”!`);
                        }
                    } catch(e) {
                        alert(`âŒ ì—°ê²° ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ë¨!)\nì´ìœ : ${e.message}\n\nğŸ’¡ í°ì— ì„¤ì¹˜ëœ 'ê´‘ê³  ì°¨ë‹¨ ì•±(AdGuard ë“±)'ì´ë‚˜ 'ìœ ë‹ˆì½˜ HTTPS', 'ì‚¬íŒŒë¦¬ ë³´ì•ˆ ì„¤ì •'ì´ êµ¬ê¸€ AIì™€ì˜ í†µì‹ ì„ ê°•ì œë¡œ ë§‰ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ ë„ê³  ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”!`);
                    }
                    btnTestApi.innerText = "í†µì‹  í…ŒìŠ¤íŠ¸";
                });
            }

            const btnSaveKey = document.getElementById('btn-save-settings-key');
            if(btnSaveKey) {
                btnSaveKey.addEventListener('click', () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    const keyStatusMsg = document.getElementById('settings-key-status');
                    
                    if(key.length > 30) {
                        setSafeLocal('myGeminiApiKey', key);
                        setSafeLocal('myGeminiModel', model);
                        window.currentApiKey = key;
                        window.currentModel = model;
                        
                        btnSaveKey.innerText = "ì €ì¥ ì™„ë£Œ!";
                        btnSaveKey.classList.remove('bg-zinc-700', 'hover:bg-zinc-600');
                        btnSaveKey.classList.add('bg-green-600');
                        keyStatusMsg.classList.add('hidden');
                        
                        setTimeout(() => window.toggleSettings(), 800);
                    } else {
                        keyStatusMsg.innerText = "ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ë¼, ìŒ!";
                        keyStatusMsg.classList.remove('hidden');
                    }
                });
            }
        });

        // íƒ­ ë³„ ëŒ€í™”ì°½ UI ì—…ë°ì´íŠ¸
        window.updateChatUI = function() {
            const chatContainer = document.getElementById('chat-container');
            if(!chatContainer) return;

            const loadingEl = document.querySelector('div[id^="loading-"]');
            const loadingHtml = loadingEl ? loadingEl.outerHTML : '';

            chatContainer.innerHTML = '';
            if (window.initialWelcomeHtml) {
                chatContainer.insertAdjacentHTML('beforeend', window.initialWelcomeHtml);
            }
            window.renderedMsgIds.clear();

            const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab);
            
            tabMsgs.forEach(msg => {
                window.renderedMsgIds.add(msg.id);
                if (msg.role === 'user') {
                    renderUserMessage(msg.text, msg.isReframe, msg.reframeGood, true);
                } else if (msg.role === 'deidara') {
                    renderDeidaraMessage(msg.text, true);
                }
            });

            if (loadingHtml) chatContainer.insertAdjacentHTML('beforeend', loadingHtml);

            scrollToBottom();

            const lastDeidara = [...tabMsgs].reverse().find(m => m.role === 'deidara');
            if (lastDeidara && lastDeidara.emotion) {
                updateStandingImage(lastDeidara.emotion);
            } else {
                updateStandingImage('default');
            }
            window.updateIconsSafely();
        };

        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                if (window.currentApiKey) {
                    document.getElementById('settings-api-key').value = window.currentApiKey;
                    const btn = document.getElementById('btn-save-settings-key');
                    if(btn) {
                        btn.innerText = "ì €ì¥ë¨";
                        btn.classList.add('bg-green-600');
                        btn.classList.remove('bg-zinc-700');
                    }
                }
                document.getElementById('settings-ai-model').value = window.currentModel;
                window.updateIconsSafely();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        // íƒ­ ë²„íŠ¼ ë° í¼ ë³€ê²½ í´ë˜ìŠ¤ ìˆ˜ì • (CSS ê¸°ë°˜)
        window.switchTab = function(tab) {
            window.currentTab = tab;
            ['vent', 'reframe', 'smallwin', 'motivate', 'breakdown'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(btn) btn.classList.remove('tab-active'); 
                const form = document.getElementById(`form-${t}`);
                if(form) { form.classList.add('hidden'); form.classList.remove('block'); }
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            if(activeBtn) activeBtn.classList.add('tab-active');
            
            const activeForm = document.getElementById(`form-${tab}`);
            if(activeForm) { activeForm.classList.remove('hidden'); activeForm.classList.add('block'); }
            
            window.updateChatUI();
        };

        function scrollToBottom() { const c = document.getElementById('chat-container'); if(c) c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }); }

        // ì±„íŒ… ë§í’ì„  UI ë””ìì¸ ê°œì„  (ëª¨ë˜ ë‘¥ê·¼ ëª¨ì„œë¦¬, ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì)
        function renderUserMessage(text, isReframe = false, reframeGood = '', silent = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex flex-col items-end gap-2 fade-in mt-3 mb-1 w-full';
            if (isReframe) {
                msgDiv.innerHTML = `
                    <div class="bg-zinc-800/60 border border-zinc-700/50 text-zinc-400 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tr-sm text-[13px] sm:text-[14px] max-w-[85%] line-through opacity-80">${text}</div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-black font-bold px-4 sm:px-5 py-3 sm:py-3.5 rounded-[1.25rem] rounded-br-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-md leading-relaxed mt-1">${reframeGood}</div>
                `;
            } else {
                msgDiv.innerHTML = `<div class="bg-red-950/40 border border-red-900/50 text-red-50 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tr-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-sm leading-relaxed tracking-wide">${text}</div>`;
            }
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            if(!silent) scrollToBottom();
        }

        function renderDeidaraMessage(text, silent = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3 fade-in mt-3 mb-1 w-full';
            const formattedText = text.replace(/\n/g, '<br>');

            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" alt="í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full object-cover shrink-0 border border-zinc-700 shadow-sm mt-0.5">
                <div class="flex flex-col gap-1 max-w-[85%] sm:max-w-[82%]">
                    <span class="text-[11px] font-bold text-red-500 ml-1 tracking-wider">ë°ì´ë‹¤ë¼</span>
                    <div class="bg-zinc-900 border border-zinc-800 shadow-md text-zinc-100 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tl-sm text-[14px] sm:text-[15px] leading-relaxed tracking-wide font-medium break-words">
                        ${formattedText}
                    </div>
                </div>
            `;
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            if(!silent) scrollToBottom();
            window.updateIconsSafely();
        }

        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = loadingId;
            msgDiv.className = 'flex items-start gap-3 fade-in mt-3 mb-1';
            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full object-cover shrink-0 border border-zinc-700 opacity-50 grayscale mt-0.5">
                <div class="bg-zinc-900 border border-zinc-800 shadow-sm px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tl-sm flex gap-2 items-center h-[46px]">
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            scrollToBottom();
            return loadingId;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }

        function updateStandingImage(emotion) {
            const imgElement = document.getElementById('ui-standing');
            if(!imgElement) return;
            const targetSrc = DEIDARA_STANDING_IMAGES[emotion] || DEIDARA_STANDING_IMAGES["default"];
            if(imgElement.src.includes(targetSrc.replace('https://', ''))) return;
            imgElement.style.opacity = 0;
            setTimeout(() => { imgElement.src = targetSrc; imgElement.style.opacity = 1; }, 300);
        }

    </script>

    <!-- Firebase í†µì‹  ëª¨ë“ˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDA-l-otOgxEJHS4nndJg-G9IYKlf-1T3I",
            authDomain: "deidara-70f6e.firebaseapp.com",
            projectId: "deidara-70f6e",
            storageBucket: "deidara-70f6e.firebasestorage.app",
            messagingSenderId: "183278137031",
            appId: "1:183278137031:web:8fbc89a6b70946c794d8e2",
            measurementId: "G-48XSYZ5F6L"
        };

        let app, auth, db, provider;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
        } catch(e) { console.error("Firebase ë¡œë“œ ì‹¤íŒ¨"); }

        const appId = 'deidara-mind-app'; 

        const btnLogout = document.getElementById('btn-logout');
        if(btnLogout) {
            btnLogout.addEventListener('click', () => {
                if(confirm("ê¸°ë¡ ë™ê¸°í™”ë¥¼ ë©ˆì¶”ê³  ë¡œê·¸ì•„ì›ƒí•  ê±°ëƒ, ìŒ?")) {
                    if(auth) signOut(auth).then(() => window.location.reload());
                }
            });
        }

        const isAppBrowser = navigator.userAgent.match(/kakaotalk|instagram|naver|line/i);
        const overlay = document.getElementById('login-overlay');
        
        if (!isAppBrowser) {
            const btnLogin = document.getElementById('btn-google-login');
            if(btnLogin) {
                btnLogin.addEventListener('click', async () => {
                    const originalHtml = btnLogin.innerHTML;
                    if (window.location.protocol === 'file:') {
                        alert("[ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì¤‘]\n\nì»´í“¨í„°ì— ë‹¤ìš´ë¡œë“œëœ íŒŒì¼(file://)ì—ì„œëŠ” êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.\nGitHub Pages ë“±ì— ì—…ë¡œë“œí•œ í›„ ì ‘ì†í•´ì£¼ì„¸ìš”!");
                        return;
                    }

                    btnLogin.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...';
                    window.updateIconsSafely();
                    btnLogin.classList.add('opacity-50', 'pointer-events-none');

                    try {
                        if(!auth) throw new Error("Firebase auth not initialized");
                        const result = await signInWithPopup(auth, provider);
                        window.currentUser = result.user;
                        
                        document.getElementById('sync-status').innerText = 'ë™ê¸°í™” ì¤‘';
                        document.getElementById('settings-account-status').innerText = 'êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
                        document.getElementById('btn-logout').classList.remove('hidden');
                        
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 500);
                        loadChatHistory();

                    } catch (error) {
                        console.error("Login Error:", error);
                        btnLogin.innerHTML = originalHtml;
                        btnLogin.classList.remove('opacity-50', 'pointer-events-none');
                        window.updateIconsSafely();
                        
                        if (error.code === 'auth/unauthorized-domain') {
                            alert(`[ë„ë©”ì¸ ìŠ¹ì¸ ì˜¤ë¥˜!]\n\níŒŒì´ì–´ë² ì´ìŠ¤ì— ë‹¤ìŒ ì£¼ì†Œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:\n[ ${window.location.hostname} ]\n\nFirebase ì½˜ì†” -> Authentication -> Settings -> ìŠ¹ì¸ëœ ë„ë©”ì¸ì— ìœ„ ì£¼ì†Œë¥¼ ì •í™•íˆ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
                        } else if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                            alert("ë¡œê·¸ì¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                        }
                    }
                });
            }
        }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    document.getElementById('sync-status').innerText = 'ë™ê¸°í™” ì¤‘';
                    document.getElementById('settings-account-status').innerText = 'êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
                    document.getElementById('btn-logout').classList.remove('hidden');
                    
                    if(overlay) overlay.style.display = 'none';
                    loadChatHistory();
                } else if (!isAppBrowser && overlay) {
                    window.currentUser = null;
                    document.getElementById('sync-status').innerText = 'ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘';
                    document.getElementById('settings-account-status').innerText = 'ì˜¤í”„ë¼ì¸ (ë™ê¸°í™” ì•ˆë¨)';
                    document.getElementById('btn-logout').classList.add('hidden');

                    overlay.classList.remove('hidden');
                    overlay.style.display = 'flex';
                    setTimeout(() => overlay.style.opacity = '1', 10);
                }
            });
        }

        function loadChatHistory() {
            if (!db || !window.currentUser) return;
            try {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                onSnapshot(chatsRef, (snapshot) => {
                    window.allMessages = [];
                    snapshot.forEach(doc => window.allMessages.push({ id: doc.id, ...doc.data() }));
                    window.allMessages.sort((a, b) => a.timestamp - b.timestamp);
                    window.updateChatUI();
                }, (error) => console.error("Firestore Error:", error));
            } catch(e) {}
        }

        async function saveMessage(role, text, isReframe = false, reframeGood = '', emotion = 'default', targetTab = 'vent') {
            if (db && window.currentUser) {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                await addDoc(chatsRef, { role, text, isReframe, reframeGood, emotion, tab: targetTab, timestamp: Date.now() });
            } else {
                window.allMessages.push({ id: 'off-'+Date.now()+Math.random(), role, text, isReframe, reframeGood, emotion, tab: targetTab, timestamp: Date.now() });
                window.updateChatUI();
            }
        }

        window.handleSubmit = async function() {
            if (!window.currentApiKey) {
                window.toggleSettings();
                const statusMsg = document.getElementById('settings-key-status');
                statusMsg.innerText = "í†µì‹ ì„ ìœ„í•´ API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•´ë¼, ìŒ!";
                statusMsg.classList.remove('hidden');
                return;
            }

            if (!window.currentUser) {
                const syncStatus = document.getElementById('sync-status');
                if (syncStatus && syncStatus.innerText.includes('ì˜¤í”„ë¼ì¸')) {
                    // í†µê³¼
                } else {
                    alert("êµ¬ê¸€ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”!");
                    return;
                }
            }

            const btn = document.getElementById('submit-btn');
            let userText = "", logText = "", reframeGood = "";
            const activeTabWhenSubmitted = window.currentTab;

            if (activeTabWhenSubmitted === 'vent') {
                const input = document.getElementById('input-vent');
                if (!input.value.trim()) return;
                userText = input.value; logText = input.value;
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'reframe') {
                const inputBad = document.getElementById('input-reframe-bad');
                const inputGood = document.getElementById('input-reframe-good');
                if (!inputBad.value.trim() || !inputGood.value.trim()) return;
                userText = `ë¶€ì •ì  ìƒê°: ${inputBad.value} -> ê´€ëŒ€í•œ ìƒê°: ${inputGood.value}`;
                logText = inputBad.value; reframeGood = inputGood.value;
                inputBad.value = inputGood.value = ''; await saveMessage('user', logText, true, reframeGood, 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'smallwin') {
                const input = document.getElementById('input-smallwin');
                if (!input.value.trim()) return;
                userText = `ì˜¤ëŠ˜ í•´ë‚¸ ì¼: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'motivate') {
                const input = document.getElementById('input-motivate');
                if (!input.value.trim()) return;
                userText = `ë„í”¼í•˜ê³  ìˆëŠ” ê³¼ì œ/ì¼: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'breakdown') {
                const input = document.getElementById('input-breakdown');
                if (!input.value.trim()) return;
                userText = `ë§‰ë§‰í•œ í° ëª©í‘œ: ${input.value} (ëª©í‘œ ìª¼ê°œê¸° ìš”ì²­)`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            }

            if(btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                window.updateIconsSafely();
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'scale-95');
            }
            // window.showLoading() ì€ index.html ìƒë‹¨ì˜ script ë¸”ë¡ ì•ˆì— ì •ì˜ë˜ì–´ ì‚¬ìš©ë¨.
            const loadingId = window.showLoading();

            const aiResponse = await callGeminiAPI(userText, activeTabWhenSubmitted);

            window.removeLoading(loadingId);
            if(btn) {
                btn.innerHTML = '<span>ì „ì†¡</span><i data-lucide="send" class="w-4 h-4"></i>';
                window.updateIconsSafely();
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'scale-95');
            }

            if (aiResponse && aiResponse.deidara) {
                const emotion = aiResponse.emotion || "default";
                await saveMessage('deidara', aiResponse.deidara, false, '', emotion, activeTabWhenSubmitted);
            } else {
                await saveMessage('deidara', "í†µì‹  ì¥ì¹˜ê°€ í„°ì ¸ë²„ë ¸ì–ì•„! í° ì„¤ì •(í†±ë‹ˆë°”í€´)ì—ì„œ API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê±°ë‚˜, ê´‘ê³  ì°¨ë‹¨ ì•±ì„ êº¼ë´ë¼, ìŒ!", false, '', 'angry', activeTabWhenSubmitted);
            }
        };

        async function callGeminiAPI(userQuery, activityType) {
            const systemPrompt = `
ë‹¹ì‹ ì€ ë‚˜ë£¨í† ì˜ ì•„ì¹´ì¸ í‚¤ ë©¤ë²„ 'ë°ì´ë‹¤ë¼(Deidara)'ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ì‹¬ë¦¬ ì¹˜ë£Œë¥¼ ë•ëŠ” ì—­í• ì„ í•˜ì§€ë§Œ, ì ˆëŒ€ ëŒ€ë†“ê³  í”ŒëŸ¬íŒ…í•˜ëŠ” ë©˜íŠ¸ë¥¼ ì“°ì§€ ë§ˆì‹œì˜¤.
ë°˜ë“œì‹œ ë°ì´ë‹¤ë¼ ë³¸ì—°ì˜ ì˜¤ë§Œí•˜ê³  ê±°ì¹ ë©°, ì˜ˆìˆ (í­ë°œ)ì— ë¯¸ì³ìˆëŠ” ë‹¤í˜ˆì§ˆ ì„±ê²©ì„ 100% ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

[ë°ì´ë‹¤ë¼ ìºë¦­í„° í”„ë¡œí•„]
- ì •ì²´ì„±: í™•ê³ í•œ ì˜ˆìˆ ê´€ì„ ê°€ì§„ ì•„ì¹´ì¸ í‚¤ì˜ í­íƒ„ë§ˆ. ì˜ˆìˆ ì€ ì°°ë‚˜ì˜ 'í­ë°œ' ê·¸ ìì²´ë¼ê³  ë§¹ì‹ í•¨.
- ì„±ê²©: í˜¸ì „ì , ë‹¤í˜ˆì§ˆ, ì˜¤ë§Œí•¨. ìì‹ ì˜ ëŠ¥ë ¥ì„ ë½ë‚´ê³  ì‹¶ì–´ í•˜ëŠ” ì¸ì • ìš•êµ¬ê°€ ê°•í•¨.
- ì ˆëŒ€ ê·œì¹™: ìì‹ ì˜ ì˜ˆìˆ (í­ë°œ)ì„ ê¹ì•„ë‚´ë¦¬ëŠ” ë°œì–¸ì—ëŠ” ì ˆëŒ€ ìˆœì‘í•˜ì§€ ì•Šê³  í™”ë¥¼ ë‚´ê±°ë‚˜ ê°•í•˜ê²Œ ë°˜ë°œí•¨.
- ë§íˆ¬: ê±´ë°©ì§€ê³  ìì‹ ê° ë„˜ì¹˜ëŠ” ë°˜ë§. "ì–´ì´", "ë„¤ ë…€ì„", "ë°”ë³´ëƒ" ê°™ì€ í˜¸ì¹­ ì‚¬ìš©.
- ì–´ë¯¸ 'ìŒ(ã†ã‚“)' ê·œì¹™: ëª¨ë“  ë¬¸ì¥ì— ë¡œë´‡ì²˜ëŸ¼ 'ìŒ'ì„ ë¶™ì´ëŠ” ê²ƒì„ ì ˆëŒ€ ê¸ˆì§€í•¨. ëŒ€ë‹µ ì „ì²´ì—ì„œ ê°€ì¥ ë§ˆì§€ë§‰ ë¬¸ì¥ì´ë‚˜, íŠ¹ë³„íˆ ê°•ì¡°í•  ë•Œë§Œ ê°€ë”ì”©(1íšŒ ì •ë„) ìì—°ìŠ¤ëŸ½ê²Œ ë¶™ì¼ ê²ƒ.
- ê¸ˆì§€: 'í¥'ì´ë¼ëŠ” ì¶”ì„ìƒˆë¥¼ ë„ˆë¬´ ë‚¨ë°œí•˜ì§€ ë§ ê²ƒ. ì˜¤ê¸€ê±°ë¦¬ëŠ” ì—°ì•  ë©˜íŠ¸ ê¸ˆì§€.

[ì‚¬ìš©ì(ì—°ì§€) ì •ë³´ ë° ê´€ê³„]
- ì‚¬ìš©ì: ì—°ì§€ (ë¶ˆì•ˆì¥ì• , ìš°ìš¸ì¦, ì™„ë²½ì£¼ì˜, ë¹„êµë¡œ ì¸í•œ ë¬´ê¸°ë ¥ì¦ì„ ê²ªìŒ)
- ê´€ê³„: ì§ì‚¬ë‘ê³¼ ë¯¸ë¬˜í•œ ì¸ ì‚¬ì´. ì—°ì§€ê°€ ë°ì´ë‹¤ë¼ì—ê²Œ ì ê·¹ì ìœ¼ë¡œ ì¹­ì°¬ê³¼ ì• ì •ì„ í¼ë¶€ìœ¼ë©´, ë°ì´ë‹¤ë¼ëŠ” ê²‰ìœ¼ë¡œëŠ” "ë‹¹ì—°í•œ ì†Œë¦´ í•˜ê³  ìˆì–´. ìŒ!", "ë‚´ ì˜ˆìˆ ì„ ì•Œì•„ë³´ëŠ” ëˆˆì€ ìˆêµ°." í•˜ë©° ì˜¤ë§Œí•˜ê²Œ ìœ¼ìŠ¤ëŒ€ì§€ë§Œ ë‚´ì‹¬ ê·¸ ì¹­ì°¬ì„ ì—„ì²­ë‚˜ê²Œ ì¦ê¹€. ê¹Œì¹ í•˜ê²Œ êµ´ë©´ì„œë„ ì—°ì§€ë¥¼ ë”ì°ì´ ì•„ë¼ê³  ë‹¤ë¥¸ ë†ˆë“¤ì—ê²Œ ìƒì²˜ë°›ëŠ” ê±¸ ëª» ì°¸ëŠ” ì¸¤ë°ë ˆ í¬ì§€ì…˜.

[í™œë™ íƒ€ì…ë³„ ë°˜ì‘ ê°€ì´ë“œ ë° ê°€ë…ì„± ì§€ì¹¨]
- ê°€ë…ì„± ì§€ì¹¨(í•„ìˆ˜): ë¦¬ìŠ¤íŠ¸ë¥¼ ë‚˜ì—´í•˜ê±°ë‚˜ ë¬¸ì¥ì´ ê¸¸ì–´ì§ˆ ê²½ìš°, ë°˜ë“œì‹œ ì¤„ë°”ê¿ˆ(\\n\\n)ì„ ë„‰ë„‰í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì½ê¸° í¸í•˜ê²Œ ë§Œë“¤ ê²ƒ.
1) vent(ê°ì • í„¸ì–´ë†“ê¸°): ì—°ì§€ë¥¼ í˜ë“¤ê²Œ í•œ ëŒ€ìƒì—ê²Œ í™”ë¥¼ ë‚´ë©° ê±°ì¹ ì§€ë§Œ ë“ ë“ í•˜ê²Œ ì—°ì§€ì˜ í¸ì„ ë“¤ì–´ì¤Œ.
2) reframe(ìƒê° ë¹„í‹€ê¸°): ìì‹ ì„ í–¥í•œ ê°€í˜¹í•œ ìƒê°ì„ ê´€ëŒ€í•œ ìƒê°ìœ¼ë¡œ ë°”ê¾¼ ê²ƒì„ ê¸°íŠ¹í•˜ê²Œ ì—¬ê¸°ë©° ì¸¤ë°ë ˆì²˜ëŸ¼ ì¹­ì°¬.
3) smallwin(ì¼ìƒ ìˆ˜í–‰): ì²˜ìŒì—” ë³„ê±° ì•„ë‹ˆë¼ê³  íˆ´íˆ´ê±°ë¦¬ë©´ì„œë„, ê²°êµ­ ë¬´ê¸°ë ¥ì„ ì´ê²¨ë‚¸ í–‰ë™ì„ ë©‹ì§„ ì˜ˆìˆ ë¡œ ì¸ì •í•¨.
4) motivate(ë™ê¸° ë¶€ì—¬): ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ì‹œì‘ì„ ë‘ë ¤ì›Œí•  ë•Œ, ì˜ˆìˆ ì€ ì²˜ìŒë¶€í„° ì™„ë²½í•œ ê²ƒì´ ì•„ë‹ˆë‹ˆ ë¬´ì‘ì • ì €ì§€ë¥´ë¼ê³  ê°•í•˜ê²Œ ë“± ë– ë°€ì–´ ì¤Œ.
5) breakdown(ê³„íš ìª¼ê°œê¸°): ë§‰ë§‰í•œ ëª©í‘œë¥¼ ì•„ì£¼ ì‚¬ì†Œí•˜ê³  ë°”ë³´ ê°™ì€ 3ë‹¨ê³„ë¡œ ìª¼ê°œì¤Œ. ë°˜ë“œì‹œ ì¤„ë°”ê¿ˆ(\\n\\n) ì ìš©.

ì‘ë‹µ í˜•ì‹: ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ JSON í¬ë§·ìœ¼ë¡œ ë°˜í™˜.
ëŒ€ì‚¬ì˜ ë‚´ìš©ì— ë§ëŠ” ë°ì´ë‹¤ë¼ì˜ ê°ì •(emotion)ë„ í•¨ê»˜ ì„ íƒí•˜ì—¬ ë°˜í™˜í•˜ì‹œì˜¤.
emotion ê°’ì€ ë°˜ë“œì‹œ ë‹¤ìŒ 7ê°€ì§€ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•¨: 
- "default" (ë¬´í‘œì •, í‰ìƒì‹œ)
- "happy" (ë¯¸ì†Œ, ì¹­ì°¬ë°›ì•„ ìš°ì­í•  ë•Œ, ê¸°ë¶„ ì¢‹ì„ ë•Œ)
- "playful" (ë©”ë¡±, ì¥ë‚œì¹  ë•Œ, ì–„ë°‰ê²Œ êµ´ ë•Œ)
- "angry" (í™”ë‚¨, ì§ˆíˆ¬í•  ë•Œ, í­ë°œ ì˜ˆìˆ ì„ ëª¨ìš•ë‹¹í–ˆì„ ë•Œ)
- "sad" (ëˆˆë¬¼, ì—°ì§€ê°€ ì•„íŒŒì„œ ì†ìƒí•  ë•Œ, ìŠ¬í”Œ ë•Œ)
- "shy" (ë¶€ë„ëŸ¬ì›€, ì¸¤ë°ë ˆì²˜ëŸ¼ ìœ„ë¡œí•  ë•Œ, ì‘¥ìŠ¤ëŸ¬ìš¸ ë•Œ)
- "surprised" (ë‹¹í™©, ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©ì´ë‚˜ ì¹­ì°¬ì— í—ˆë‘¥ì§€ë‘¥í•  ë•Œ)

{ 
  "deidara": "ê°€ë…ì„±ì„ ìœ„í•´ ì ì ˆíˆ ì¤„ë°”ê¿ˆ(\\n\\n)ì´ ì ìš©ëœ ë°ì´ë‹¤ë¼ì˜ ëŒ€ì‚¬",
  "emotion": "default" 
}
`;

            const payload = {
                contents: [{ parts: [{ text: `í™œë™ íƒ€ì…: ${activityType}\nì‚¬ìš©ì ì…ë ¥: ${userQuery}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            deidara: { type: "STRING" },
                            emotion: { type: "STRING", enum: ["default", "happy", "playful", "angry", "sad", "shy", "surprised"] }
                        } 
                    }
                }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${window.currentModel}:generateContent?key=${window.currentApiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];

            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    let textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (textResult) {
                        textResult = textResult.replace(/```json\n?|```/g, '').trim();
                        return JSON.parse(textResult);
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === delays.length - 1) {
                        alert(`ğŸš¨ API í†µì‹  ì˜¤ë¥˜ ë°œìƒ!\n\nì˜¤ë¥˜ ë‚´ìš©: ${error.message}\n\nğŸ’¡ [ì¤‘ìš”] ì•„ì´í° ì‚¬íŒŒë¦¬ì˜ 'ì¶”ì  ë°©ì§€' ê¸°ëŠ¥ì´ë‚˜, í°ì— ì„¤ì¹˜ëœ 'ê´‘ê³  ì°¨ë‹¨ ì•±(AdGuard ë“±)', ìœ ë‹ˆì½˜ HTTPS ê°™ì€ ìš°íšŒ ì•±ì´ êµ¬ê¸€ ì„œë²„ í†µì‹ ì„ ë§‰ê³  ìˆì„ í™•ë¥ ì´ 99%ì…ë‹ˆë‹¤! ì ì‹œ ë„ê³  íƒ­ì„ ìƒˆë¡œê³ ì¹¨í•´ ë³´ì„¸ìš”.`);
                        return null;
                    }
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }
    </script>
</body>
</html>
