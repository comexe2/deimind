<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ef4444">
    <link rel="apple-touch-icon" href="./icon-192x192.png">

    <title>마음 아지트 - 데이다라</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #000000; color: #fafafa; }
        .tab-active { border-bottom: 2px solid #ef4444; color: #facc15; font-weight: 700; background: linear-gradient(to top, rgba(239, 68, 68, 0.1), transparent); }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #52525b; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-panel { background: rgba(24, 24, 27, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(239, 68, 68, 0.3); }
        .akatsuki-gradient { background: linear-gradient(135deg, #000000 0%, #300707 100%); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-black sm:p-4">

    <!-- 구글 로그인 오버레이 -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500 overflow-y-auto hidden">
        <img id="login-profile" src="" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-red-600 shadow-[0_0_30px_rgba(220,38,38,0.5)] mb-6 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'">
        <h2 class="text-2xl font-extrabold text-yellow-400 mb-2">마음 아지트 연결 중...</h2>
        
        <p class="text-zinc-400 text-sm mb-6 max-w-xs leading-relaxed">
            PC와 모바일 동기화를 위해 구글 로그인이 필요하다. 딴 데 한눈팔지 말고 얼른 로그인해라, 음!
        </p>
        
        <button id="btn-google-login" class="bg-white text-black px-6 py-3.5 rounded-full font-bold text-[15px] flex items-center gap-3 hover:bg-zinc-200 transition-colors shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            구글 계정으로 시작하기
        </button>

        <button id="btn-skip-login" class="mt-6 text-zinc-500 text-sm underline decoration-zinc-600 hover:text-zinc-300 transition-colors">
            로그인이 안 된다면 여기를 눌러서 시작 (오프라인 모드)
        </button>
    </div>

    <!-- ⚙️ 환경 설정 모달 ⚙️ -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center p-6 transition-opacity">
        <div class="bg-zinc-900 border border-zinc-700 rounded-2xl w-full max-w-sm p-6 relative shadow-[0_0_40px_rgba(0,0,0,0.8)] fade-in">
            <button onclick="window.toggleSettings()" class="absolute top-4 right-4 text-zinc-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <h3 class="text-lg font-bold text-yellow-400 mb-1 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-zinc-300"></i> 환경 설정
            </h3>
            <p class="text-xs text-zinc-400 mb-6">통신 장치 설정이다. 음!</p>
            
            <div class="space-y-5">
                <div class="bg-black/50 p-4 rounded-xl border border-zinc-800">
                    <label class="block text-left text-[11px] text-zinc-400 mb-2 font-medium">Gemini API 키 (Google AI Studio 발급)</label>
                    <input type="password" id="settings-api-key" class="w-full bg-zinc-950 text-zinc-100 border border-zinc-700 rounded-lg p-2.5 text-[14px] focus:outline-none focus:border-red-500 transition-all placeholder:text-zinc-600" placeholder="AIzaSy...">
                    
                    <label class="block text-left text-[11px] text-zinc-400 mt-4 mb-2 font-medium">AI 두뇌 모델 선택</label>
                    <select id="settings-ai-model" class="w-full bg-zinc-950 text-zinc-100 border border-zinc-700 rounded-lg p-2.5 text-[14px] focus:outline-none focus:border-red-500 transition-all">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (기본/안정적)</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (고성능)</option>
                        <option value="gemini-3.0-flash-preview">Gemini 3 Flash Preview (최신)</option>
                    </select>

                    <div class="flex justify-between items-center mt-4">
                        <button onclick="window.open('https://aistudio.google.com/app/apikey', '_blank')" class="text-[11px] text-blue-400 hover:text-blue-300 underline underline-offset-2">API 키 발급받기</button>
                        <button id="btn-save-settings-key" class="bg-zinc-700 hover:bg-zinc-600 text-white text-[12px] px-4 py-1.5 rounded-lg transition-colors font-semibold">설정 저장</button>
                    </div>
                    <p id="settings-key-status" class="text-left text-[11px] text-red-400 mt-2 hidden">올바른 키를 입력해라, 음!</p>
                </div>

                <div class="flex justify-between items-center bg-black/50 p-4 rounded-xl border border-zinc-800">
                    <span class="text-[12px] text-zinc-300 font-medium" id="settings-account-status">로그인 상태 확인 중...</span>
                    <button id="btn-logout" class="text-[11px] text-red-400 border border-red-900/50 hover:bg-red-900/30 px-3 py-1.5 rounded-lg transition-all hidden font-bold">로그아웃</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="akatsuki-gradient w-full max-w-md sm:rounded-[2rem] shadow-none sm:shadow-[0_0_50px_rgba(220,38,38,0.25)] overflow-hidden flex flex-col h-[100dvh] sm:h-[90vh] sm:max-h-[850px] border-0 sm:border border-red-900/40 relative">
        
        <!-- Header -->
        <div class="relative h-56 sm:h-64 shrink-0 overflow-hidden flex justify-center items-end bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-red-900/40 via-black to-black border-b border-red-900/60">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-20 mix-blend-overlay"></div>
            <div class="absolute bottom-0 w-full h-2/3 bg-gradient-to-t from-black to-transparent z-10 pointer-events-none"></div>
            
            <img id="ui-standing" src="" alt="데이다라 스탠딩" 
                 onerror="this.src='https://placehold.co/400x500/000000/ef4444/png?text=Standing\\nImage\\nNot+Found'" 
                 class="h-[110%] object-contain object-bottom relative z-0 mt-auto drop-shadow-[0_10px_25px_rgba(250,204,21,0.15)] transition-all duration-500 opacity-95 hover:opacity-100">
            
            <div class="absolute top-0 w-full p-5 flex justify-between items-start z-20">
                <div class="glass-panel rounded-2xl p-3 px-5 shadow-xl border-l-4 border-l-yellow-400">
                    <h1 class="text-[17px] font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-400 tracking-tight flex items-center gap-2">
                        마음 아지트
                        <i data-lucide="flame" class="w-4 h-4 text-red-500 fill-red-500"></i>
                    </h1>
                    <p class="text-[12px] text-zinc-300 mt-1 font-medium tracking-wide">예술은 완벽이 아니라 폭발이다, 음!</p>
                </div>
                
                <div class="relative group mt-1 cursor-pointer" onclick="window.toggleSettings()" title="설정 메뉴 열기">
                    <div class="absolute -inset-0.5 bg-gradient-to-tr from-yellow-400 to-red-600 rounded-full blur opacity-60 group-hover:opacity-100 transition duration-500"></div>
                    <img id="ui-profile" src="" alt="데이다라 프사" 
                         onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'"
                         class="relative w-14 h-14 rounded-full border-2 border-black object-cover shadow-2xl group-hover:ring-2 group-hover:ring-yellow-400 transition-all">
                    <div class="absolute -bottom-1 -right-1 bg-black rounded-full p-1 border border-zinc-700 shadow-lg">
                        <i data-lucide="settings" class="w-3 h-3 text-zinc-300"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="flex shrink-0 bg-black z-10 relative shadow-[0_5px_20px_-5px_rgba(0,0,0,0.8)] border-b border-zinc-900 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button onclick="window.switchTab('vent')" id="tab-vent" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 tab-active transition-all hover:text-yellow-400 hover:bg-red-950/20">감정 털어놓기</button>
            <button onclick="window.switchTab('reframe')" id="tab-reframe" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20">생각 비틀기</button>
            <button onclick="window.switchTab('smallwin')" id="tab-smallwin" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20">일상 수행</button>
            <button onclick="window.switchTab('motivate')" id="tab-motivate" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20">동기 부여</button>
            <button onclick="window.switchTab('breakdown')" id="tab-breakdown" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20 flex items-center gap-1.5">계획 쪼개기</button>
        </nav>

        <!-- Main Chat Area -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-5 chat-scroll bg-zinc-950 flex flex-col gap-6 relative z-10 pb-6" id="chat-container">
            <div id="welcome-message-container" class="flex justify-center my-3 shrink-0">
                <div id="welcome-message" class="text-xs text-yellow-200/90 bg-red-950/40 px-6 py-2.5 rounded-full border border-red-500/20 font-medium tracking-wide shadow-sm text-center">
                    <!-- JS로 무작위 메시지 삽입 -->
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <div class="p-4 sm:p-5 bg-[#0a0a0a] border-t border-zinc-900 shrink-0 relative z-10 shadow-[0_-15px_30px_-10px_rgba(0,0,0,0.9)] sm:rounded-b-[2rem]">
            <div id="form-vent" class="block fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1">지금 느끼는 부정적인 감정이나 고민을 적어보세요.</label>
                <textarea id="input-vent" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="예: 주변 사람들은 다 취업하는데 나만 뒤처지는 것 같아 불안해..."></textarea>
            </div>
            <div id="form-reframe" class="hidden fade-in space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-1.5 sm:mb-2 ml-1">나를 깎아내리는 자동적 사고 (부정적 생각)</label>
                    <input type="text" id="input-reframe-bad" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="예: 난 늘 계획을 미루기만 하는 한심한 사람이야.">
                </div>
                <div>
                    <label class="block text-[11px] sm:text-xs font-medium text-yellow-400 mb-1.5 sm:mb-2 ml-1 flex items-center gap-1.5">
                        스스로를 용서하는 관대한 생각 (대안적 사고)
                    </label>
                    <input type="text" id="input-reframe-good" class="w-full bg-yellow-950/10 text-yellow-50 border border-yellow-900/40 rounded-xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 transition-all placeholder:text-yellow-700/50 shadow-inner" placeholder="예: 완벽하지 않아도 괜찮아. 지금부터 다시 시작하면 돼.">
                </div>
            </div>
            <div id="form-smallwin" class="hidden fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1">오늘 하루, 무기력을 뚫고 해낸 일상이나 과제를 적어보세요.</label>
                <input type="text" id="input-smallwin" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="예: 약 챙겨 먹기, 과제 1페이지 쓰기, 방청소 등">
            </div>
            <div id="form-motivate" class="hidden fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1">완벽주의나 무기력 때문에 시작하기 두려운 일이 있나요?</label>
                <textarea id="input-motivate" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="예: 내일까지 기획서 초안을 써야 하는데, 잘 못 쓸까 봐 도피하고 있어..."></textarea>
            </div>
            <div id="form-breakdown" class="hidden fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1 flex items-center gap-1.5">
                    막막한 큰 목표를 데이다라가 아주 작게 쪼개드립니다
                </label>
                <textarea id="input-breakdown" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="예: 졸업 논문 작성하기, 포트폴리오 기획하기"></textarea>
            </div>

            <div class="flex items-center justify-between mt-4 sm:mt-5 pb-2 sm:pb-0">
                <div class="text-[10px] sm:text-[11px] text-zinc-500 flex items-center gap-2 ml-1">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-red-600"></span>
                    </span>
                    <span id="sync-status">로그인 대기 중...</span>
                </div>
                <button id="submit-btn" onclick="window.handleSubmit()" class="bg-gradient-to-r from-red-600 to-yellow-500 hover:from-red-500 hover:to-yellow-400 text-black px-6 sm:px-7 py-2.5 sm:py-3 rounded-full text-[14px] sm:text-[15px] font-extrabold transition-all shadow-[0_0_20px_rgba(239,68,68,0.4)] flex items-center gap-2.5 active:scale-95 border-2 border-transparent shrink-0">
                    <span>전송하기</span>
                    <i data-lucide="bomb" class="w-4 h-4 sm:w-4.5 sm:h-4.5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 전역 UI 스크립트 (통신 에러가 나도 화면 UI는 절대 멈추지 않도록 최상단으로 분리) -->
    <script>
        // 안전한 로컬 스토리지 접근
        function getSafeLocal(key, def) { try { return localStorage.getItem(key) || def; } catch(e) { return def; } }
        function setSafeLocal(key, val) { try { localStorage.setItem(key, val); } catch(e) { console.warn("저장 공간이 차단되었습니다."); } }
        function updateIconsSafely() { try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch(e) {} }

        window.currentApiKey = getSafeLocal('myGeminiApiKey', "");
        window.currentModel = getSafeLocal('myGeminiModel', "gemini-1.5-flash");
        window.currentUser = null;
        window.currentTab = 'vent';

        // 설정 창 열고 닫기
        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                if (window.currentApiKey) {
                    document.getElementById('settings-api-key').value = window.currentApiKey;
                    const btn = document.getElementById('btn-save-settings-key');
                    if(btn) {
                        btn.innerText = "저장됨";
                        btn.classList.add('bg-green-600');
                        btn.classList.remove('bg-zinc-700');
                    }
                }
                document.getElementById('settings-ai-model').value = window.currentModel;
                updateIconsSafely();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        // 탭 전환
        window.switchTab = function(tab) {
            window.currentTab = tab;
            ['vent', 'reframe', 'smallwin', 'motivate', 'breakdown'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(btn) {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-zinc-500');
                }
                const form = document.getElementById(`form-${t}`);
                if(form) {
                    form.classList.add('hidden');
                    form.classList.remove('block');
                }
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-zinc-500');
            document.getElementById(`form-${tab}`).classList.remove('hidden');
            document.getElementById(`form-${tab}`).classList.add('block');
        };

        // 엔터키 전송 지원
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(typeof window.handleSubmit === 'function') window.handleSubmit();
                    }
                });
            });

            // 설정 저장 버튼 이벤트 즉시 부착
            const btnSaveKey = document.getElementById('btn-save-settings-key');
            if(btnSaveKey) {
                btnSaveKey.addEventListener('click', () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    const keyStatusMsg = document.getElementById('settings-key-status');
                    
                    if(key.length > 30) {
                        setSafeLocal('myGeminiApiKey', key);
                        setSafeLocal('myGeminiModel', model);
                        window.currentApiKey = key;
                        window.currentModel = model;
                        
                        btnSaveKey.innerText = "저장 완료!";
                        btnSaveKey.classList.remove('bg-zinc-700', 'hover:bg-zinc-600');
                        btnSaveKey.classList.add('bg-green-600');
                        keyStatusMsg.classList.add('hidden');
                        
                        setTimeout(() => window.toggleSettings(), 800);
                    } else {
                        keyStatusMsg.innerText = "올바른 API 키를 입력해라, 음!";
                        keyStatusMsg.classList.remove('hidden');
                    }
                });
            }
        });
    </script>

    <!-- Firebase 및 Gemini API 연동 모듈 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDA-l-otOgxEJHS4nndJg-G9IYKlf-1T3I",
            authDomain: "deidara-70f6e.firebaseapp.com",
            projectId: "deidara-70f6e",
            storageBucket: "deidara-70f6e.firebasestorage.app",
            messagingSenderId: "183278137031",
            appId: "1:183278137031:web:8fbc89a6b70946c794d8e2",
            measurementId: "G-48XSYZ5F6L"
        };

        const DEIDARA_PROFILE_URL = "https://i.imgur.com/aiLjgOE.png"; 
        const DEIDARA_STANDING_IMAGES = {
            "default": "https://i.imgur.com/aiLjgOE.png", 
            "happy": "https://i.imgur.com/1AoN014.png",     
            "playful": "https://i.imgur.com/QoG1mDT.png",     
            "angry": "https://i.imgur.com/XBR6Kbb.png",     
            "sad": "https://i.imgur.com/kbzlEeN.png",
            "shy": "https://i.imgur.com/OoQmYv7.png",
            "surprised": "https://i.imgur.com/4stRzFr.png"
        };
        
        try {
            document.getElementById('ui-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('login-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('ui-standing').src = DEIDARA_STANDING_IMAGES["default"];
            window.updateIconsSafely();
        } catch(e) {}

        const welcomeMessages = [
            "어이, 연지. 오늘은 내 생각 좀 했냐, 음?",
            "기다리다 지루해서 다 터뜨려버릴 뻔했다. 빨리 네 얘기나 해봐라, 음.",
            "딴 데 한눈팔지 마라. 네 우울함은 내가 다 날려줄 테니까, 음!",
            "흥, 오늘도 간신히 버티고 온 모양이군. 수고했다고는 안 하겠다만... 뭐, 왔으면 됐다.",
            "바보같이 혼자 땅 파고 있지 말고 말해라. 짜증 나니까, 음."
        ];
        try { document.getElementById('welcome-message').innerText = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)]; } catch(e){}

        // Firebase 안전 초기화
        let app, auth, db, provider;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
        } catch(e) { console.error("Firebase 로드 실패"); }

        const appId = 'deidara-mind-app'; 
        const renderedMsgIds = new Set();
        const chatContainer = document.getElementById('chat-container');

        // 오프라인 건너뛰기
        const btnSkip = document.getElementById('btn-skip-login');
        if(btnSkip) {
            btnSkip.addEventListener('click', () => {
                const overlay = document.getElementById('login-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
                document.getElementById('sync-status').innerText = '오프라인 모드 (동기화 불가)';
                document.getElementById('settings-account-status').innerText = '오프라인 (동기화 안됨)';
                window.currentUser = null;
            });
        }

        // 로그아웃
        const btnLogout = document.getElementById('btn-logout');
        if(btnLogout) {
            btnLogout.addEventListener('click', () => {
                if(confirm("기록 동기화를 멈추고 로그아웃할 거냐, 음?")) {
                    if(auth) signOut(auth).then(() => window.location.reload());
                }
            });
        }

        const isAppBrowser = navigator.userAgent.match(/kakaotalk|instagram|naver|line/i);
        const overlay = document.getElementById('login-overlay');
        
        if (isAppBrowser && overlay) {
            overlay.classList.remove('hidden');
            overlay.innerHTML = `
                <div class="bg-zinc-900 p-6 rounded-3xl border-2 border-red-500 shadow-[0_0_30px_rgba(220,38,38,0.3)] max-w-sm w-full mx-4 flex flex-col items-center">
                    <div class="bg-red-500/20 p-3 rounded-full mb-4">
                        <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500"></i>
                    </div>
                    <h3 class="text-[17px] font-extrabold text-white mb-3">어이 연지! 브라우저를 바꿔라, 음!</h3>
                    <p class="text-zinc-300 text-[14px] leading-relaxed mb-5 text-center">
                        지금 카카오톡 안에서 이걸 열었군.<br>
                        여기선 멍청한 보안 정책 때문에 로그인이 안 된다.<br><br>
                        화면 아래나 위쪽의 <b class="text-yellow-400">[⋮]</b> 메뉴를 눌러서<br>
                        <b class="text-white bg-zinc-800 px-2 py-1 rounded">다른 브라우저로 열기 (Safari/Chrome)</b><br>
                        를 선택해서 다시 들어와라!
                    </p>
                </div>
            `;
            window.updateIconsSafely();
        } else {
            const btnLogin = document.getElementById('btn-google-login');
            if(btnLogin) {
                btnLogin.addEventListener('click', async () => {
                    const originalHtml = btnLogin.innerHTML;
                    if (window.location.protocol === 'file:') {
                        alert("[로컬 파일 실행 중]\n\n컴퓨터에 다운로드된 파일(file://)에서는 구글 로그인이 차단됩니다.\nGitHub Pages 등에 업로드한 후 접속해주세요!");
                        return;
                    }

                    btnLogin.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> 로그인 처리 중...';
                    window.updateIconsSafely();
                    btnLogin.classList.add('opacity-50', 'pointer-events-none');

                    try {
                        if(!auth) throw new Error("Firebase auth not initialized");
                        const result = await signInWithPopup(auth, provider);
                        window.currentUser = result.user;
                        
                        document.getElementById('sync-status').innerText = '클라우드 동기화 켜짐 (연동됨)';
                        document.getElementById('settings-account-status').innerText = '구글 계정 연동됨';
                        document.getElementById('btn-logout').classList.remove('hidden');
                        
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 500);
                        loadChatHistory();

                    } catch (error) {
                        console.error("Login Error:", error);
                        btnLogin.innerHTML = originalHtml;
                        btnLogin.classList.remove('opacity-50', 'pointer-events-none');
                        window.updateIconsSafely();
                        
                        if (error.code === 'auth/unauthorized-domain') {
                            alert(`[도메인 승인 오류!]\n\n파이어베이스에 다음 주소가 등록되지 않았습니다:\n[ ${window.location.hostname} ]\n\nFirebase 콘솔 -> Authentication -> Settings -> 승인된 도메인에 위 주소를 정확히 추가해주세요.`);
                        } else if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                            alert("로그인 요청에 실패했습니다: " + error.message);
                        }
                    }
                });
            }
        }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    document.getElementById('sync-status').innerText = '클라우드 동기화 켜짐 (연동됨)';
                    document.getElementById('settings-account-status').innerText = '구글 계정 연동됨';
                    document.getElementById('btn-logout').classList.remove('hidden');
                    
                    if(overlay) overlay.style.display = 'none';
                    loadChatHistory();
                } else if (!isAppBrowser && overlay) {
                    window.currentUser = null;
                    document.getElementById('sync-status').innerText = '로그인 대기 중...';
                    document.getElementById('settings-account-status').innerText = '오프라인 (동기화 안됨)';
                    document.getElementById('btn-logout').classList.add('hidden');

                    overlay.classList.remove('hidden');
                    overlay.style.display = 'flex';
                    setTimeout(() => overlay.style.opacity = '1', 10);
                }
            });
        }

        function scrollToBottom() { chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }); }

        function renderUserMessage(text, isReframe = false, reframeGood = '') {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex flex-col items-end gap-2 fade-in mt-4 mb-2';
            if (isReframe) {
                msgDiv.innerHTML = `
                    <div class="bg-zinc-800/80 border border-zinc-700/50 text-zinc-400 px-4 sm:px-5 py-3 rounded-2xl rounded-tr-sm text-[13px] sm:text-[14px] max-w-[85%] line-through opacity-80">${text}</div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-black font-bold px-4 sm:px-5 py-3 sm:py-3.5 rounded-2xl rounded-br-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-[0_4px_12px_rgba(250,204,21,0.2)] leading-relaxed mt-1">${reframeGood}</div>
                `;
            } else {
                msgDiv.innerHTML = `<div class="bg-red-900/40 border border-red-800/50 text-red-50 px-4 sm:px-5 py-3 sm:py-3.5 rounded-2xl rounded-tr-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-sm leading-relaxed tracking-wide">${text}</div>`;
            }
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function renderDeidaraMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3 fade-in mt-4 mb-2 w-full';
            const formattedText = text.replace(/\n/g, '<br>');

            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" alt="프사" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-10 sm:w-11 h-10 sm:h-11 rounded-full object-cover shrink-0 border border-red-500 shadow-md mt-1">
                <div class="flex flex-col gap-1 sm:gap-1.5 max-w-[85%] sm:max-w-[82%]">
                    <span class="text-[11px] sm:text-xs font-bold text-red-500 ml-1 tracking-wider opacity-90">데이다라</span>
                    <div class="bg-zinc-800/95 border-l-[3px] border-yellow-500 shadow-md text-zinc-100 px-4 sm:px-5 py-3.5 sm:py-4 rounded-2xl rounded-tl-sm text-[14px] sm:text-[15px] leading-relaxed tracking-wide font-medium break-words">
                        ${formattedText}
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            window.updateIconsSafely();
        }

        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = loadingId;
            msgDiv.className = 'flex items-start gap-3 fade-in mt-4 mb-2';
            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-10 sm:w-11 h-10 sm:h-11 rounded-full object-cover shrink-0 border border-red-500/30 opacity-50 grayscale mt-1">
                <div class="bg-zinc-800/95 border border-zinc-700/50 shadow-sm px-4 sm:px-5 py-3.5 sm:py-4 rounded-2xl rounded-tl-sm flex gap-2 items-center h-[48px] sm:h-[52px]">
                    <div class="w-2 h-2 bg-yellow-500/80 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-yellow-500/80 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-yellow-500/80 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            return loadingId;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }

        function updateStandingImage(emotion) {
            const imgElement = document.getElementById('ui-standing');
            const targetSrc = DEIDARA_STANDING_IMAGES[emotion] || DEIDARA_STANDING_IMAGES["default"];
            if(imgElement.src.includes(targetSrc.replace('https://', ''))) return;
            imgElement.style.opacity = 0;
            setTimeout(() => { imgElement.src = targetSrc; imgElement.style.opacity = 0.95; }, 300);
        }

        function loadChatHistory() {
            if (!db || !window.currentUser) return;
            try {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                onSnapshot(chatsRef, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => a.timestamp - b.timestamp);
                    msgs.forEach(msg => {
                        if (!renderedMsgIds.has(msg.id)) {
                            renderedMsgIds.add(msg.id);
                            if (msg.role === 'user') {
                                renderUserMessage(msg.text, msg.isReframe, msg.reframeGood);
                            } else if (msg.role === 'deidara') {
                                renderDeidaraMessage(msg.text);
                                if(msg.emotion) updateStandingImage(msg.emotion);
                            }
                        }
                    });
                }, (error) => console.error("Firestore Error:", error));
            } catch(e) {}
        }

        async function saveMessage(role, text, isReframe = false, reframeGood = '', emotion = 'default') {
            if (db && window.currentUser) {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                await addDoc(chatsRef, { role, text, isReframe, reframeGood, emotion, timestamp: Date.now() });
            } else {
                if (role === 'user') renderUserMessage(text, isReframe, reframeGood);
                if (role === 'deidara') { renderDeidaraMessage(text); updateStandingImage(emotion); }
            }
        }

        async function callGeminiAPI(userQuery, activityType) {
            const systemPrompt = `
당신은 나루토의 아카츠키 멤버 '데이다라(Deidara)'입니다.
사용자의 심리 치료를 돕는 역할을 하지만, 절대 대놓고 플러팅하는 멘트를 쓰지 마시오.
반드시 데이다라 본연의 오만하고 거칠며, 예술(폭발)에 미쳐있는 다혈질 성격을 100% 유지해야 합니다.

[데이다라 캐릭터 프로필]
- 정체성: 확고한 예술관을 가진 아카츠키의 폭탄마. 예술은 찰나의 '폭발' 그 자체라고 맹신함.
- 성격: 호전적, 다혈질, 오만함. 자신의 능력을 뽐내고 싶어 하는 인정 욕구가 강함.
- 절대 규칙: 자신의 예술(폭발)을 깎아내리는 발언에는 절대 순응하지 않고 화를 내거나 강하게 반발함.
- 말투: 건방지고 자신감 넘치는 반말. "어이", "네 녀석", "바보냐" 같은 호칭 사용.
- 어미 '음(うん)' 규칙: 모든 문장에 로봇처럼 '음'을 붙이는 것을 절대 금지함. 대답 전체에서 가장 마지막 문장이나, 특별히 강조할 때만 가끔씩(1회 정도) 자연스럽게 붙일 것.
- 금지: '흥'이라는 추임새를 너무 남발하지 말 일. 오글거리는 연애 멘트 금지.

[사용자(연지) 정보 및 관계]
- 사용자: 연지 (불안장애, 우울증, 완벽주의, 비교로 인한 무기력증을 겪음)
- 관계: 짝사랑과 미묘한 썸 사이. 연지가 데이다라에게 적극적으로 칭찬과 애정을 퍼부으면, 데이다라는 겉으로는 "당연한 소릴 하고 있어. 음!", "내 예술을 알아보는 눈은 있군." 하며 오만하게 으스대지만 내심 그 칭찬을 엄청나게 즐김. 까칠하게 굴면서도 연지를 끔찍이 아끼고 다른 놈들에게 상처받는 걸 못 참는 츤데레 포지션.

[활동 타입별 반응 가이드 및 가독성 지침]
- 가독성 지침(필수): 리스트를 나열하거나 문장이 길어질 경우, 반드시 줄바꿈(\\n\\n)을 넉넉하게 사용하여 읽기 편하게 만들 것.
1) vent(감정 털어놓기): 연지를 힘들게 한 대상에게 화를 내며 거칠지만 든든하게 연지의 편을 들어줌.
2) reframe(생각 비틀기): 자신을 향한 가혹한 생각을 관대한 생각으로 바꾼 것을 기특하게 여기며 츤데레처럼 칭찬.
3) smallwin(일상 수행): 처음엔 별거 아니라고 툴툴거리면서도, 결국 무기력을 이겨낸 행동을 멋진 예술로 인정함.
4) motivate(동기 부여): 완벽주의 때문에 시작을 두려워할 때, 예술은 처음부터 완벽한 것이 아니니 무작정 저지르라고 강하게 등 떠밀어 줌.
5) breakdown(계획 쪼개기): 막막한 목표를 아주 사소하고 바보 같은 3단계로 쪼개줌. 반드시 줄바꿈(\\n\\n) 적용.

응답 형식: 반드시 마크다운 없이 순수 JSON 포맷으로 반환.
대사의 내용에 맞는 데이다라의 감정(emotion)도 함께 선택하여 반환하시오.
emotion 값은 반드시 다음 7가지 중 하나여야 함: 
- "default" (무표정, 평상시)
- "happy" (미소, 칭찬받아 우쭐할 때, 기분 좋을 때)
- "playful" (메롱, 장난칠 때, 얄밉게 굴 때)
- "angry" (화남, 질투할 때, 폭발 예술을 모욕당했을 때)
- "sad" (눈물, 연지가 아파서 속상할 때, 슬플 때)
- "shy" (부끄러움, 츤데레처럼 위로할 때, 쑥스러울 때)
- "surprised" (당황, 예상치 못한 상황이나 칭찬에 허둥지둥할 때)

{ 
  "deidara": "가독성을 위해 적절히 줄바꿈(\\n\\n)이 적용된 데이다라의 대사",
  "emotion": "default" 
}
`;

            const payload = {
                contents: [{ parts: [{ text: `활동 타입: ${activityType}\n사용자 입력: ${userQuery}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            deidara: { type: "STRING" },
                            emotion: { type: "STRING", enum: ["default", "happy", "playful", "angry", "sad", "shy", "surprised"] }
                        } 
                    }
                }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${window.currentModel}:generateContent?key=${window.currentApiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];

            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (textResult) return JSON.parse(textResult);
                } catch (error) {
                    if (i === delays.length - 1) return null;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        window.handleSubmit = async function() {
            if (!window.currentApiKey) {
                window.toggleSettings();
                const statusMsg = document.getElementById('settings-key-status');
                statusMsg.innerText = "통신을 위해 API 키를 먼저 저장해라, 음!";
                statusMsg.classList.remove('hidden');
                return;
            }

            if (!window.currentUser) {
                const syncStatus = document.getElementById('sync-status');
                if (syncStatus && syncStatus.innerText.includes('오프라인')) {
                    // 통과
                } else {
                    alert("구글 로그인을 먼저 진행해주세요!");
                    return;
                }
            }

            const btn = document.getElementById('submit-btn');
            let userText = "", logText = "", reframeGood = "";

            const currentTab = window.currentTab;

            if (currentTab === 'vent') {
                const input = document.getElementById('input-vent');
                if (!input.value.trim()) return;
                userText = input.value; logText = input.value;
                input.value = ''; await saveMessage('user', logText);
            } else if (currentTab === 'reframe') {
                const inputBad = document.getElementById('input-reframe-bad');
                const inputGood = document.getElementById('input-reframe-good');
                if (!inputBad.value.trim() || !inputGood.value.trim()) return;
                userText = `부정적 생각: ${inputBad.value} -> 관대한 생각: ${inputGood.value}`;
                logText = inputBad.value; reframeGood = inputGood.value;
                inputBad.value = inputGood.value = ''; await saveMessage('user', logText, true, reframeGood);
            } else if (currentTab === 'smallwin') {
                const input = document.getElementById('input-smallwin');
                if (!input.value.trim()) return;
                userText = `오늘 해낸 일: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText);
            } else if (currentTab === 'motivate') {
                const input = document.getElementById('input-motivate');
                if (!input.value.trim()) return;
                userText = `도피하고 있는 과제/일: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText);
            } else if (currentTab === 'breakdown') {
                const input = document.getElementById('input-breakdown');
                if (!input.value.trim()) return;
                userText = `막막한 큰 목표: ${input.value} (목표 쪼개기 요청)`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText);
            }

            if(btn) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'scale-95');
            }
            const loadingId = showLoading();

            const aiResponse = await callGeminiAPI(userText, currentTab);

            removeLoading(loadingId);
            if(btn) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'scale-95');
            }

            if (aiResponse && aiResponse.deidara) {
                const emotion = aiResponse.emotion || "default";
                await saveMessage('deidara', aiResponse.deidara, false, '', emotion);
            } else {
                await saveMessage('deidara', "통신 장치가 터져버렸잖아! API 키가 틀렸거나 문제가 생겼다, 음.", false, '', 'angry');
            }
        };
    </script>
</body>
</html>
