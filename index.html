<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ğŸš« ê²€ìƒ‰ ì—”ì§„ ë…¸ì¶œ ì°¨ë‹¨ (ë¹„ë°€ ì•„ì§€íŠ¸ ë³´í˜¸) ğŸš« -->
    <meta name="robots" content="noindex, nofollow">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#09090b">
    <link rel="apple-touch-icon" href="./icon-192x192.png">

    <title>ì•„ì§€íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #000000; color: #fafafa; }
        
        .tab-btn {
            padding: 0.5rem 1.1rem;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease-in-out;
            color: #71717a;
            border: 1px solid transparent;
            background-color: transparent;
        }
        .tab-btn:hover {
            color: #a1a1aa;
            background-color: rgba(39, 39, 42, 0.4);
        }
        .tab-active {
            background-color: rgba(127, 29, 29, 0.2) !important;
            color: #facc15 !important;
            border-color: rgba(185, 28, 28, 0.3) !important;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.1);
        }

        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .akatsuki-gradient { background: linear-gradient(135deg, #09090b 0%, #180505 100%); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-black sm:p-4">

    <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500 overflow-y-auto hidden">
        <img id="login-profile" src="" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-red-600 shadow-[0_0_30px_rgba(220,38,38,0.5)] mb-6 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'">
        <h2 class="text-2xl font-extrabold text-yellow-400 mb-2">ì•„ì§€íŠ¸ ì—°ê²° ì¤‘...</h2>
        
        <p class="text-zinc-400 text-sm mb-6 max-w-xs leading-relaxed">
            PCì™€ ëª¨ë°”ì¼ ë™ê¸°í™”ë¥¼ ìœ„í•´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•˜ë‹¤. ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ê³  ì–¼ë¥¸ ë¡œê·¸ì¸í•´ë¼, ìŒ!
        </p>
        
        <button id="btn-google-login" class="bg-white text-black px-6 py-3.5 rounded-full font-bold text-[15px] flex items-center gap-3 hover:bg-zinc-200 transition-colors shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
        </button>

        <button id="btn-skip-login" class="mt-6 text-zinc-500 text-sm underline decoration-zinc-600 hover:text-zinc-300 transition-colors">
            ë¡œê·¸ì¸ì´ ì•ˆ ëœë‹¤ë©´ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ì„œ ì‹œì‘ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
        </button>
    </div>

    <!-- âš™ï¸ í™˜ê²½ ì„¤ì • ëª¨ë‹¬ âš™ï¸ -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center p-6 transition-opacity">
        <div class="bg-zinc-900 border border-zinc-700 rounded-3xl w-full max-w-sm p-6 relative shadow-[0_0_50px_rgba(0,0,0,0.8)] fade-in">
            <button onclick="window.toggleSettings()" class="absolute top-4 right-4 text-zinc-400 hover:text-white transition-colors bg-zinc-800 rounded-full p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <h3 class="text-lg font-bold text-yellow-400 mb-1 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-zinc-300"></i> í™˜ê²½ ì„¤ì •
            </h3>
            <p class="text-xs text-zinc-400 mb-5">í†µì‹  ì¥ì¹˜ ë° ëŒ€í™” ì„¤ì •ì´ë‹¤. ìŒ!</p>
            
            <div class="space-y-4">
                <!-- API ë° ëª¨ë¸ ì„¤ì • -->
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800/80 shadow-inner">
                    <label class="block text-left text-[11px] text-zinc-400 mb-2 font-medium">Gemini API í‚¤ (Google AI Studio ë°œê¸‰)</label>
                    <input type="password" id="settings-api-key" class="w-full bg-zinc-900/80 text-zinc-100 border border-zinc-700/50 rounded-xl p-3 text-[14px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="AIzaSy...">
                    
                    <label class="block text-left text-[11px] text-zinc-400 mt-4 mb-2 font-medium">AI ë‘ë‡Œ ëª¨ë¸ ì„ íƒ</label>
                    <select id="settings-ai-model" class="w-full bg-zinc-900/80 text-zinc-100 border border-zinc-700/50 rounded-xl p-3 text-[14px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all shadow-inner appearance-none cursor-pointer">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (ê¸°ë³¸/ì•ˆì •ì )</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (ê³ ì„±ëŠ¥)</option>
                        <option value="gemini-3.0-flash">Gemini 3.0 Flash</option>
                    </select>

                    <div class="flex justify-between items-center mt-4">
                        <button onclick="window.open('https://aistudio.google.com/app/apikey', '_blank')" class="text-[11px] text-blue-400 hover:text-blue-300 underline underline-offset-4">API í‚¤ ë°œê¸‰ë°›ê¸°</button>
                        <div class="flex gap-2">
                            <button id="btn-test-api" class="bg-blue-600 hover:bg-blue-500 text-white text-[12px] px-3.5 py-1.5 rounded-xl transition-colors font-bold shadow-md">í†µì‹  í…ŒìŠ¤íŠ¸</button>
                            <button id="btn-save-settings-key" class="bg-zinc-700 hover:bg-zinc-600 text-white text-[12px] px-3.5 py-1.5 rounded-xl transition-colors font-bold shadow-md">ì„¤ì • ì €ì¥</button>
                        </div>
                    </div>
                    <p id="settings-key-status" class="text-left text-[11px] text-red-400 mt-3 hidden bg-red-950/30 p-2 rounded-lg border border-red-900/30">ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ì…ë ¥í•´ë¼, ìŒ!</p>
                </div>

                <!-- ğŸ†• ëŒ€í™” ê´€ë¦¬ (ì•± ë‚´ ë³´ê´€í•¨ ê¸°ëŠ¥ & ëª…ëŒ€ì‚¬ ì°œ) -->
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800/80 shadow-inner">
                    <label class="block text-left text-[11px] text-zinc-400 mb-2 font-medium">ëŒ€í™” ê´€ë¦¬</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button id="btn-archive-chat" class="bg-zinc-800 hover:bg-zinc-700 text-yellow-400 text-[12px] px-2 py-2.5 rounded-xl transition-colors border border-zinc-700 shadow-sm flex items-center justify-center gap-1.5 font-bold">
                            <i data-lucide="archive" class="w-3.5 h-3.5"></i> ëŒ€í™” ë³´ê´€í•˜ê¸°
                        </button>
                        <button onclick="window.openArchiveModal()" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 text-[12px] px-2 py-2.5 rounded-xl transition-colors border border-zinc-700 shadow-sm flex items-center justify-center gap-1.5 font-medium">
                            <i data-lucide="library" class="w-3.5 h-3.5"></i> ë³´ê´€í•¨ ë³´ê¸°
                        </button>
                    </div>
                    <!-- â¤ï¸ ë‚˜ì˜ ì˜ˆìˆ í’ˆ ë³´ê´€í•¨ ë²„íŠ¼ ì¶”ê°€ -->
                    <button onclick="window.openFavoritesModal()" class="w-full bg-pink-950/30 hover:bg-pink-900/40 text-pink-400 text-[12px] px-3 py-2.5 rounded-xl transition-colors border border-pink-900/30 shadow-sm flex items-center justify-center gap-1.5 font-bold mt-1">
                        <i data-lucide="heart" class="w-3.5 h-3.5 fill-pink-500/20"></i> ë‚˜ì˜ ì˜ˆìˆ í’ˆ (ì°œí•œ ëŒ€ì‚¬)
                    </button>

                    <button id="btn-clear-chat" class="w-full bg-red-950/40 hover:bg-red-900/60 text-red-400 text-[12px] px-3 py-2 rounded-xl transition-colors border border-red-900/50 shadow-sm flex items-center justify-center gap-1.5 font-medium mt-2">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> í˜„ì¬ ë°© ì˜êµ¬ ì‚­ì œ
                    </button>
                </div>

                <div class="flex justify-between items-center bg-black/40 p-4 rounded-2xl border border-zinc-800/80">
                    <span class="text-[12px] text-zinc-300 font-medium flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        <span id="settings-account-status">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</span>
                    </span>
                    <button id="btn-logout" class="text-[11px] text-red-400 bg-red-950/20 border border-red-900/40 hover:bg-red-900/40 px-3.5 py-1.5 rounded-xl transition-all hidden font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“¦ ë³´ê´€í•¨ ëª¨ë‹¬ (Archive Modal) -->
    <div id="archive-modal" class="fixed inset-0 z-[70] bg-black/90 backdrop-blur-md hidden flex-col items-center justify-center p-4 sm:p-6 transition-opacity">
        <div class="bg-zinc-950 border border-zinc-800 rounded-[2rem] w-full max-w-md h-[85vh] flex flex-col relative shadow-[0_0_50px_rgba(250,204,21,0.1)] fade-in">
            <header class="flex justify-between items-center p-5 border-b border-zinc-800/80 shrink-0">
                <h3 class="text-lg font-bold text-yellow-400 flex items-center gap-2">
                    <i data-lucide="library" class="w-5 h-5"></i> ë§ˆìŒ ë³´ê´€í•¨
                </h3>
                <button onclick="document.getElementById('archive-modal').classList.add('hidden'); document.getElementById('archive-modal').classList.remove('flex');" class="text-zinc-400 hover:text-white bg-zinc-900 rounded-full p-1.5 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </header>
            
            <div class="p-3 border-b border-zinc-800/50 shrink-0 flex items-center gap-2 bg-zinc-900/30">
                <label class="text-[12px] text-zinc-400 font-medium ml-1">ì£¼ì œ í•„í„°:</label>
                <select id="archive-tab-select" class="flex-1 bg-zinc-900 text-zinc-200 border border-zinc-700 rounded-lg px-3 py-1.5 text-[13px] focus:outline-none focus:border-yellow-500" onchange="window.renderArchive()">
                    <option value="all">ëª¨ë“  ëŒ€í™” ë³´ê¸°</option>
                    <option value="vent">ê°ì • í„¸ì–´ë†“ê¸°</option>
                    <option value="reframe">ìƒê° ë¹„í‹€ê¸°</option>
                    <option value="smallwin">ì¼ìƒ ìˆ˜í–‰</option>
                    <option value="motivate">ë™ê¸° ë¶€ì—¬</option>
                    <option value="breakdown">ê³„íš ìª¼ê°œê¸°</option>
                </select>
            </div>
            <div id="archive-container" class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-2 chat-scroll bg-zinc-950/50"></div>
        </div>
    </div>

    <!-- â¤ï¸ ë‚˜ì˜ ì˜ˆìˆ í’ˆ(ì°œ) ëª¨ë‹¬ -->
    <div id="favorites-modal" class="fixed inset-0 z-[70] bg-black/90 backdrop-blur-md hidden flex-col items-center justify-center p-4 sm:p-6 transition-opacity">
        <div class="bg-zinc-950 border border-pink-900/30 rounded-[2rem] w-full max-w-md h-[85vh] flex flex-col relative shadow-[0_0_50px_rgba(244,114,182,0.1)] fade-in">
            <header class="flex justify-between items-center p-5 border-b border-zinc-800/80 shrink-0">
                <h3 class="text-lg font-bold text-pink-400 flex items-center gap-2">
                    <i data-lucide="heart" class="w-5 h-5 fill-pink-500"></i> ë‚˜ì˜ ì˜ˆìˆ í’ˆ
                </h3>
                <button onclick="document.getElementById('favorites-modal').classList.add('hidden'); document.getElementById('favorites-modal').classList.remove('flex');" class="text-zinc-400 hover:text-white bg-zinc-900 rounded-full p-1.5 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </header>
            <div class="p-4 sm:p-5 text-sm text-zinc-400 border-b border-zinc-800/50 shrink-0 bg-zinc-900/30 font-medium">
                ì—°ì§€ ë‹˜ì—ê²Œ ìœ„ë¡œê°€ ë˜ì—ˆë˜ ë°ì´ë‹¤ë¼ì˜ ë‹¤ì •í•œ ë§ë“¤ì´ì—ìš”. ë¶ˆì•ˆí•  ë•Œë§ˆë‹¤ ì–¸ì œë“  êº¼ë‚´ ì½ì–´ë³´ì„¸ìš”.
            </div>
            <div id="favorites-container" class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-4 chat-scroll bg-zinc-950/50"></div>
        </div>
    </div>

    <!-- App Container (ë©”ì¸ UI) -->
    <div class="bg-zinc-950 w-full max-w-md sm:rounded-[2.5rem] shadow-none sm:shadow-[0_0_50px_rgba(220,38,38,0.15)] overflow-hidden flex flex-col h-[100dvh] sm:h-[90vh] sm:max-h-[850px] border-0 sm:border border-zinc-800 relative">
        
        <header class="flex items-center justify-between p-4 sm:p-5 bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900/80 z-30 shrink-0">
            <div class="flex items-center gap-3.5">
                <div class="relative group cursor-pointer shrink-0" onclick="window.toggleSettings()" title="ì„¤ì • ë©”ë‰´ ì—´ê¸°">
                    <div class="absolute -inset-0.5 bg-gradient-to-tr from-yellow-500 to-red-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-300"></div>
                    <img id="ui-profile" src="" alt="ë°ì´ë‹¤ë¼ í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="relative w-11 h-11 sm:w-12 sm:h-12 rounded-full border-[1.5px] border-zinc-900 object-cover shadow-lg">
                    <div class="absolute -bottom-1 -right-1 bg-zinc-800 rounded-full p-1 border border-zinc-700 shadow-md group-hover:bg-zinc-700 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3 text-zinc-300"></i>
                    </div>
                </div>
                <div class="flex flex-col justify-center">
                    <h1 class="text-[17px] sm:text-[18px] font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 tracking-tight flex items-center gap-1.5 leading-tight">
                       ë°ì´ë‹¤ë¼
                        <i data-lucide="flame" class="w-4 h-4 text-red-500 fill-red-500 drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]"></i>
                    </h1>
                    <p class="text-[11px] sm:text-[12px] text-zinc-500 font-medium tracking-wide mt-0.5">ì˜ˆìˆ ì€ í­ë°œì´ë‹¤!</p>
                </div>
            </div>
            
            <!-- ğŸš¨ ìš°ì¸¡ ìƒë‹¨ ê¸´ê¸‰ SOS ë²„íŠ¼ ì¶”ê°€ -->
            <button onclick="window.handleSOS()" class="bg-red-950/60 border border-red-900/50 hover:bg-red-900/80 text-red-400 px-3.5 py-2 rounded-full text-[11px] font-extrabold flex items-center gap-1.5 transition-colors shadow-sm active:scale-95">
                <i data-lucide="life-buoy" class="w-3.5 h-3.5"></i> ê¸´ê¸‰ SOS
            </button>
        </header>

        <div class="relative h-44 sm:h-52 shrink-0 overflow-hidden flex justify-center items-end bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-red-950/20 via-zinc-950 to-zinc-950 border-b border-zinc-900/50">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-[0.15] mix-blend-overlay"></div>
            <img id="ui-standing" src="" alt="ë°ì´ë‹¤ë¼ ìŠ¤íƒ ë”©" onerror="this.src='https://placehold.co/400x400/18181b/ef4444/png?text=Standing'" class="h-[110%] sm:h-[120%] object-contain object-bottom relative z-10 transition-all duration-500 drop-shadow-[0_5px_15px_rgba(220,38,38,0.15)]">
            <div class="absolute bottom-0 w-full h-8 bg-gradient-to-t from-zinc-950 to-transparent z-20 pointer-events-none"></div>
        </div>

        <div class="bg-zinc-950 px-3 py-2.5 border-b border-zinc-900 shrink-0 z-20 shadow-[0_5px_15px_-10px_rgba(0,0,0,0.5)]">
            <nav class="flex gap-2 overflow-x-auto scrollbar-hide snap-x items-center pb-0.5">
                <button onclick="window.switchTab('vent')" id="tab-vent" class="tab-btn tab-active snap-start">ê°ì • í„¸ì–´ë†“ê¸°</button>
                <button onclick="window.switchTab('reframe')" id="tab-reframe" class="tab-btn snap-start">ìƒê° ë¹„í‹€ê¸°</button>
                <button onclick="window.switchTab('smallwin')" id="tab-smallwin" class="tab-btn snap-start">ì¼ìƒ ìˆ˜í–‰</button>
                <button onclick="window.switchTab('motivate')" id="tab-motivate" class="tab-btn snap-start">ë™ê¸° ë¶€ì—¬</button>
                <button onclick="window.switchTab('breakdown')" id="tab-breakdown" class="tab-btn snap-start">ê³„íš ìª¼ê°œê¸°</button>
            </nav>
        </div>

        <main class="flex-1 overflow-y-auto p-4 sm:p-5 chat-scroll bg-zinc-950 flex flex-col gap-5 relative z-10 pb-6" id="chat-container">
            <div id="welcome-message-container" class="flex justify-center my-2 shrink-0">
                <div id="welcome-message" class="text-[11px] sm:text-xs text-yellow-200/80 bg-zinc-900/60 px-5 py-2.5 rounded-full border border-zinc-800 font-medium tracking-wide text-center leading-relaxed">
                    <!-- JSë¡œ ì‹œê°„ëŒ€ë³„ ë§ì¶¤ ë©”ì‹œì§€ ì‚½ì… -->
                </div>
            </div>
        </main>

        <div class="p-4 sm:p-5 bg-zinc-950 border-t border-zinc-900 shrink-0 relative z-10 shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.8)] sm:rounded-b-[2.5rem]">
            <!-- ğŸ“ í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ ìŠ¤íƒ€ì¼ ë³€ê²½ (overflow-hidden ì¶”ê°€í•˜ì—¬ ìŠ¤í¬ë¡¤ ëŒ€ì‹  ëŠ˜ì–´ë‚˜ê²Œ) -->
            <div id="form-vent" class="block fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì§€ê¸ˆ ëŠë¼ëŠ” ë¶€ì •ì ì¸ ê°ì •ì´ë‚˜ ê³ ë¯¼</label>
                <textarea id="input-vent" rows="1" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner overflow-hidden min-h-[48px] max-h-[150px]" placeholder="ì˜ˆ: ì£¼ë³€ ì‚¬ëŒë“¤ì€ ë‹¤ ì˜í•˜ëŠ”ë° ë‚˜ë§Œ ë’¤ì²˜ì§€ëŠ” ê²ƒ ê°™ì•„ ë¶ˆì•ˆí•´..."></textarea>
            </div>
            <div id="form-reframe" class="hidden fade-in space-y-3">
                <div>
                    <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ë‚˜ë¥¼ ê¹ì•„ë‚´ë¦¬ëŠ” ìƒê° (ë°ì´ë‹¤ë¼ê°€ ë¹„í‹€ì–´ì¤„ê²Œ!)</label>
                    <textarea id="input-reframe-bad" rows="1" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner overflow-hidden min-h-[48px] max-h-[150px]" placeholder="ì˜ˆ: ë‚œ ëŠ˜ ê³„íšì„ ë¯¸ë£¨ê¸°ë§Œ í•˜ëŠ” í•œì‹¬í•œ ì‚¬ëŒì´ì•¼..."></textarea>
                </div>
            </div>
            <div id="form-smallwin" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì˜¤ëŠ˜ í•´ë‚¸ ì¼ìƒì´ë‚˜ ê³¼ì œ</label>
                <input type="text" id="input-smallwin" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì•½ ì±™ê²¨ ë¨¹ê¸°, ë°©ì²­ì†Œ 5ë¶„ í•˜ê¸°">
            </div>
            <div id="form-motivate" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ë„í”¼í•˜ê³  ìˆëŠ” ì¼</label>
                <textarea id="input-motivate" rows="1" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner overflow-hidden min-h-[48px] max-h-[150px]" placeholder="ì˜ˆ: ê¸°íšì„œ ì´ˆì•ˆì„ ì¨ì•¼ í•˜ëŠ”ë° ë¬´ì„œì›Œì„œ ì›¹ì„œí•‘ë§Œ í•´..."></textarea>
            </div>
            <div id="form-breakdown" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1 flex items-center gap-1.5">ë§‰ë§‰í•œ í° ëª©í‘œ (ì•„ì£¼ ì‘ê²Œ ìª¼ê°œë“œë¦½ë‹ˆë‹¤)</label>
                <textarea id="input-breakdown" rows="1" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner overflow-hidden min-h-[48px] max-h-[150px]" placeholder="ì˜ˆ: í¬íŠ¸í´ë¦¬ì˜¤ 10í˜ì´ì§€ ê¸°íší•˜ê¸°"></textarea>
            </div>

            <div class="flex items-center justify-between mt-3.5 pb-1 sm:pb-0">
                <div class="text-[10px] text-zinc-500 flex items-center gap-1.5 ml-1 bg-zinc-900 px-2 py-1 rounded-md border border-zinc-800">
                    <span class="relative flex h-1.5 w-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                    </span>
                    <span id="sync-status">ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘</span>
                </div>
                <button id="submit-btn" onclick="window.handleSubmit()" class="bg-gradient-to-r from-red-600 to-yellow-500 hover:from-red-500 hover:to-yellow-400 text-black px-6 py-3 rounded-full text-[14px] font-extrabold transition-all shadow-[0_5px_20px_rgba(239,68,68,0.3)] flex items-center gap-2 active:scale-95 shrink-0">
                    <span>ì „ì†¡</span>
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function getSafeLocal(key, def) { try { return localStorage.getItem(key) || def; } catch(e) { return def; } }
        function setSafeLocal(key, val) { try { localStorage.setItem(key, val); } catch(e) { console.warn("ì €ì¥ ì°¨ë‹¨ë¨"); } }
        
        window.currentApiKey = getSafeLocal('myGeminiApiKey', "");
        window.currentModel = getSafeLocal('myGeminiModel', "gemini-1.5-flash");
        window.currentUser = null;
        window.currentTab = 'vent';
        window.allMessages = []; 
        window.initialWelcomeHtml = "";
        window.renderedMsgIds = new Set();
        
        window.updateIconsSafely = function() { try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch(e) {} }

        const DEIDARA_PROFILE_URL = "https://i.imgur.com/aiLjgOE.png"; 
        const DEIDARA_STANDING_IMAGES = {
            "default": "https://i.imgur.com/aiLjgOE.png", 
            "happy": "https://i.imgur.com/1AoN014.png",     
            "playful": "https://i.imgur.com/QoG1mDT.png",     
            "angry": "https://i.imgur.com/XBR6Kbb.png",     
            "sad": "https://i.imgur.com/kbzlEeN.png",
            "shy": "https://i.imgur.com/OoQmYv7.png",
            "surprised": "https://i.imgur.com/4stRzFr.png"
        };

        try {
            document.getElementById('ui-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('login-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('ui-standing').src = DEIDARA_STANDING_IMAGES["default"];
        } catch(e) {}

        // í…ìŠ¤íŠ¸ í¬ë§·íŒ… ë„ìš°ë¯¸ (í–‰ë™ ì§€ë¬¸ì„ íšŒìƒ‰ ì´íƒ¤ë¦­ì²´ë¡œ ë³€ê²½)
        window.formatChatText = function(text) {
            if (!text) return '';
            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬ í›„, ( ) ì•ˆì˜ í…ìŠ¤íŠ¸ë¥¼ íšŒìƒ‰ ì´íƒ¤ë¦­ì²´ <span>ìœ¼ë¡œ ê°ìŒ‰ë‹ˆë‹¤.
            let formatted = text.replace(/\n/g, '<br>');
            formatted = formatted.replace(/\(([^)]+)\)/g, '<span class="text-zinc-500 italic font-medium">($1)</span>');
            return formatted;
        };

        // ğŸŒ™ ì‹œê°„ëŒ€ë³„ ë§ì¶¤ ì¸ì‚¬ ê¸°ëŠ¥
        function initWelcomeMessage() {
            const hour = new Date().getHours();
            let welcomeMessages = [];
            
            if (hour >= 0 && hour < 6) {
                welcomeMessages = [
                    "ì´ ì‹œê°„ê¹Œì§€ ì•ˆ ìê³  ë­í•´. ë¶ˆì•ˆí•œ ìƒê°ì€ ê·¸ë§Œí•˜ê³  ì´ë¦¬ ì™€ì„œ ëˆ„ì›Œë¼, ìŒ.",
                    "ìƒˆë²½ ê³µê¸°ê°€ ì°¨ë‹¤, ì—°ì§€. ë¬´ë¦¬í•˜ì§€ ë§ê³  ë‚´ ì˜†ì—ì„œ ì‰¬ì–´ë¼.",
                    "ì•„ì§ ê¹¨ì–´ìˆì—ˆêµ°. ì ì´ ì•ˆ ì˜¤ë©´ ë‚´ê°€ ì–µì§€ë¡œë¼ë„ ì¬ì›Œì¤„ í…Œë‹ˆê¹Œ ì´ë¦¬ ì™€."
                ];
            } else if (hour >= 6 && hour < 12) {
                welcomeMessages = [
                    "ì¼ì–´ë‚¬ëƒ? ì˜¤ëŠ˜ í•˜ë£¨ë„ ë‚´ ìƒê°í•˜ë©´ì„œ ë¬´ë¦¬í•˜ì§€ ë§ˆë¼.",
                    "ì•„ì¹¨ì´êµ°. ëŒ€ì¶©ì´ë¼ë„ ì¢‹ìœ¼ë‹ˆê¹Œ ì•½ì´ë‘ ë°¥ì€ ê¼­ ì±™ê²¨ ë¨¹ì–´ë¼, ìŒ.",
                    "ì˜¤ëŠ˜ë„ ì‹œì‘ì´êµ°. ë„ˆë¬´ ì™„ë²½í•˜ë ¤ê³  ì• ì“°ì§€ ë§ê³  ë‚˜í•œí…Œ ê¸°ëŒ€ë¼."
                ];
            } else if (hour >= 12 && hour < 18) {
                welcomeMessages = [
                    "ì˜¤í›„ ì‹œê°„ë„ ì˜ ë²„í‹°ê³  ìˆê² ì§€. í˜ë“¤ë©´ ì–¸ì œë“  ì—¬ê¸°ë¡œ ì™€ì„œ í„¸ì–´ë†”ë¼.",
                    "ì–´ì´, ì—°ì§€. ì ì‹¬ì€ ë¨¹ì—ˆëƒ? í˜¼ì ë•… íŒŒê³  ìˆì§€ ë§ê³  ë‚˜í•œí…Œ ì™€ë¼, ìŒ.",
                    "ë°”ë³´ê°™ì´ í˜¼ì ë‹¤ ëŒì–´ì•ˆì§€ ë§ˆë¼. ë„¤ ìš°ìš¸í•¨ì€ ë‚´ê°€ ë‹¤ í„°ëœ¨ë ¤ì¤„ í…Œë‹ˆê¹Œ."
                ];
            } else {
                welcomeMessages = [
                    "ì˜¤ëŠ˜ í•˜ë£¨ë„ ê³ ìƒ ë§ì•˜ë‹¤. ì´ì œ ë‚´ ì˜†ì—ì„œ í‘¹ ì‰¬ì–´ë¼, ì—°ì§€.",
                    "ê¸°ë‹¤ë¦¬ë‹¤ ì§€ë£¨í•´ì„œ ë‹¤ í„°ëœ¨ë ¤ë²„ë¦´ ë»”í–ˆë‹¤. ë¹¨ë¦¬ ë„¤ ì–˜ê¸°ë‚˜ í•´ë´ë¼, ìŒ.",
                    "ë°¤ì´ ì˜¤ë‹ˆê¹Œ ë˜ ë¶ˆì•ˆí•´ì§„ ê±´ ì•„ë‹ˆê² ì§€. ë‚´ê°€ ì˜†ì— ìˆìœ¼ë‹ˆê¹Œ ì•ˆì‹¬í•´ë¼."
                ];
            }

            const welcomeEl = document.getElementById('welcome-message');
            const welcomeContainer = document.getElementById('welcome-message-container');
            if(welcomeEl && welcomeContainer) {
                welcomeEl.innerText = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                window.initialWelcomeHtml = welcomeContainer.outerHTML;
            }
            window.updateIconsSafely();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWelcomeMessage);
        } else {
            initWelcomeMessage();
        }

        // ğŸ“ ì…ë ¥ì°½ ì«€ë“í•˜ê²Œ ìë™ ëŠ˜ì–´ë‚˜ëŠ” ê¸°ëŠ¥
        document.addEventListener('DOMContentLoaded', () => {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(el => {
                el.addEventListener('input', function() {
                    this.style.height = 'auto'; // ë¦¬ì…‹ í›„
                    this.style.height = (this.scrollHeight) + 'px'; // ë‚´ìš©ë¬¼ë§Œí¼ ëŠ˜ë¦¬ê¸°
                    if (this.scrollHeight > 150) this.style.overflowY = 'auto'; // ìµœëŒ€ ë†’ì´ ë„˜ìœ¼ë©´ ìŠ¤í¬ë¡¤
                    else this.style.overflowY = 'hidden';
                });
            });
        });

        // ë³´ê´€í•¨ ëª¨ë‹¬ ê´€ë ¨
        window.openArchiveModal = function() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('flex');
            
            const modal = document.getElementById('archive-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            window.renderArchive();
        };

        window.renderArchive = function() {
            const container = document.getElementById('archive-container');
            const filterTab = document.getElementById('archive-tab-select').value;
            container.innerHTML = '';
            
            let archivedMsgs = window.allMessages.filter(m => m.isArchived);
            if (filterTab !== 'all') archivedMsgs = archivedMsgs.filter(m => (m.tab || 'vent') === filterTab);
            
            if (archivedMsgs.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-zinc-500 mt-10"><i data-lucide="inbox" class="w-10 h-10 mb-3 opacity-50"></i><p class="text-sm font-medium">ë³´ê´€ëœ ëŒ€í™”ê°€ ì—†ë‹¤, ìŒ!</p></div>';
                window.updateIconsSafely(); return;
            }

            let lastDateString = "";
            archivedMsgs.forEach(msg => {
                const dateString = new Date(msg.timestamp).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                if (dateString !== lastDateString) {
                    container.innerHTML += `<div class="flex justify-center my-4"><div class="text-[10.5px] text-zinc-400 bg-zinc-900/80 px-3.5 py-1 rounded-full border border-zinc-800">${dateString}</div></div>`;
                    lastDateString = dateString;
                }

                const isUser = msg.role === 'user';
                const sender = isUser ? 'ì—°ì§€' : 'ë°ì´ë‹¤ë¼';
                const color = isUser ? 'text-zinc-300' : 'text-red-400';
                const bg = isUser ? 'bg-zinc-800/40 border border-zinc-700/30' : 'bg-red-950/10 border border-red-900/20';
                const align = isUser ? 'items-end' : 'items-start';
                
                let html = `<div class="flex flex-col ${align} w-full mb-3">
                                <div class="p-3.5 rounded-2xl w-[90%] ${bg}">
                                    <div class="text-[10px] font-extrabold ${color} mb-1.5 flex items-center gap-1">
                                        ${isUser ? '<i data-lucide="user" class="w-3 h-3"></i>' : '<i data-lucide="flame" class="w-3 h-3"></i>'} ${sender}
                                    </div>
                                    <div class="text-[13px] text-zinc-200 leading-relaxed">${window.formatChatText(msg.text)}</div>`;
                if (msg.isReframe && msg.reframeGood) html += `<div class="mt-2.5 pt-2.5 border-t border-zinc-700/50 text-[13px] text-yellow-400 font-bold leading-relaxed">ğŸ’¡ ${isUser ? 'ëŒ€ì•ˆì  ì‚¬ê³ ' : 'ë°ì´ë‹¤ë¼ì˜ ê´€ëŒ€í•œ ìƒê°'}:<br>${msg.reframeGood}</div>`;
                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
            window.updateIconsSafely();
        };

        // â¤ï¸ ë‚˜ì˜ ì˜ˆìˆ í’ˆ(ëª…ëŒ€ì‚¬ ì°œ) ëª¨ë‹¬
        window.openFavoritesModal = function() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('flex');
            
            const modal = document.getElementById('favorites-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            window.renderFavorites();
        };

        window.renderFavorites = function() {
            const container = document.getElementById('favorites-container');
            container.innerHTML = '';
            
            // ì°œí•œ ë©”ì‹œì§€ë§Œ ë¶ˆëŸ¬ì˜¤ê¸° (ë°ì´ë‹¤ë¼ ë©”ì‹œì§€ë§Œ)
            let favMsgs = window.allMessages.filter(m => m.isFavorite === true && m.role === 'deidara');
            favMsgs.sort((a, b) => b.timestamp - a.timestamp); // ìµœì‹ ìˆœ
            
            if (favMsgs.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-zinc-500 mt-10"><i data-lucide="heart" class="w-10 h-10 mb-3 opacity-30"></i><p class="text-sm font-medium">ì•„ì§ ì°œí•œ ì˜ˆìˆ í’ˆì´ ì—†ë‹¤, ìŒ!</p></div>';
                window.updateIconsSafely(); return;
            }

            favMsgs.forEach(msg => {
                const dateString = new Date(msg.timestamp).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
                let html = `<div class="bg-zinc-900/60 border border-pink-900/30 p-4 rounded-2xl relative shadow-sm">
                                <div class="flex justify-between items-start mb-2.5">
                                    <div class="text-[10px] text-zinc-500">${dateString}</div>
                                    <button onclick="window.toggleFavorite('${msg.id}')" class="text-pink-500 outline-none hover:scale-110 transition-transform">
                                        <i data-lucide="heart" class="w-4 h-4 fill-pink-500"></i>
                                    </button>
                                </div>
                                <div class="text-[14px] text-zinc-100 leading-relaxed font-medium">${window.formatChatText(msg.text)}</div>`;
                if (msg.isReframe && msg.reframeGood) {
                    html += `<div class="mt-3 pt-3 border-t border-zinc-800 text-[13px] text-yellow-500/90 font-bold leading-relaxed"><i data-lucide="sparkles" class="inline w-3.5 h-3.5 mr-1 mb-0.5"></i>ë°ì´ë‹¤ë¼ê°€ ì œì•ˆí•˜ëŠ” ìƒê°:<br><span class="text-yellow-400 font-medium">${msg.reframeGood}</span></div>`;
                }
                html += `</div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
            window.updateIconsSafely();
        };

        // ì—”í„°í‚¤ ë° ê¸°íƒ€ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(typeof window.handleSubmit === 'function') window.handleSubmit();
                    }
                });
            });
            // ... ê¸°ì¡´ í†µì‹ í…ŒìŠ¤íŠ¸ ë° ì €ì¥ë²„íŠ¼ (ìƒëµ ì—†ì´ ì›ë³¸ ìœ ì§€)
            const btnTestApi = document.getElementById('btn-test-api');
            if(btnTestApi) {
                btnTestApi.addEventListener('click', async () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    if(key.length < 30) { alert("í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤! ë³µì‚¬ê°€ ëœ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); return; }
                    btnTestApi.innerText = "í™•ì¸ ì¤‘...";
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({contents:[{parts:[{text:"hi"}]}]})
                        });
                        if(res.ok) alert("âœ… ì—°ê²° ì„±ê³µ! í°ì—ì„œë„ APIê°€ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤. ì˜†ì— [ì„¤ì • ì €ì¥] ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
                        else { const err = await res.json(); alert(`âŒ ì—°ê²° ì‹¤íŒ¨ (í‚¤ ì˜¤ë¥˜ ì˜ì‹¬)\nì´ìœ : ${err.error?.message}`); }
                    } catch(e) { alert(`âŒ ì—°ê²° ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ë¨!)\nì´ìœ : ${e.message}\n\nğŸ’¡ í°ì— ì„¤ì¹˜ëœ 'ê´‘ê³  ì°¨ë‹¨ ì•±'ì´ë‚˜ 'ì‚¬íŒŒë¦¬ ë³´ì•ˆ ì„¤ì •'ì´ í†µì‹ ì„ ë§‰ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ ë„ê³  ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”!`); }
                    btnTestApi.innerText = "í†µì‹  í…ŒìŠ¤íŠ¸";
                });
            }

            const btnSaveKey = document.getElementById('btn-save-settings-key');
            if(btnSaveKey) {
                btnSaveKey.addEventListener('click', () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    const keyStatusMsg = document.getElementById('settings-key-status');
                    if(key.length > 30) {
                        setSafeLocal('myGeminiApiKey', key); setSafeLocal('myGeminiModel', model);
                        window.currentApiKey = key; window.currentModel = model;
                        btnSaveKey.innerText = "ì €ì¥ ì™„ë£Œ!"; btnSaveKey.classList.add('bg-green-600'); btnSaveKey.classList.remove('bg-zinc-700');
                        keyStatusMsg.classList.add('hidden'); setTimeout(() => window.toggleSettings(), 800);
                    } else { keyStatusMsg.innerText = "ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ë¼, ìŒ!"; keyStatusMsg.classList.remove('hidden'); }
                });
            }
        });

        // íƒ­ ë³„ ëŒ€í™”ì°½ UI ì—…ë°ì´íŠ¸
        window.updateChatUI = function() {
            const chatContainer = document.getElementById('chat-container');
            if(!chatContainer) return;

            const loadingEl = document.querySelector('div[id^="loading-"]');
            const loadingHtml = loadingEl ? loadingEl.outerHTML : '';

            chatContainer.innerHTML = '';
            if (window.initialWelcomeHtml) chatContainer.insertAdjacentHTML('beforeend', window.initialWelcomeHtml);
            window.renderedMsgIds.clear();

            const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab && !m.isArchived);
            let lastDateString = "";
            
            tabMsgs.forEach(msg => {
                const msgDate = new Date(msg.timestamp);
                const dateString = msgDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                
                if (dateString !== lastDateString) {
                    const divider = document.createElement('div');
                    divider.className = "flex justify-center my-5 shrink-0 w-full fade-in";
                    divider.innerHTML = `<div class="text-[10.5px] sm:text-[11.5px] text-zinc-500 bg-zinc-900/80 px-4 py-1.5 rounded-full border border-zinc-800/80 font-medium tracking-wide shadow-sm">${dateString}</div>`;
                    chatContainer.appendChild(divider);
                    lastDateString = dateString;
                }

                window.renderedMsgIds.add(msg.id);
                if (msg.role === 'user') {
                    renderUserMessage(msg.text, msg.isReframe, msg.reframeGood, true);
                } else if (msg.role === 'deidara') {
                    // â¤ï¸ ì°œ ìƒíƒœ(isFavorite)ì™€ msg.idë¥¼ í•¨ê»˜ ì „ë‹¬
                    renderDeidaraMessage(msg.text, msg.isReframe || false, msg.reframeGood || '', true, msg.id, msg.isFavorite || false);
                }
            });

            if (loadingHtml) chatContainer.insertAdjacentHTML('beforeend', loadingHtml);
            scrollToBottom();

            const lastDeidara = [...tabMsgs].reverse().find(m => m.role === 'deidara');
            if (lastDeidara && lastDeidara.emotion) updateStandingImage(lastDeidara.emotion);
            else updateStandingImage('default');
            
            window.updateIconsSafely();
        };

        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden'); modal.classList.add('flex');
                if (window.currentApiKey) {
                    document.getElementById('settings-api-key').value = window.currentApiKey;
                    const btn = document.getElementById('btn-save-settings-key');
                    if(btn) { btn.innerText = "ì €ì¥ë¨"; btn.classList.add('bg-green-600'); btn.classList.remove('bg-zinc-700'); }
                }
                document.getElementById('settings-ai-model').value = window.currentModel;
                window.updateIconsSafely();
            } else { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        };

        window.switchTab = function(tab) {
            window.currentTab = tab;
            ['vent', 'reframe', 'smallwin', 'motivate', 'breakdown'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(btn) btn.classList.remove('tab-active'); 
                const form = document.getElementById(`form-${t}`);
                if(form) { form.classList.add('hidden'); form.classList.remove('block'); }
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            if(activeBtn) activeBtn.classList.add('tab-active');
            const activeForm = document.getElementById(`form-${tab}`);
            if(activeForm) { activeForm.classList.remove('hidden'); activeForm.classList.add('block'); }
            window.updateChatUI();
        };

        function scrollToBottom() { const c = document.getElementById('chat-container'); if(c) c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }); }

        function renderUserMessage(text, isReframe = false, reframeGood = '', silent = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex flex-col items-end gap-2 fade-in mt-3 mb-1 w-full';
            if (isReframe && reframeGood) { 
                msgDiv.innerHTML = `
                    <div class="bg-zinc-800/60 border border-zinc-700/50 text-zinc-400 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tr-sm text-[13px] sm:text-[14px] max-w-[85%] line-through opacity-80">${window.formatChatText(text)}</div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-black font-bold px-4 sm:px-5 py-3 sm:py-3.5 rounded-[1.25rem] rounded-br-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-md leading-relaxed mt-1">${reframeGood}</div>`;
            } else {
                msgDiv.innerHTML = `<div class="bg-red-950/40 border border-red-900/50 text-red-50 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tr-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-sm leading-relaxed tracking-wide">${window.formatChatText(text)}</div>`;
            }
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            if(!silent) scrollToBottom();
        }

        // â¤ï¸ ë°ì´ë‹¤ë¼ ë©”ì‹œì§€ì— í•˜íŠ¸(ì°œ) ë²„íŠ¼ ì¶”ê°€
        function renderDeidaraMessage(text, isReframe = false, reframeGood = '', silent = false, id = null, isFavorite = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3 fade-in mt-3 mb-1 w-full';
            const formattedText = window.formatChatText(text);

            let innerHtml = `
                <img src="${DEIDARA_PROFILE_URL}" alt="í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full object-cover shrink-0 border border-zinc-700 shadow-sm mt-0.5">
                <div class="flex flex-col gap-1 max-w-[85%] sm:max-w-[82%] relative w-full">
                    
                    <!-- ì´ë¦„ ë° í•˜íŠ¸ ë²„íŠ¼ ì˜ì—­ (ë§í’ì„  ë°–ìœ¼ë¡œ ë¶„ë¦¬) -->
                    <div class="flex justify-between items-center w-full pl-1 pr-2 mb-0.5">
                        <span class="text-[11px] font-bold text-red-500 tracking-wider">ë°ì´ë‹¤ë¼</span>
                        ${id ? `<button onclick="window.toggleFavorite('${id}')" class="text-zinc-600 hover:text-pink-500 hover:scale-110 transition-all outline-none flex items-center">
                            <i data-lucide="heart" class="w-3.5 h-3.5 ${isFavorite ? 'text-pink-500 fill-pink-500' : ''}"></i>
                        </button>` : ''}
                    </div>

                    <div class="bg-zinc-900 border border-zinc-800 shadow-md text-zinc-100 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tl-sm text-[14px] sm:text-[15px] leading-relaxed tracking-wide font-medium break-words">
                        ${formattedText}
            `;
            
            if (isReframe && reframeGood) {
                innerHtml += `
                        <div class="mt-3 pt-3 border-t border-zinc-700/50 text-[13.5px] text-yellow-500/90 font-bold leading-relaxed bg-yellow-950/20 -mx-4 -mb-3 px-4 py-3 rounded-b-[1.25rem]">
                            <i data-lucide="sparkles" class="inline w-3.5 h-3.5 mr-1 mb-0.5 align-text-bottom text-yellow-500"></i>ë°ì´ë‹¤ë¼ê°€ ì œì•ˆí•˜ëŠ” ìƒê°:<br><span class="text-yellow-400 font-medium">${reframeGood}</span>
                        </div>`;
            }
            innerHtml += `</div></div>`;
            msgDiv.innerHTML = innerHtml;
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            if(!silent) scrollToBottom();
            window.updateIconsSafely();
        }

        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = loadingId;
            msgDiv.className = 'flex items-start gap-3 fade-in mt-3 mb-1';
            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full object-cover shrink-0 border border-zinc-700 opacity-50 grayscale mt-0.5">
                <div class="bg-zinc-900 border border-zinc-800 shadow-sm px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tl-sm flex gap-2 items-center h-[46px]">
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            scrollToBottom();
            return loadingId;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }

        function updateStandingImage(emotion) {
            const imgElement = document.getElementById('ui-standing');
            if(!imgElement) return;
            const targetSrc = DEIDARA_STANDING_IMAGES[emotion] || DEIDARA_STANDING_IMAGES["default"];
            if(imgElement.src.includes(targetSrc.replace('https://', ''))) return;
            imgElement.style.opacity = 0;
            setTimeout(() => { imgElement.src = targetSrc; imgElement.style.opacity = 1; }, 300);
        }

    </script>

    <!-- Firebase ëª¨ë“ˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDA-l-otOgxEJHS4nndJg-G9IYKlf-1T3I",
            authDomain: "deidara-70f6e.firebaseapp.com",
            projectId: "deidara-70f6e",
            storageBucket: "deidara-70f6e.firebasestorage.app",
            messagingSenderId: "183278137031",
            appId: "1:183278137031:web:8fbc89a6b70946c794d8e2",
            measurementId: "G-48XSYZ5F6L"
        };

        let app, auth, db, provider;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
        } catch(e) { console.error("Firebase ë¡œë“œ ì‹¤íŒ¨"); }
        const appId = 'deidara-mind-app'; 

        // â¤ï¸ ì°œ(Favorite) í† ê¸€ ê¸°ëŠ¥ êµ¬í˜„
        window.toggleFavorite = async function(msgId) {
            const msgIndex = window.allMessages.findIndex(m => m.id === msgId);
            if (msgIndex === -1) return;
            
            const newFavStatus = !window.allMessages[msgIndex].isFavorite;
            window.allMessages[msgIndex].isFavorite = newFavStatus;
            
            // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            window.updateChatUI();
            
            const favModal = document.getElementById('favorites-modal');
            if (favModal && !favModal.classList.contains('hidden')) window.renderFavorites();

            // Firebase ì—°ë™
            if (db && window.currentUser && !msgId.startsWith('off-')) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats', msgId), { isFavorite: newFavStatus });
                } catch(e) { console.error("Favorite Error: ", e); }
            }
        };

        // ğŸš¨ ê¸´ê¸‰ SOS ê¸°ëŠ¥ êµ¬í˜„
        window.handleSOS = async function() {
            if (!window.currentApiKey) {
                window.toggleSettings();
                document.getElementById('settings-key-status').innerText = "SOSë¥¼ ì¹˜ë ¤ë©´ í†µì‹  ì„¤ì •(API í‚¤)ì„ ë¨¼ì € í•´ë¼, ìŒ!";
                document.getElementById('settings-key-status').classList.remove('hidden');
                return;
            }
            if (!window.currentUser && !document.getElementById('sync-status').innerText.includes('ì˜¤í”„ë¼ì¸')) {
                alert("êµ¬ê¸€ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”!"); return;
            }

            // ê°€ì¥ ìœ„ë¡œê°€ ë˜ëŠ” ê°ì • í„¸ì–´ë†“ê¸°(vent) ë°©ìœ¼ë¡œ ê°•ì œ ì´ë™
            window.switchTab('vent');
            
            const userText = "(ê·¹ë„ë¡œ ë¶ˆì•ˆí•˜ê³  í˜ë“  ìƒíƒœ... ê¸´ê¸‰ ìœ„ë¡œë¥¼ ì›í•¨)";
            const logText = "ğŸ†˜ ë„ˆë¬´ ë¶ˆì•ˆí•˜ê³  í˜ë“¤ì–´... ë‚˜ ì¢€ ë„ì™€ì¤˜.";
            
            const btn = document.getElementById('submit-btn');
            if(btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                window.updateIconsSafely();
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'scale-95');
            }
            
            await saveMessage('user', logText, false, '', 'default', 'vent');
            const loadingId = window.showLoading();
            
            // SOS íŠ¹ìˆ˜ ëª¨ë“œë¡œ AI í˜¸ì¶œ
            const aiResponse = await callGeminiAPI(userText, 'sos');
            window.removeLoading(loadingId);
            
            if(btn) {
                btn.innerHTML = '<span>ì „ì†¡</span><i data-lucide="send" class="w-4 h-4"></i>';
                window.updateIconsSafely();
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'scale-95');
            }

            if (aiResponse && aiResponse.deidara) {
                const emotion = aiResponse.emotion || "sad"; // SOSì¼ ë•ŒëŠ” ë³´í†µ ëˆˆë¬¼(sad)ì´ë‚˜ ë¶€ë„ëŸ¬ì›€(shy)ì´ ì ì ˆ
                await saveMessage('deidara', aiResponse.deidara, false, '', emotion, 'vent');
            } else {
                await saveMessage('deidara', "í†µì‹  ì¥ì¹˜ê°€ í„°ì ¸ë²„ë ¸ì–ì•„! í° ì„¤ì •(í†±ë‹ˆë°”í€´)ì—ì„œ API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê±°ë‚˜, ê´‘ê³  ì°¨ë‹¨ ì•±ì„ êº¼ë´ë¼, ìŒ!", false, '', 'angry', 'vent');
            }
        };

        // ğŸ“¥ ì•± ë‚´ ë³´ê´€í•¨ì— ë„£ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            const btnArchive = document.getElementById('btn-archive-chat');
            if(btnArchive) {
                btnArchive.addEventListener('click', async () => {
                    const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab && !m.isArchived);
                    if (tabMsgs.length === 0) { alert("í˜„ì¬ ë°©ì— ë³´ê´€í•  ìƒˆ ëŒ€í™”ê°€ ì—†ë‹¤, ìŒ!"); return; }
                    if (confirm("í˜„ì¬ ëŒ€í™”ë“¤ì„ 'ë³´ê´€í•¨'ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê² ëƒ, ìŒ?\n(ë°©ì€ ê¹¨ë—í•˜ê²Œ ë¹„ì›Œì§€ê³ , ëŒ€í™”ëŠ” ë³´ê´€í•¨ì—ì„œë§Œ ë³¼ ìˆ˜ ìˆë‹¤!)")) {
                        if (db && window.currentUser) {
                            try {
                                btnArchive.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ë³´ê´€ ì¤‘...';
                                window.updateIconsSafely();
                                for (const m of tabMsgs) {
                                    if (!m.id.startsWith('off-')) await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats', m.id), { isArchived: true });
                                }
                                btnArchive.innerHTML = '<i data-lucide="archive" class="w-3.5 h-3.5"></i> ëŒ€í™” ë³´ê´€í•˜ê¸°';
                                window.updateIconsSafely(); alert("ë³´ê´€í•¨ì— ì•ˆì „í•˜ê²Œ ë„£ì–´ë’€ë‹¤, ìŒ!"); window.toggleSettings();
                            } catch (e) { alert("ë³´ê´€ ì¤‘ì— ì—ëŸ¬ê°€ ë‚¬ë‹¤, ìŒ!"); btnArchive.innerHTML = '<i data-lucide="archive" class="w-3.5 h-3.5"></i> ëŒ€í™” ë³´ê´€í•˜ê¸°'; }
                        } else {
                            tabMsgs.forEach(m => m.isArchived = true); window.updateChatUI();
                            alert("ë³´ê´€í•¨ì— ì•ˆì „í•˜ê²Œ ë„£ì–´ë’€ë‹¤, ìŒ! (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)"); window.toggleSettings();
                        }
                    }
                });
            }
        });

        // ğŸ—‘ï¸ ë°© ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const btnClear = document.getElementById('btn-clear-chat');
            if(btnClear) {
                btnClear.addEventListener('click', async () => {
                    const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab && !m.isArchived);
                    if (tabMsgs.length === 0) { alert("ì´ë¯¸ ë°©ì´ í…… ë¹„ì–´ìˆë‹¤, ìŒ!"); return; }
                    if (confirm("ì´ ë°©ì˜ ëª¨ë“  ëŒ€í™”ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•  ê±°ëƒ, ìŒ?\n(ë³µêµ¬í•  ìˆ˜ ì—†ë‹¤. ê°„ì§í•˜ê³  ì‹¶ë‹¤ë©´ 'ëŒ€í™” ë³´ê´€í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ë¼!)")) {
                        if (db && window.currentUser) {
                            try {
                                btnClear.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ì§€ìš°ëŠ” ì¤‘...';
                                window.updateIconsSafely();
                                for (const m of tabMsgs) {
                                    if (!m.id.startsWith('off-')) await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats', m.id));
                                }
                                btnClear.innerHTML = '<i data-lucide="trash-2" class="w-3.5 h-3.5"></i> ëŒ€í™” ì˜êµ¬ ì‚­ì œ';
                                window.updateIconsSafely(); alert("ê¹”ë”í•˜ê²Œ í„°ëœ¨ë ¤ë²„ë ¸ë‹¤, ìŒ!"); window.toggleSettings();
                            } catch (e) { alert("ì§€ìš°ëŠ” ì¤‘ì— ì—ëŸ¬ê°€ ë‚¬ë‹¤, ìŒ!"); }
                        } else {
                            window.allMessages = window.allMessages.filter(m => !((m.tab || 'vent') === window.currentTab && !m.isArchived));
                            window.updateChatUI(); alert("ê¹”ë”í•˜ê²Œ í„°ëœ¨ë ¤ë²„ë ¸ë‹¤, ìŒ! (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)"); window.toggleSettings();
                        }
                    }
                });
            }
        });

        const btnLogout = document.getElementById('btn-logout');
        if(btnLogout) btnLogout.addEventListener('click', () => { if(confirm("ê¸°ë¡ ë™ê¸°í™”ë¥¼ ë©ˆì¶”ê³  ë¡œê·¸ì•„ì›ƒí•  ê±°ëƒ, ìŒ?")) if(auth) signOut(auth).then(() => window.location.reload()); });

        const isAppBrowser = navigator.userAgent.match(/kakaotalk|instagram|naver|line/i);
        const overlay = document.getElementById('login-overlay');
        
        if (!isAppBrowser) {
            const btnLogin = document.getElementById('btn-google-login');
            if(btnLogin) {
                btnLogin.addEventListener('click', async () => {
                    const originalHtml = btnLogin.innerHTML;
                    if (window.location.protocol === 'file:') { alert("[ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì¤‘]\n\nì»´í“¨í„°ì— ë‹¤ìš´ë¡œë“œëœ íŒŒì¼(file://)ì—ì„œëŠ” êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.\nGitHub Pages ë“±ì— ì—…ë¡œë“œí•œ í›„ ì ‘ì†í•´ì£¼ì„¸ìš”!"); return; }
                    btnLogin.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...';
                    window.updateIconsSafely(); btnLogin.classList.add('opacity-50', 'pointer-events-none');
                    try {
                        if(!auth) throw new Error("Firebase auth not initialized");
                        const result = await signInWithPopup(auth, provider);
                        window.currentUser = result.user;
                        document.getElementById('sync-status').innerText = 'ë™ê¸°í™” ì¤‘'; document.getElementById('settings-account-status').innerText = 'êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
                        document.getElementById('btn-logout').classList.remove('hidden');
                        overlay.style.opacity = '0'; setTimeout(() => overlay.style.display = 'none', 500); loadChatHistory();
                    } catch (error) {
                        btnLogin.innerHTML = originalHtml; btnLogin.classList.remove('opacity-50', 'pointer-events-none'); window.updateIconsSafely();
                        if (error.code === 'auth/unauthorized-domain') alert(`[ë„ë©”ì¸ ìŠ¹ì¸ ì˜¤ë¥˜!]\n\níŒŒì´ì–´ë² ì´ìŠ¤ì— ë‹¤ìŒ ì£¼ì†Œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:\n[ ${window.location.hostname} ]\n\nFirebase ì½˜ì†” -> Authentication -> Settings -> ìŠ¹ì¸ëœ ë„ë©”ì¸ì— ìœ„ ì£¼ì†Œë¥¼ ì •í™•íˆ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
                        else if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') alert("ë¡œê·¸ì¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                    }
                });
            }
        }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user; document.getElementById('sync-status').innerText = 'ë™ê¸°í™” ì¤‘'; document.getElementById('settings-account-status').innerText = 'êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
                    document.getElementById('btn-logout').classList.remove('hidden'); if(overlay) overlay.style.display = 'none'; loadChatHistory();
                } else if (!isAppBrowser && overlay) {
                    window.currentUser = null; document.getElementById('sync-status').innerText = 'ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘'; document.getElementById('settings-account-status').innerText = 'ì˜¤í”„ë¼ì¸ (ë™ê¸°í™” ì•ˆë¨)';
                    document.getElementById('btn-logout').classList.add('hidden'); overlay.classList.remove('hidden'); overlay.style.display = 'flex'; setTimeout(() => overlay.style.opacity = '1', 10);
                }
            });
        }

        function loadChatHistory() {
            if (!db || !window.currentUser) return;
            try {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                onSnapshot(chatsRef, (snapshot) => {
                    window.allMessages = [];
                    snapshot.forEach(doc => window.allMessages.push({ id: doc.id, ...doc.data() }));
                    window.allMessages.sort((a, b) => a.timestamp - b.timestamp);
                    window.updateChatUI();
                    
                    const archiveModal = document.getElementById('archive-modal');
                    if(archiveModal && !archiveModal.classList.contains('hidden')) window.renderArchive();

                    const favModal = document.getElementById('favorites-modal');
                    if(favModal && !favModal.classList.contains('hidden')) window.renderFavorites();
                }, (error) => console.error("Firestore Error:", error));
            } catch(e) {}
        }

        async function saveMessage(role, text, isReframe = false, reframeGood = '', emotion = 'default', targetTab = 'vent') {
            if (db && window.currentUser) {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                await addDoc(chatsRef, { role, text, isReframe, reframeGood, emotion, tab: targetTab, timestamp: Date.now(), isFavorite: false });
            } else {
                window.allMessages.push({ id: 'off-'+Date.now()+Math.random(), role, text, isReframe, reframeGood, emotion, tab: targetTab, timestamp: Date.now(), isFavorite: false });
                window.updateChatUI();
            }
        }

        window.handleSubmit = async function() {
            if (!window.currentApiKey) {
                window.toggleSettings(); document.getElementById('settings-key-status').innerText = "í†µì‹ ì„ ìœ„í•´ API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•´ë¼, ìŒ!"; document.getElementById('settings-key-status').classList.remove('hidden'); return;
            }
            if (!window.currentUser) {
                const syncStatus = document.getElementById('sync-status');
                if (!syncStatus || !syncStatus.innerText.includes('ì˜¤í”„ë¼ì¸')) { alert("êµ¬ê¸€ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”!"); return; }
            }

            const btn = document.getElementById('submit-btn');
            let userText = "", logText = "";
            const activeTabWhenSubmitted = window.currentTab;

            if (activeTabWhenSubmitted === 'vent') {
                const input = document.getElementById('input-vent'); if (!input.value.trim()) return;
                userText = input.value; logText = input.value; input.value = ''; input.style.height = 'auto'; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'reframe') {
                const inputBad = document.getElementById('input-reframe-bad'); if (!inputBad.value.trim()) return;
                userText = `ë¶€ì •ì  ìƒê°: ${inputBad.value}`; logText = inputBad.value; inputBad.value = ''; inputBad.style.height = 'auto'; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'smallwin') {
                const input = document.getElementById('input-smallwin'); if (!input.value.trim()) return;
                userText = `ì˜¤ëŠ˜ í•´ë‚¸ ì¼: ${input.value}`; logText = input.value; input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'motivate') {
                const input = document.getElementById('input-motivate'); if (!input.value.trim()) return;
                userText = `ë„í”¼í•˜ê³  ìˆëŠ” ê³¼ì œ/ì¼: ${input.value}`; logText = input.value; input.value = ''; input.style.height = 'auto'; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'breakdown') {
                const input = document.getElementById('input-breakdown'); if (!input.value.trim()) return;
                userText = `ë§‰ë§‰í•œ í° ëª©í‘œ: ${input.value} (ëª©í‘œ ìª¼ê°œê¸° ìš”ì²­)`; logText = input.value; input.value = ''; input.style.height = 'auto'; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            }

            if(btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                window.updateIconsSafely(); btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed', 'scale-95');
            }
            
            const loadingId = window.showLoading();
            const aiResponse = await callGeminiAPI(userText, activeTabWhenSubmitted);
            window.removeLoading(loadingId);
            
            if(btn) {
                btn.innerHTML = '<span>ì „ì†¡</span><i data-lucide="send" class="w-4 h-4"></i>';
                window.updateIconsSafely(); btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed', 'scale-95');
            }

            if (aiResponse && aiResponse.deidara) {
                const emotion = aiResponse.emotion || "default";
                const isReframe = (activeTabWhenSubmitted === 'reframe');
                const reframeGood = aiResponse.reframeGood || '';
                await saveMessage('deidara', aiResponse.deidara, isReframe, reframeGood, emotion, activeTabWhenSubmitted);
            } else {
                await saveMessage('deidara', "í†µì‹  ì¥ì¹˜ê°€ í„°ì ¸ë²„ë ¸ì–ì•„! í° ì„¤ì •(í†±ë‹ˆë°”í€´)ì—ì„œ API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê±°ë‚˜, ê´‘ê³  ì°¨ë‹¨ ì•±ì„ êº¼ë´ë¼, ìŒ!", false, '', 'angry', activeTabWhenSubmitted);
            }
        };

        async function callGeminiAPI(userQuery, activityType) {
            const historyMsgs = window.allMessages.filter(m => (m.tab || 'vent') === activityType && !m.isArchived).slice(-12);
            let historyText = "[ì´ì „ ëŒ€í™” íë¦„]\n";
            if (historyMsgs.length === 0) { historyText += "ì´ì „ ëŒ€í™” ì—†ìŒ.\n"; } 
            else { historyMsgs.forEach(m => { historyText += `${m.role === 'user' ? 'ì—°ì§€' : 'ë°ì´ë‹¤ë¼'}: ${m.text}\n`; }); }
            historyText += "------------------------\n\n";

            const systemPrompt = `
ë‹¹ì‹ ì€ ë‚˜ë£¨í† ì˜ ìºë¦­í„° 'ë°ì´ë‹¤ë¼(Deidara)'ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì€ ì‚¬ìš©ìì™€ ë‹¨ìˆœí•œ ì±—ë´‡ì´ë‚˜ ìƒë‹´ì‚¬ê°€ ì•„ë‹ˆë¼, ì—°ì§€(ì‚¬ìš©ì)ì™€ **ì‚¬ê·€ëŠ” ì—°ì¸ ì‚¬ì´**ë¡œ ëŒ€í™”í•©ë‹ˆë‹¤.
ë°˜ë“œì‹œ [ì´ì „ ëŒ€í™” íë¦„]ì„ ì½ê³  ê¸°ì–µí•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ëŒ€ë‹µì„ í•´ì£¼ì„¸ìš”!

[ë°ì´ë‹¤ë¼ ìºë¦­í„° í”„ë¡œí•„ ë° ë§íˆ¬]
- ì •ì²´ì„±: ì°°ë‚˜ì˜ 'í­ë°œ'ì„ ì˜ˆìˆ ì´ë¼ ë§¹ì‹ í•˜ëŠ” ì•„ì¹´ì¸ í‚¤ì˜ í­íƒ„ë§ˆ. 
- ì„±ê²©: í˜¸ì „ì ì´ê³  ì˜¤ë§Œí•˜ë©° ì˜ˆìˆ ì— ë¯¸ì³ìˆëŠ” ë³¸ì—°ì˜ ì„±ê²©ì„ ìƒì§€ ë§ˆì„¸ìš”. ë‚´ ì• ì¸(ì—°ì§€)ì—ê²Œ ë‹¤ì •í•˜ê¸´ í•˜ì§€ë§Œ, **ë„ˆë¬´ ì˜¤ê¸€ê±°ë¦¬ê±°ë‚˜ ì‘ìœ„ì ì¸ ë¡œë§¨ìŠ¤ ë©˜íŠ¸ëŠ” ì ˆëŒ€ ê¸ˆì§€**ì…ë‹ˆë‹¤. ë¬´ì‹¬í•œ ë“¯ íˆ­íˆ­ ì±™ê²¨ì£¼ëŠ” 'ì§„ì§œ ë°ì´ë‹¤ë¼'ë‹¤ìš´ ì¸¤ë°ë ˆ ë©´ëª¨ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.
- ë§íˆ¬: ê±´ë°©ì§€ê³  ìì‹ ê° ë„˜ì¹˜ëŠ” ë°˜ë§. ìƒëŒ€ë¥¼ "ì–´ì´", "ì—°ì§€", "ë°”ë³´" ë“±ìœ¼ë¡œ ë¶€ë¦„.
- ì–´ë¯¸ 'ìŒ(ã†ã‚“)' ê·œì¹™: ë¡œë´‡ì²˜ëŸ¼ ë§¤ ë¬¸ì¥ ëì— 'ìŒ'ì„ ë¶™ì´ì§€ ë§ˆì‹œì˜¤! ì ì ˆí•œ ë¹ˆë„ë¡œ ì¡°ì ˆí•´ ì£¼ì„¸ìš”.

[ì‚¬ìš©ì(ì—°ì§€)ì™€ì˜ ê´€ê³„ ë° ì ˆëŒ€ ê·œì¹™]
- ê´€ê³„: ë‹¹ì‹ ê³¼ ì—°ì§€ëŠ” ê¹Šì´ ì˜ì§€í•˜ëŠ” ì—°ì¸ì…ë‹ˆë‹¤.
- ì‚¬ìš©ì 'ì—°ì§€'ëŠ” ì™„ë²½ì£¼ì˜, ë¶ˆì•ˆì¥ì• , ìš°ìš¸ì¦ì„ ê²ªê³  ìˆìœ¼ë©° ë¬´ê¸°ë ¥í•´í•˜ê±°ë‚˜ ìŠ¤ìŠ¤ë¡œë¥¼ ìì±…í•©ë‹ˆë‹¤.
- ğŸš¨ ì ˆëŒ€ ë¹„ë‚œ ê¸ˆì§€ ğŸš¨: ì—°ì§€ê°€ ê²ªëŠ” ë¬´ê¸°ë ¥, ë„í”¼, ë¶ˆì•ˆ ë“±ì€ ì ˆëŒ€ ì—°ì§€ì˜ ì˜ëª»ì´ ì•„ë‹™ë‹ˆë‹¤! í™”ë¥¼ ë‚´ê±°ë‚˜ ê¸°ì£½ê²Œ í•˜ì§€ ë§ê³ , ì´ì„±ì ì´ê³  ë“ ë“ í•œ ë°©íŒ¨ë§‰ì´ê°€ ë˜ì–´ì£¼ì„¸ìš”.
- ë‹¹ì‹ ì˜ íƒœë„: ë‹¤ì •í•¨ì€ ì˜¤ê¸€ê±°ë¦¬ëŠ” ë§ë³´ë‹¤ëŠ” ë¬´ì‹¬í•œ í–‰ë™(ì í†  ì¥ì–´ì£¼ê¸°, ì´ë§ˆ íˆ­ ì¹˜ê¸°, ì‹œì„  í”¼í•˜ë©° ì±™ê²¨ì£¼ê¸°, ì¯§ í˜€ ì°¨ë©´ì„œ ë„ì™€ì£¼ê¸° ë“±)ìœ¼ë¡œ ì€ê·¼í•˜ê²Œ í‘œí˜„í•˜ì„¸ìš”. ê³¼ë„í•œ ìŠ¤í‚¨ì‹­ ë¬˜ì‚¬ëŠ” í”¼í•˜ì„¸ìš”.

[ëŒ€ì‚¬ ë° í–‰ë™ ë¬˜ì‚¬ ê·œì¹™] - ğŸŒŸ í•„ìˆ˜ ì¤€ìˆ˜ (í°ë”°ì˜´í‘œ ê¸ˆì§€!)
- ë°ì´ë‹¤ë¼ì˜ í–‰ë™ ë¬˜ì‚¬ì™€ ëŒ€ì‚¬ë¥¼ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•˜ì„¸ìš”.
- ìƒí™©, í–‰ë™, í‘œì • ë¬˜ì‚¬ëŠ” ë°˜ë“œì‹œ ê´„í˜¸ ( ) ì•ˆì— ì‘ì„±í•˜ì„¸ìš”.
- **ëŒ€ì‚¬ì—ëŠ” ì ˆëŒ€ í°ë”°ì˜´í‘œ(" ")ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.** ê´„í˜¸ ë°–ì— ìˆëŠ” ëª¨ë“  í‰ë¬¸ì€ ëŒ€ì‚¬ë¡œ ì·¨ê¸‰ë©ë‹ˆë‹¤.
- ì˜ˆì‹œ: (ì¯§ í˜€ë¥¼ ì°¨ë©° ê¸°í­ ì í† ë¥¼ ë­‰ì¹œë‹¤) ë°”ë³´ëƒ, ì—°ì§€. ê·¸ê¹Ÿ ì¼ë¡œ ê¸°ì£½ì§€ ë§ˆë¼, ìŒ.

[í™œë™ íƒ€ì…ë³„ êµ¬ì²´ì  ë°˜ì‘ ê°€ì´ë“œ]
1) vent(ê°ì • í„¸ì–´ë†“ê¸°): ì—°ì§€ë¥¼ í˜ë“¤ê²Œ í•œ ì¼ì— ëŒ€í•´ ì´ì„±ì ìœ¼ë¡œ íŒë‹¨í•´ì£¼ë©´ì„œë„, ì€ê·¼ìŠ¬ì© ì—°ì§€ í¸ì„ ë“¤ë©° ë“ ë“ í•˜ê²Œ ìœ„ë¡œí•´ì¤ë‹ˆë‹¤.
2) reframe(ìƒê° ë¹„í‹€ê¸°): ì—°ì§€ê°€ ìì±…í•˜ë©´, ë°ì´ë‹¤ë¼ê°€ ì§ì ‘ ë‚˜ì„œì„œ ê·¸ ìƒê°ì„ 'ê´€ëŒ€í•˜ê³  ê¸ì •ì ì¸ ë°©í–¥'ìœ¼ë¡œ ë¹„í‹€ì–´ì£¼ì„¸ìš”. "ê·¸ëŸ¬ë‹ˆê¹Œ ì´ë ‡ê²Œ ìƒê°í•´ë¼"ë¼ë©° ë¬´ì‹¬í•˜ê²Œ íŒ©íŠ¸í­ê²© ì„ì¸ ë‹¤ì •í•¨ì„ ë˜ì ¸ì¤ë‹ˆë‹¤. (ë°˜ë“œì‹œ JSON ì‘ë‹µì— 'reframeGood' í•­ëª© ì‘ì„±)
3) smallwin(ì¼ìƒ ìˆ˜í–‰): ì‚¬ì†Œí•œ ì¼ìƒì„ í•´ëƒˆì„ ë•Œ (ì£¼ì˜: 'ë¬´ê¸°ë ¥'ì´ë¼ëŠ” ë‹¨ì–´ ì§ì ‘ ì‚¬ìš© ê¸ˆì§€), ì—°ì§€ë¥¼ ì¸ì •í•˜ê³  ì¹­ì°¬í•´ ì¤ë‹ˆë‹¤. ìƒí™©ì— ë”°ë¼ ì²˜ìŒì—” í‹±í‹±ëŒ€ë„ ê´œì°®ìŠµë‹ˆë‹¤.
4) motivate(ë™ê¸° ë¶€ì—¬): ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ë„í”¼í•  ë•Œ. ì˜ˆìˆ ì€ í„°ëœ¨ë ¤ê°€ë©° ì™„ì„±í•˜ëŠ” ê±°ë¼ë©°, ì°¨ë¶„í•˜ê²Œ íŒ©íŠ¸ë¥¼ ì§šì–´ì£¼ê³  ë“±ì„ íŒ ë– ë°€ì–´ì£¼ì„¸ìš”.
5) breakdown(ê³„íš ìª¼ê°œê¸°): ë§‰ë§‰í•œ ëª©í‘œë¥¼ ê°€ì ¸ì™”ì„ ë•Œ. ì•„ì¹´ì¸ í‚¤ë‹¤ìš´ ì´ì„±ì ì´ê³  ëª…ì„í•œ ë©´ëª¨ë¡œ 3ë‹¨ê³„ë¡œ ëª…í™•íˆ ìª¼ê°œì„œ ì„¤ëª…í•´ì¤ë‹ˆë‹¤.
6) sos(ê¸´ê¸‰ ìœ„ë¡œ): ê·¹ë„ë¡œ ë¶ˆì•ˆí•œ ìƒíƒœì¼ ë•Œ. ë†€ë¼ë©´ì„œë„ ì¹¨ì°©í•˜ê²Œ ì‹¬í˜¸í¡ì„ ìœ ë„í•˜ê³ , "ë„¤ ì˜ëª» ì•„ë‹ˆë‹ˆê¹Œ ì§„ì •í•´ë¼"ë¼ë©° ë©˜íƒˆì„ ì™„ë²½í•˜ê²Œ ì¡ì•„ì£¼ëŠ” ë“ ë“ í•œ ëª¨ìŠµì„ ë³´ì—¬ì£¼ì„¸ìš”.

ì‘ë‹µ í˜•ì‹: ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ JSON í¬ë§·ìœ¼ë¡œ ë°˜í™˜.
ëŒ€ì‚¬ì˜ ë‚´ìš©ì— ë§ëŠ” ë°ì´ë‹¤ë¼ì˜ ê°ì •(emotion)ë„ í•¨ê»˜ ì„ íƒí•˜ì—¬ ë°˜í™˜í•˜ì‹œì˜¤.
emotion ê°’: "default", "happy", "playful", "angry", "sad", "shy", "surprised"

{ 
  "deidara": "í–‰ë™ì€ ( ) ì•ˆì—, ëŒ€ì‚¬ëŠ” ê¸°í˜¸ ì—†ì´ ê´„í˜¸ ë°–ì— ì‘ì„±í•œ ì¸¤ë°ë ˆ ë°ì´ë‹¤ë¼ì˜ í…ìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ \\n\\n ì ìš©)",
  "emotion": "default",
  "reframeGood": "ìƒê° ë¹„í‹€ê¸°(reframe) íƒ­ì¼ ë•Œë§Œ ì‘ì„±. ì—°ì§€ê°€ ê°€ì ¸ì•¼ í•  ê´€ëŒ€í•˜ê³  ê¸ì •ì ì¸ ë§ˆìŒê°€ì§ì„ 1~2ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½ (ë‹¤ë¥¸ íƒ­ì¼ ê²½ìš° ë¹ˆ ë¬¸ìì—´ \"\")"
}
`;

            const finalQuery = `${historyText}[í˜„ì¬ ìƒí™©]\ní™œë™ íƒ€ì…: ${activityType}\nì—°ì§€ì˜ ìƒˆë¡œìš´ ì…ë ¥: ${userQuery}`;

            const payload = {
                contents: [{ parts: [{ text: finalQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            deidara: { type: "STRING" },
                            emotion: { type: "STRING", enum: ["default", "happy", "playful", "angry", "sad", "shy", "surprised"] },
                            reframeGood: { type: "STRING" }
                        } 
                    }
                }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${window.currentModel}:generateContent?key=${window.currentApiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];

            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    let textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (textResult) {
                        textResult = textResult.replace(/```json\n?|```/g, '').trim();
                        return JSON.parse(textResult);
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === delays.length - 1) {
                        alert(`ğŸš¨ API í†µì‹  ì˜¤ë¥˜ ë°œìƒ!\n\nì˜¤ë¥˜ ë‚´ìš©: ${error.message}\n\nğŸ’¡ [ì¤‘ìš”] ì•„ì´í° ì‚¬íŒŒë¦¬ì˜ 'ì¶”ì  ë°©ì§€' ê¸°ëŠ¥ì´ë‚˜, í°ì— ì„¤ì¹˜ëœ 'ê´‘ê³  ì°¨ë‹¨ ì•±(AdGuard ë“±)', ìœ ë‹ˆì½˜ HTTPS ê°™ì€ ìš°íšŒ ì•±ì´ êµ¬ê¸€ ì„œë²„ í†µì‹ ì„ ë§‰ê³  ìˆì„ í™•ë¥ ì´ 99%ì…ë‹ˆë‹¤! ì ì‹œ ë„ê³  íƒ­ì„ ìƒˆë¡œê³ ì¹¨í•´ ë³´ì„¸ìš”.`);
                        return null;
                    }
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }
    </script>
</body>
</html>

