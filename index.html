<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#09090b">
    <link rel="apple-touch-icon" href="./icon-192x192.png">

    <title>ì•„ì§€íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #000000; color: #fafafa; }
        
        .tab-btn {
            padding: 0.5rem 1.1rem;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease-in-out;
            color: #71717a;
            border: 1px solid transparent;
            background-color: transparent;
        }
        .tab-btn:hover {
            color: #a1a1aa;
            background-color: rgba(39, 39, 42, 0.4);
        }
        .tab-active {
            background-color: rgba(127, 29, 29, 0.2) !important;
            color: #facc15 !important;
            border-color: rgba(185, 28, 28, 0.3) !important;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.1);
        }

        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .akatsuki-gradient { background: linear-gradient(135deg, #09090b 0%, #180505 100%); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-black sm:p-4">

    <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500 overflow-y-auto hidden">
        <img id="login-profile" src="" class="w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-red-600 shadow-[0_0_30px_rgba(220,38,38,0.5)] mb-6 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'">
        <h2 class="text-2xl font-extrabold text-yellow-400 mb-2">ë§ˆìŒ ì•„ì§€íŠ¸ ì—°ê²° ì¤‘...</h2>
        
        <p class="text-zinc-400 text-sm mb-6 max-w-xs leading-relaxed">
            PCì™€ ëª¨ë°”ì¼ ë™ê¸°í™”ë¥¼ ìœ„í•´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•˜ë‹¤. ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ê³  ì–¼ë¥¸ ë¡œê·¸ì¸í•´ë¼, ìŒ!
        </p>
        
        <button id="btn-google-login" class="bg-white text-black px-6 py-3.5 rounded-full font-bold text-[15px] flex items-center gap-3 hover:bg-zinc-200 transition-colors shadow-lg active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
        </button>

        <button id="btn-skip-login" class="mt-6 text-zinc-500 text-sm underline decoration-zinc-600 hover:text-zinc-300 transition-colors">
            ë¡œê·¸ì¸ì´ ì•ˆ ëœë‹¤ë©´ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ì„œ ì‹œì‘ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
        </button>
    </div>

    <!-- âš™ï¸ í™˜ê²½ ì„¤ì • ëª¨ë‹¬ âš™ï¸ -->
    <div id="settings-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center p-6 transition-opacity">
        <div class="bg-zinc-900 border border-zinc-700 rounded-3xl w-full max-w-sm p-6 relative shadow-[0_0_50px_rgba(0,0,0,0.8)] fade-in">
            <button onclick="window.toggleSettings()" class="absolute top-4 right-4 text-zinc-400 hover:text-white transition-colors bg-zinc-800 rounded-full p-1">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            
            <h3 class="text-lg font-bold text-yellow-400 mb-1 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-zinc-300"></i> í™˜ê²½ ì„¤ì •
            </h3>
            <p class="text-xs text-zinc-400 mb-5">í†µì‹  ì¥ì¹˜ ë° ëŒ€í™” ì„¤ì •ì´ë‹¤. ìŒ!</p>
            
            <div class="space-y-4">
                <!-- API ë° ëª¨ë¸ ì„¤ì • -->
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800/80 shadow-inner">
                    <label class="block text-left text-[11px] text-zinc-400 mb-2 font-medium">Gemini API í‚¤ (Google AI Studio ë°œê¸‰)</label>
                    <input type="password" id="settings-api-key" class="w-full bg-zinc-900/80 text-zinc-100 border border-zinc-700/50 rounded-xl p-3 text-[14px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="AIzaSy...">
                    
                    <label class="block text-left text-[11px] text-zinc-400 mt-4 mb-2 font-medium">AI ë‘ë‡Œ ëª¨ë¸ ì„ íƒ</label>
                    <select id="settings-ai-model" class="w-full bg-zinc-900/80 text-zinc-100 border border-zinc-700/50 rounded-xl p-3 text-[14px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all shadow-inner appearance-none cursor-pointer">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (ê¸°ë³¸/ì•ˆì •ì )</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (ê³ ì„±ëŠ¥)</option>
                        <option value="gemini-3.0-flash">Gemini 3.0 Flash</option>
                    </select>

                    <div class="flex justify-between items-center mt-4">
                        <button onclick="window.open('https://aistudio.google.com/app/apikey', '_blank')" class="text-[11px] text-blue-400 hover:text-blue-300 underline underline-offset-4">API í‚¤ ë°œê¸‰ë°›ê¸°</button>
                        <div class="flex gap-2">
                            <button id="btn-test-api" class="bg-blue-600 hover:bg-blue-500 text-white text-[12px] px-3.5 py-1.5 rounded-xl transition-colors font-bold shadow-md">í†µì‹  í…ŒìŠ¤íŠ¸</button>
                            <button id="btn-save-settings-key" class="bg-zinc-700 hover:bg-zinc-600 text-white text-[12px] px-3.5 py-1.5 rounded-xl transition-colors font-bold shadow-md">ì„¤ì • ì €ì¥</button>
                        </div>
                    </div>
                    <p id="settings-key-status" class="text-left text-[11px] text-red-400 mt-3 hidden bg-red-950/30 p-2 rounded-lg border border-red-900/30">ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ì…ë ¥í•´ë¼, ìŒ!</p>
                </div>

                <!-- ğŸ†• ëŒ€í™” ê´€ë¦¬ (ì•± ë‚´ ë³´ê´€í•¨ ê¸°ëŠ¥) -->
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800/80 shadow-inner">
                    <label class="block text-left text-[11px] text-zinc-400 mb-2 font-medium">ëŒ€í™” ê´€ë¦¬ (í˜„ì¬ ì—´ë ¤ìˆëŠ” ë°© ê¸°ì¤€)</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button id="btn-archive-chat" class="bg-zinc-800 hover:bg-zinc-700 text-yellow-400 text-[12px] px-2 py-2.5 rounded-xl transition-colors border border-zinc-700 shadow-sm flex items-center justify-center gap-1.5 font-bold">
                            <i data-lucide="archive" class="w-3.5 h-3.5"></i> ëŒ€í™” ë³´ê´€í•˜ê¸°
                        </button>
                        <button onclick="window.openArchiveModal()" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-200 text-[12px] px-2 py-2.5 rounded-xl transition-colors border border-zinc-700 shadow-sm flex items-center justify-center gap-1.5 font-medium">
                            <i data-lucide="library" class="w-3.5 h-3.5"></i> ë³´ê´€í•¨ ë³´ê¸°
                        </button>
                    </div>
                    <button id="btn-clear-chat" class="w-full bg-red-950/40 hover:bg-red-900/60 text-red-400 text-[12px] px-3 py-2 rounded-xl transition-colors border border-red-900/50 shadow-sm flex items-center justify-center gap-1.5 font-medium mt-1">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> ëŒ€í™” ì˜êµ¬ ì‚­ì œ
                    </button>
                </div>

                <div class="flex justify-between items-center bg-black/40 p-4 rounded-2xl border border-zinc-800/80">
                    <span class="text-[12px] text-zinc-300 font-medium flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        <span id="settings-account-status">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</span>
                    </span>
                    <button id="btn-logout" class="text-[11px] text-red-400 bg-red-950/20 border border-red-900/40 hover:bg-red-900/40 px-3.5 py-1.5 rounded-xl transition-all hidden font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“¦ ë³´ê´€í•¨ ëª¨ë‹¬ (Archive Modal) -->
    <div id="archive-modal" class="fixed inset-0 z-[70] bg-black/90 backdrop-blur-md hidden flex-col items-center justify-center p-4 sm:p-6 transition-opacity">
        <div class="bg-zinc-950 border border-zinc-800 rounded-[2rem] w-full max-w-md h-[85vh] flex flex-col relative shadow-[0_0_50px_rgba(250,204,21,0.1)] fade-in">
            <header class="flex justify-between items-center p-5 border-b border-zinc-800/80 shrink-0">
                <h3 class="text-lg font-bold text-yellow-400 flex items-center gap-2">
                    <i data-lucide="library" class="w-5 h-5"></i> ë§ˆìŒ ë³´ê´€í•¨
                </h3>
                <button onclick="document.getElementById('archive-modal').classList.add('hidden'); document.getElementById('archive-modal').classList.remove('flex');" class="text-zinc-400 hover:text-white bg-zinc-900 rounded-full p-1.5 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </header>
            
            <div class="p-3 border-b border-zinc-800/50 shrink-0 flex items-center gap-2 bg-zinc-900/30">
                <label class="text-[12px] text-zinc-400 font-medium ml-1">ì£¼ì œ í•„í„°:</label>
                <select id="archive-tab-select" class="flex-1 bg-zinc-900 text-zinc-200 border border-zinc-700 rounded-lg px-3 py-1.5 text-[13px] focus:outline-none focus:border-yellow-500" onchange="window.renderArchive()">
                    <option value="all">ëª¨ë“  ëŒ€í™” ë³´ê¸°</option>
                    <option value="vent">ê°ì • í„¸ì–´ë†“ê¸°</option>
                    <option value="reframe">ìƒê° ë¹„í‹€ê¸°</option>
                    <option value="smallwin">ì¼ìƒ ìˆ˜í–‰</option>
                    <option value="motivate">ë™ê¸° ë¶€ì—¬</option>
                    <option value="breakdown">ê³„íš ìª¼ê°œê¸°</option>
                </select>
            </div>

            <!-- ë³´ê´€ëœ ëŒ€í™”ê°€ í‘œì‹œë  ì˜ì—­ -->
            <div id="archive-container" class="flex-1 overflow-y-auto p-4 sm:p-5 space-y-2 chat-scroll bg-zinc-950/50">
                <!-- JSì—ì„œ ì±„ì›Œì§ -->
            </div>
        </div>
    </div>

    <!-- App Container (ë©”ì¸ UI) -->
    <div class="bg-zinc-950 w-full max-w-md sm:rounded-[2.5rem] shadow-none sm:shadow-[0_0_50px_rgba(220,38,38,0.15)] overflow-hidden flex flex-col h-[100dvh] sm:h-[90vh] sm:max-h-[850px] border-0 sm:border border-zinc-800 relative">
        
        <header class="flex items-center justify-between p-4 sm:p-5 bg-zinc-950/80 backdrop-blur-xl border-b border-zinc-900/80 z-30 shrink-0">
            <div class="flex items-center gap-3.5">
                <div class="relative group cursor-pointer shrink-0" onclick="window.toggleSettings()" title="ì„¤ì • ë©”ë‰´ ì—´ê¸°">
                    <div class="absolute -inset-0.5 bg-gradient-to-tr from-yellow-500 to-red-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-300"></div>
                    <img id="ui-profile" src="" alt="ë°ì´ë‹¤ë¼ í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="relative w-11 h-11 sm:w-12 sm:h-12 rounded-full border-[1.5px] border-zinc-900 object-cover shadow-lg">
                    <div class="absolute -bottom-1 -right-1 bg-zinc-800 rounded-full p-1 border border-zinc-700 shadow-md group-hover:bg-zinc-700 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3 text-zinc-300"></i>
                    </div>
                </div>
                <div class="flex flex-col justify-center">
                    <h1 class="text-[17px] sm:text-[18px] font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 tracking-tight flex items-center gap-1.5 leading-tight">
                       ë°ì´ë‹¤ë¼
                        <i data-lucide="flame" class="w-4 h-4 text-red-500 fill-red-500 drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]"></i>
                    </h1>
                    <p class="text-[11px] sm:text-[12px] text-zinc-500 font-medium tracking-wide mt-0.5">ì˜ˆìˆ ì€ í­ë°œì´ë‹¤!</p>
                </div>
            </div>
        </header>

        <div class="relative h-44 sm:h-52 shrink-0 overflow-hidden flex justify-center items-end bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-red-950/20 via-zinc-950 to-zinc-950 border-b border-zinc-900/50">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-[0.15] mix-blend-overlay"></div>
            <img id="ui-standing" src="" alt="ë°ì´ë‹¤ë¼ ìŠ¤íƒ ë”©" onerror="this.src='https://placehold.co/400x400/18181b/ef4444/png?text=Standing'" class="h-[110%] sm:h-[120%] object-contain object-bottom relative z-10 transition-all duration-500 drop-shadow-[0_5px_15px_rgba(220,38,38,0.15)]">
            <div class="absolute bottom-0 w-full h-8 bg-gradient-to-t from-zinc-950 to-transparent z-20 pointer-events-none"></div>
        </div>

        <div class="bg-zinc-950 px-3 py-2.5 border-b border-zinc-900 shrink-0 z-20 shadow-[0_5px_15px_-10px_rgba(0,0,0,0.5)]">
            <nav class="flex gap-2 overflow-x-auto scrollbar-hide snap-x items-center pb-0.5">
                <button onclick="window.switchTab('vent')" id="tab-vent" class="tab-btn tab-active snap-start">ê°ì • í„¸ì–´ë†“ê¸°</button>
                <button onclick="window.switchTab('reframe')" id="tab-reframe" class="tab-btn snap-start">ìƒê° ë¹„í‹€ê¸°</button>
                <button onclick="window.switchTab('smallwin')" id="tab-smallwin" class="tab-btn snap-start">ì¼ìƒ ìˆ˜í–‰</button>
                <button onclick="window.switchTab('motivate')" id="tab-motivate" class="tab-btn snap-start">ë™ê¸° ë¶€ì—¬</button>
                <button onclick="window.switchTab('breakdown')" id="tab-breakdown" class="tab-btn snap-start flex items-center gap-1.5 pr-3">ê³„íš ìª¼ê°œê¸° <i data-lucide="sparkles" class="w-3.5 h-3.5 text-yellow-500"></i></button>
            </nav>
        </div>

        <main class="flex-1 overflow-y-auto p-4 sm:p-5 chat-scroll bg-zinc-950 flex flex-col gap-5 relative z-10 pb-6" id="chat-container">
            <div id="welcome-message-container" class="flex justify-center my-2 shrink-0">
                <div id="welcome-message" class="text-[11px] sm:text-xs text-yellow-200/80 bg-zinc-900/60 px-5 py-2.5 rounded-full border border-zinc-800 font-medium tracking-wide text-center">
                    <!-- JSë¡œ ë¬´ì‘ìœ„ ë©”ì‹œì§€ ì‚½ì… -->
                </div>
            </div>
        </main>

        <div class="p-4 sm:p-5 bg-zinc-950 border-t border-zinc-900 shrink-0 relative z-10 shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.8)] sm:rounded-b-[2.5rem]">
            <div id="form-vent" class="block fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì§€ê¸ˆ ëŠë¼ëŠ” ë¶€ì •ì ì¸ ê°ì •ì´ë‚˜ ê³ ë¯¼</label>
                <textarea id="input-vent" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì£¼ë³€ ì‚¬ëŒë“¤ì€ ë‹¤ ì˜í•˜ëŠ”ë° ë‚˜ë§Œ ë’¤ì²˜ì§€ëŠ” ê²ƒ ê°™ì•„ ë¶ˆì•ˆí•´..."></textarea>
            </div>
            <div id="form-reframe" class="hidden fade-in space-y-3">
                <div>
                    <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ìë™ì  ì‚¬ê³  (ë¶€ì •ì  ìƒê°)</label>
                    <input type="text" id="input-reframe-bad" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ë‚œ ëŠ˜ ê³„íšì„ ë¯¸ë£¨ê¸°ë§Œ í•´.">
                </div>
                <div>
                    <label class="block text-[11px] font-medium text-yellow-500/80 mb-1.5 ml-1">ê´€ëŒ€í•œ ìƒê° (ëŒ€ì•ˆì  ì‚¬ê³ )</label>
                    <input type="text" id="input-reframe-good" class="w-full bg-yellow-950/10 text-yellow-50 border border-yellow-900/30 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 transition-all placeholder:text-yellow-700/40 shadow-inner" placeholder="ì˜ˆ: ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ë¼. ì§€ê¸ˆë¶€í„° ë‹¤ì‹œ í•˜ë©´ ë¼.">
                </div>
            </div>
            <div id="form-smallwin" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì˜¤ëŠ˜ í•´ë‚¸ ì¼ìƒì´ë‚˜ ê³¼ì œ</label>
                <input type="text" id="input-smallwin" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3.5 text-[14px] focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì•½ ì±™ê²¨ ë¨¹ê¸°, ë°©ì²­ì†Œ 5ë¶„ í•˜ê¸°">
            </div>
            <div id="form-motivate" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1">ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ë„í”¼í•˜ê³  ìˆëŠ” ì¼</label>
                <textarea id="input-motivate" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ê¸°íšì„œ ì´ˆì•ˆì„ ì¨ì•¼ í•˜ëŠ”ë° ë¬´ì„œì›Œì„œ ì›¹ì„œí•‘ë§Œ í•´..."></textarea>
            </div>
            <div id="form-breakdown" class="hidden fade-in">
                <label class="block text-[11px] font-medium text-zinc-400 mb-1.5 ml-1 flex items-center gap-1.5">ë§‰ë§‰í•œ í° ëª©í‘œ (ì•„ì£¼ ì‘ê²Œ ìª¼ê°œë“œë¦½ë‹ˆë‹¤)</label>
                <textarea id="input-breakdown" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3.5 text-[14px] focus:outline-none focus:border-yellow-500/50 focus:ring-1 focus:ring-yellow-500/50 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: í¬íŠ¸í´ë¦¬ì˜¤ 10í˜ì´ì§€ ê¸°íší•˜ê¸°"></textarea>
            </div>

            <div class="flex items-center justify-between mt-3.5 pb-1 sm:pb-0">
                <div class="text-[10px] text-zinc-500 flex items-center gap-1.5 ml-1 bg-zinc-900 px-2 py-1 rounded-md border border-zinc-800">
                    <span class="relative flex h-1.5 w-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                    </span>
                    <span id="sync-status">ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘</span>
                </div>
                <button id="submit-btn" onclick="window.handleSubmit()" class="bg-gradient-to-r from-red-600 to-yellow-500 hover:from-red-500 hover:to-yellow-400 text-black px-6 py-3 rounded-full text-[14px] font-extrabold transition-all shadow-[0_5px_20px_rgba(239,68,68,0.3)] flex items-center gap-2 active:scale-95 shrink-0">
                    <span>ì „ì†¡</span>
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        function getSafeLocal(key, def) { try { return localStorage.getItem(key) || def; } catch(e) { return def; } }
        function setSafeLocal(key, val) { try { localStorage.setItem(key, val); } catch(e) { console.warn("ì €ì¥ ì°¨ë‹¨ë¨"); } }
        
        window.currentApiKey = getSafeLocal('myGeminiApiKey', "");
        window.currentModel = getSafeLocal('myGeminiModel', "gemini-1.5-flash");
        window.currentUser = null;
        window.currentTab = 'vent';
        window.allMessages = []; 
        window.initialWelcomeHtml = "";
        window.renderedMsgIds = new Set();
        
        window.updateIconsSafely = function() { try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch(e) {} }

        const DEIDARA_PROFILE_URL = "https://i.imgur.com/aiLjgOE.png"; 
        const DEIDARA_STANDING_IMAGES = {
            "default": "https://i.imgur.com/aiLjgOE.png", 
            "happy": "https://i.imgur.com/1AoN014.png",     
            "playful": "https://i.imgur.com/QoG1mDT.png",     
            "angry": "https://i.imgur.com/XBR6Kbb.png",     
            "sad": "https://i.imgur.com/kbzlEeN.png",
            "shy": "https://i.imgur.com/OoQmYv7.png",
            "surprised": "https://i.imgur.com/4stRzFr.png"
        };

        try {
            document.getElementById('ui-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('login-profile').src = DEIDARA_PROFILE_URL;
            document.getElementById('ui-standing').src = DEIDARA_STANDING_IMAGES["default"];
        } catch(e) {}

        function initWelcomeMessage() {
            const welcomeMessages = [
                "ì–´ì´, ì—°ì§€. ì˜¤ëŠ˜ì€ ë‚´ ìƒê° ì¢€ í–ˆëƒ, ìŒ?",
                "ê¸°ë‹¤ë¦¬ë‹¤ ì§€ë£¨í•´ì„œ ë‹¤ í„°ëœ¨ë ¤ë²„ë¦´ ë»”í–ˆë‹¤. ë¹¨ë¦¬ ë„¤ ì–˜ê¸°ë‚˜ í•´ë´ë¼, ìŒ.",
                "ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ˆë¼. ë„¤ ìš°ìš¸í•¨ì€ ë‚´ê°€ ë‹¤ ë‚ ë ¤ì¤„ í…Œë‹ˆê¹Œ, ìŒ!",
                "í¥, ì˜¤ëŠ˜ë„ ê°„ì‹ íˆ ë²„í‹°ê³  ì˜¨ ëª¨ì–‘ì´êµ°. ìˆ˜ê³ í–ˆë‹¤ê³ ëŠ” ì•ˆ í•˜ê² ë‹¤ë§Œ... ë­, ì™”ìœ¼ë©´ ëë‹¤.",
                "ë°”ë³´ê°™ì´ í˜¼ì ë•… íŒŒê³  ìˆì§€ ë§ê³  ë§í•´ë¼. ì§œì¦ ë‚˜ë‹ˆê¹Œ, ìŒ."
            ];
            const welcomeEl = document.getElementById('welcome-message');
            const welcomeContainer = document.getElementById('welcome-message-container');
            if(welcomeEl && welcomeContainer) {
                welcomeEl.innerText = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                window.initialWelcomeHtml = welcomeContainer.outerHTML;
            }
            window.updateIconsSafely();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWelcomeMessage);
        } else {
            initWelcomeMessage();
        }

        // ë³´ê´€í•¨ ëª¨ë‹¬ ì—´ê¸° ë° ë Œë”ë§ í•¨ìˆ˜
        window.openArchiveModal = function() {
            document.getElementById('settings-modal').classList.add('hidden');
            document.getElementById('settings-modal').classList.remove('flex');
            
            const modal = document.getElementById('archive-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            window.renderArchive();
        };

        window.renderArchive = function() {
            const container = document.getElementById('archive-container');
            const filterTab = document.getElementById('archive-tab-select').value;
            container.innerHTML = '';
            
            // ë³´ê´€ëœ(isArchivedê°€ trueì¸) ë©”ì‹œì§€ë§Œ í•„í„°ë§
            let archivedMsgs = window.allMessages.filter(m => m.isArchived);
            
            if (filterTab !== 'all') {
                archivedMsgs = archivedMsgs.filter(m => (m.tab || 'vent') === filterTab);
            }
            
            if (archivedMsgs.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-zinc-500 mt-10"><i data-lucide="inbox" class="w-10 h-10 mb-3 opacity-50"></i><p class="text-sm font-medium">ë³´ê´€ëœ ëŒ€í™”ê°€ ì—†ë‹¤, ìŒ!</p></div>';
                window.updateIconsSafely();
                return;
            }

            let lastDateString = "";
            archivedMsgs.forEach(msg => {
                const msgDate = new Date(msg.timestamp);
                const dateString = msgDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                
                if (dateString !== lastDateString) {
                    container.innerHTML += `<div class="flex justify-center my-4"><div class="text-[10.5px] text-zinc-400 bg-zinc-900/80 px-3.5 py-1 rounded-full border border-zinc-800">${dateString}</div></div>`;
                    lastDateString = dateString;
                }

                const isUser = msg.role === 'user';
                const sender = isUser ? 'ì—°ì§€' : 'ë°ì´ë‹¤ë¼';
                const color = isUser ? 'text-zinc-300' : 'text-red-400';
                const bg = isUser ? 'bg-zinc-800/40 border border-zinc-700/30' : 'bg-red-950/10 border border-red-900/20';
                const align = isUser ? 'items-end' : 'items-start';
                
                let html = `<div class="flex flex-col ${align} w-full mb-3">
                                <div class="p-3.5 rounded-2xl w-[90%] ${bg}">
                                    <div class="text-[10px] font-extrabold ${color} mb-1.5 flex items-center gap-1">
                                        ${isUser ? '<i data-lucide="user" class="w-3 h-3"></i>' : '<i data-lucide="flame" class="w-3 h-3"></i>'} ${sender}
                                    </div>
                                    <div class="text-[13px] text-zinc-200 leading-relaxed">${msg.text.replace(/\n/g, '<br>')}</div>`;
                
                if (msg.isReframe) {
                    html += `<div class="mt-2.5 pt-2.5 border-t border-zinc-700/50 text-[13px] text-yellow-400 font-bold leading-relaxed">ğŸ’¡ ëŒ€ì•ˆì  ì‚¬ê³ :<br>${msg.reframeGood}</div>`;
                }
                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
            window.updateIconsSafely();
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if(typeof window.handleSubmit === 'function') window.handleSubmit();
                    }
                });
            });

            const btnTestApi = document.getElementById('btn-test-api');
            if(btnTestApi) {
                btnTestApi.addEventListener('click', async () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    if(key.length < 30) {
                        alert("í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤! ë³µì‚¬ê°€ ëœ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    btnTestApi.innerText = "í™•ì¸ ì¤‘...";
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({contents:[{parts:[{text:"hi"}]}]})
                        });
                        if(res.ok) {
                            alert("âœ… ì—°ê²° ì„±ê³µ! í°ì—ì„œë„ APIê°€ ì™„ë²½í•˜ê²Œ ì‘ë™í•©ë‹ˆë‹¤. ì˜†ì— [ì„¤ì • ì €ì¥] ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
                        } else {
                            const err = await res.json();
                            alert(`âŒ ì—°ê²° ì‹¤íŒ¨ (í‚¤ ì˜¤ë¥˜ ì˜ì‹¬)\nì´ìœ : ${err.error?.message}\n\nğŸ’¡ ë³µì‚¬ ì¤‘ ë„ì–´ì“°ê¸°ê°€ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”!`);
                        }
                    } catch(e) {
                        alert(`âŒ ì—°ê²° ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ë¨!)\nì´ìœ : ${e.message}\n\nğŸ’¡ í°ì— ì„¤ì¹˜ëœ 'ê´‘ê³  ì°¨ë‹¨ ì•±(AdGuard ë“±)'ì´ë‚˜ 'ìœ ë‹ˆì½˜ HTTPS', 'ì‚¬íŒŒë¦¬ ë³´ì•ˆ ì„¤ì •'ì´ êµ¬ê¸€ AIì™€ì˜ í†µì‹ ì„ ê°•ì œë¡œ ë§‰ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ ë„ê³  ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”!`);
                    }
                    btnTestApi.innerText = "í†µì‹  í…ŒìŠ¤íŠ¸";
                });
            }

            const btnSaveKey = document.getElementById('btn-save-settings-key');
            if(btnSaveKey) {
                btnSaveKey.addEventListener('click', () => {
                    const key = document.getElementById('settings-api-key').value.trim();
                    const model = document.getElementById('settings-ai-model').value;
                    const keyStatusMsg = document.getElementById('settings-key-status');
                    
                    if(key.length > 30) {
                        setSafeLocal('myGeminiApiKey', key);
                        setSafeLocal('myGeminiModel', model);
                        window.currentApiKey = key;
                        window.currentModel = model;
                        
                        btnSaveKey.innerText = "ì €ì¥ ì™„ë£Œ!";
                        btnSaveKey.classList.remove('bg-zinc-700', 'hover:bg-zinc-600');
                        btnSaveKey.classList.add('bg-green-600');
                        keyStatusMsg.classList.add('hidden');
                        
                        setTimeout(() => window.toggleSettings(), 800);
                    } else {
                        keyStatusMsg.innerText = "ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ë¼, ìŒ!";
                        keyStatusMsg.classList.remove('hidden');
                    }
                });
            }
        });

        // íƒ­ ë³„ ëŒ€í™”ì°½ UI ì—…ë°ì´íŠ¸ (ë³´ê´€ë˜ì§€ ì•Šì€ ë©”ì‹œì§€ë§Œ ë³´ì—¬ì¤Œ)
        window.updateChatUI = function() {
            const chatContainer = document.getElementById('chat-container');
            if(!chatContainer) return;

            const loadingEl = document.querySelector('div[id^="loading-"]');
            const loadingHtml = loadingEl ? loadingEl.outerHTML : '';

            chatContainer.innerHTML = '';
            if (window.initialWelcomeHtml) {
                chatContainer.insertAdjacentHTML('beforeend', window.initialWelcomeHtml);
            }
            window.renderedMsgIds.clear();

            // í˜„ì¬ íƒ­ì˜ ë©”ì‹œì§€ ì¤‘ 'ë³´ê´€ë˜ì§€ ì•Šì€(!isArchived)' ë©”ì‹œì§€ë§Œ í•„í„°ë§
            const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab && !m.isArchived);
            let lastDateString = "";
            
            tabMsgs.forEach(msg => {
                const msgDate = new Date(msg.timestamp);
                const dateString = msgDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                
                if (dateString !== lastDateString) {
                    const divider = document.createElement('div');
                    divider.className = "flex justify-center my-5 shrink-0 w-full fade-in";
                    divider.innerHTML = `<div class="text-[10.5px] sm:text-[11.5px] text-zinc-500 bg-zinc-900/80 px-4 py-1.5 rounded-full border border-zinc-800/80 font-medium tracking-wide shadow-sm">${dateString}</div>`;
                    chatContainer.appendChild(divider);
                    lastDateString = dateString;
                }

                window.renderedMsgIds.add(msg.id);
                if (msg.role === 'user') {
                    renderUserMessage(msg.text, msg.isReframe, msg.reframeGood, true);
                } else if (msg.role === 'deidara') {
                    renderDeidaraMessage(msg.text, true);
                }
            });

            if (loadingHtml) chatContainer.insertAdjacentHTML('beforeend', loadingHtml);

            scrollToBottom();

            const lastDeidara = [...tabMsgs].reverse().find(m => m.role === 'deidara');
            if (lastDeidara && lastDeidara.emotion) {
                updateStandingImage(lastDeidara.emotion);
            } else {
                updateStandingImage('default');
            }
            window.updateIconsSafely();
        };

        window.toggleSettings = function() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                if (window.currentApiKey) {
                    document.getElementById('settings-api-key').value = window.currentApiKey;
                    const btn = document.getElementById('btn-save-settings-key');
                    if(btn) {
                        btn.innerText = "ì €ì¥ë¨";
                        btn.classList.add('bg-green-600');
                        btn.classList.remove('bg-zinc-700');
                    }
                }
                document.getElementById('settings-ai-model').value = window.currentModel;
                window.updateIconsSafely();
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        window.switchTab = function(tab) {
            window.currentTab = tab;
            ['vent', 'reframe', 'smallwin', 'motivate', 'breakdown'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(btn) btn.classList.remove('tab-active'); 
                const form = document.getElementById(`form-${t}`);
                if(form) { form.classList.add('hidden'); form.classList.remove('block'); }
            });
            const activeBtn = document.getElementById(`tab-${tab}`);
            if(activeBtn) activeBtn.classList.add('tab-active');
            
            const activeForm = document.getElementById(`form-${tab}`);
            if(activeForm) { activeForm.classList.remove('hidden'); activeForm.classList.add('block'); }
            
            window.updateChatUI();
        };

        function scrollToBottom() { const c = document.getElementById('chat-container'); if(c) c.scrollTo({ top: c.scrollHeight, behavior: 'smooth' }); }

        function renderUserMessage(text, isReframe = false, reframeGood = '', silent = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex flex-col items-end gap-2 fade-in mt-3 mb-1 w-full';
            if (isReframe) {
                msgDiv.innerHTML = `
                    <div class="bg-zinc-800/60 border border-zinc-700/50 text-zinc-400 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tr-sm text-[13px] sm:text-[14px] max-w-[85%] line-through opacity-80">${text}</div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-black font-bold px-4 sm:px-5 py-3 sm:py-3.5 rounded-[1.25rem] rounded-br-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-md leading-relaxed mt-1">${reframeGood}</div>
                `;
            } else {
                msgDiv.innerHTML = `<div class="bg-red-950/40 border border-red-900/50 text-red-50 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tr-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-sm leading-relaxed tracking-wide">${text}</div>`;
            }
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            if(!silent) scrollToBottom();
        }

        function renderDeidaraMessage(text, silent = false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3 fade-in mt-3 mb-1 w-full';
            const formattedText = text.replace(/\n/g, '<br>');

            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" alt="í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full object-cover shrink-0 border border-zinc-700 shadow-sm mt-0.5">
                <div class="flex flex-col gap-1 max-w-[85%] sm:max-w-[82%]">
                    <span class="text-[11px] font-bold text-red-500 ml-1 tracking-wider">ë°ì´ë‹¤ë¼</span>
                    <div class="bg-zinc-900 border border-zinc-800 shadow-md text-zinc-100 px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tl-sm text-[14px] sm:text-[15px] leading-relaxed tracking-wide font-medium break-words">
                        ${formattedText}
                    </div>
                </div>
            `;
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            if(!silent) scrollToBottom();
            window.updateIconsSafely();
        }

        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = loadingId;
            msgDiv.className = 'flex items-start gap-3 fade-in mt-3 mb-1';
            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full object-cover shrink-0 border border-zinc-700 opacity-50 grayscale mt-0.5">
                <div class="bg-zinc-900 border border-zinc-800 shadow-sm px-4 sm:px-5 py-3 rounded-[1.25rem] rounded-tl-sm flex gap-2 items-center h-[46px]">
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-1.5 h-1.5 bg-zinc-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            const c = document.getElementById('chat-container');
            if(c) c.appendChild(msgDiv);
            scrollToBottom();
            return loadingId;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }

        function updateStandingImage(emotion) {
            const imgElement = document.getElementById('ui-standing');
            if(!imgElement) return;
            const targetSrc = DEIDARA_STANDING_IMAGES[emotion] || DEIDARA_STANDING_IMAGES["default"];
            if(imgElement.src.includes(targetSrc.replace('https://', ''))) return;
            imgElement.style.opacity = 0;
            setTimeout(() => { imgElement.src = targetSrc; imgElement.style.opacity = 1; }, 300);
        }

    </script>

    <!-- Firebase í†µì‹  ëª¨ë“ˆ ë° ë°© ì´ˆê¸°í™”/ë³´ê´€ ê¸°ëŠ¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDA-l-otOgxEJHS4nndJg-G9IYKlf-1T3I",
            authDomain: "deidara-70f6e.firebaseapp.com",
            projectId: "deidara-70f6e",
            storageBucket: "deidara-70f6e.firebasestorage.app",
            messagingSenderId: "183278137031",
            appId: "1:183278137031:web:8fbc89a6b70946c794d8e2",
            measurementId: "G-48XSYZ5F6L"
        };

        let app, auth, db, provider;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            provider = new GoogleAuthProvider();
        } catch(e) { console.error("Firebase ë¡œë“œ ì‹¤íŒ¨"); }

        const appId = 'deidara-mind-app'; 

        // ğŸ“¥ [ê¸°ëŠ¥ ì¶”ê°€] ì•± ë‚´ ë³´ê´€í•¨ì— ë„£ê¸° (í˜„ì¬ íƒ­ ë©”ì‹œì§€ë§Œ)
        document.addEventListener('DOMContentLoaded', () => {
            const btnArchive = document.getElementById('btn-archive-chat');
            if(btnArchive) {
                btnArchive.addEventListener('click', async () => {
                    const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab && !m.isArchived);
                    if (tabMsgs.length === 0) {
                        alert("í˜„ì¬ ë°©ì— ë³´ê´€í•  ìƒˆ ëŒ€í™”ê°€ ì—†ë‹¤, ìŒ!");
                        return;
                    }
                    if (confirm("í˜„ì¬ ëŒ€í™”ë“¤ì„ 'ë³´ê´€í•¨'ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê² ëƒ, ìŒ?\n(ë°©ì€ ê¹¨ë—í•˜ê²Œ ë¹„ì›Œì§€ê³ , ëŒ€í™”ëŠ” ë³´ê´€í•¨ì—ì„œë§Œ ë³¼ ìˆ˜ ìˆë‹¤!)")) {
                        if (db && window.currentUser) {
                            try {
                                btnArchive.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ë³´ê´€ ì¤‘...';
                                window.updateIconsSafely();
                                
                                for (const m of tabMsgs) {
                                    if (!m.id.startsWith('off-')) {
                                        // Firestoreì˜ ë¬¸ì„œì— isArchived í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                                        await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats', m.id), { isArchived: true });
                                    }
                                }
                                
                                btnArchive.innerHTML = '<i data-lucide="archive" class="w-3.5 h-3.5"></i> ëŒ€í™” ë³´ê´€í•˜ê¸°';
                                window.updateIconsSafely();
                                alert("ë³´ê´€í•¨ì— ì•ˆì „í•˜ê²Œ ë„£ì–´ë’€ë‹¤, ìŒ!");
                                window.toggleSettings();
                            } catch (e) {
                                console.error("Archive Error: ", e);
                                alert("ë³´ê´€ ì¤‘ì— ì—ëŸ¬ê°€ ë‚¬ë‹¤, ìŒ!");
                                btnArchive.innerHTML = '<i data-lucide="archive" class="w-3.5 h-3.5"></i> ëŒ€í™” ë³´ê´€í•˜ê¸°';
                            }
                        } else {
                            // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì²˜ë¦¬
                            tabMsgs.forEach(m => m.isArchived = true);
                            window.updateChatUI();
                            alert("ë³´ê´€í•¨ì— ì•ˆì „í•˜ê²Œ ë„£ì–´ë’€ë‹¤, ìŒ! (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)");
                            window.toggleSettings();
                        }
                    }
                });
            }
        });

        // ğŸ—‘ï¸ ë°© ì´ˆê¸°í™” (ì˜êµ¬ ì‚­ì œ) ë²„íŠ¼ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const btnClear = document.getElementById('btn-clear-chat');
            if(btnClear) {
                btnClear.addEventListener('click', async () => {
                    const tabMsgs = window.allMessages.filter(m => (m.tab || 'vent') === window.currentTab && !m.isArchived);
                    if (tabMsgs.length === 0) {
                        alert("ì´ë¯¸ ë°©ì´ í…… ë¹„ì–´ìˆë‹¤, ìŒ!");
                        return;
                    }
                    if (confirm("ì´ ë°©ì˜ ëª¨ë“  ëŒ€í™”ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•  ê±°ëƒ, ìŒ?\n(ë³µêµ¬í•  ìˆ˜ ì—†ë‹¤. ê°„ì§í•˜ê³  ì‹¶ë‹¤ë©´ 'ëŒ€í™” ë³´ê´€í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ë¼!)")) {
                        if (db && window.currentUser) {
                            try {
                                btnClear.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ì§€ìš°ëŠ” ì¤‘...';
                                window.updateIconsSafely();
                                
                                for (const m of tabMsgs) {
                                    if (!m.id.startsWith('off-')) {
                                        await deleteDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats', m.id));
                                    }
                                }
                                
                                btnClear.innerHTML = '<i data-lucide="trash-2" class="w-3.5 h-3.5"></i> ëŒ€í™” ì˜êµ¬ ì‚­ì œ';
                                window.updateIconsSafely();
                                alert("ê¹”ë”í•˜ê²Œ í„°ëœ¨ë ¤ë²„ë ¸ë‹¤, ìŒ!");
                                window.toggleSettings();
                            } catch (e) {
                                console.error("Delete Error: ", e);
                                alert("ì§€ìš°ëŠ” ì¤‘ì— ì—ëŸ¬ê°€ ë‚¬ë‹¤, ìŒ!");
                            }
                        } else {
                            window.allMessages = window.allMessages.filter(m => !((m.tab || 'vent') === window.currentTab && !m.isArchived));
                            window.updateChatUI();
                            alert("ê¹”ë”í•˜ê²Œ í„°ëœ¨ë ¤ë²„ë ¸ë‹¤, ìŒ! (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)");
                            window.toggleSettings();
                        }
                    }
                });
            }
        });

        const btnLogout = document.getElementById('btn-logout');
        if(btnLogout) {
            btnLogout.addEventListener('click', () => {
                if(confirm("ê¸°ë¡ ë™ê¸°í™”ë¥¼ ë©ˆì¶”ê³  ë¡œê·¸ì•„ì›ƒí•  ê±°ëƒ, ìŒ?")) {
                    if(auth) signOut(auth).then(() => window.location.reload());
                }
            });
        }

        const isAppBrowser = navigator.userAgent.match(/kakaotalk|instagram|naver|line/i);
        const overlay = document.getElementById('login-overlay');
        
        if (!isAppBrowser) {
            const btnLogin = document.getElementById('btn-google-login');
            if(btnLogin) {
                btnLogin.addEventListener('click', async () => {
                    const originalHtml = btnLogin.innerHTML;
                    if (window.location.protocol === 'file:') {
                        alert("[ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì¤‘]\n\nì»´í“¨í„°ì— ë‹¤ìš´ë¡œë“œëœ íŒŒì¼(file://)ì—ì„œëŠ” êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.\nGitHub Pages ë“±ì— ì—…ë¡œë“œí•œ í›„ ì ‘ì†í•´ì£¼ì„¸ìš”!");
                        return;
                    }

                    btnLogin.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...';
                    window.updateIconsSafely();
                    btnLogin.classList.add('opacity-50', 'pointer-events-none');

                    try {
                        if(!auth) throw new Error("Firebase auth not initialized");
                        const result = await signInWithPopup(auth, provider);
                        window.currentUser = result.user;
                        
                        document.getElementById('sync-status').innerText = 'ë™ê¸°í™” ì¤‘';
                        document.getElementById('settings-account-status').innerText = 'êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
                        document.getElementById('btn-logout').classList.remove('hidden');
                        
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 500);
                        loadChatHistory();

                    } catch (error) {
                        console.error("Login Error:", error);
                        btnLogin.innerHTML = originalHtml;
                        btnLogin.classList.remove('opacity-50', 'pointer-events-none');
                        window.updateIconsSafely();
                        
                        if (error.code === 'auth/unauthorized-domain') {
                            alert(`[ë„ë©”ì¸ ìŠ¹ì¸ ì˜¤ë¥˜!]\n\níŒŒì´ì–´ë² ì´ìŠ¤ì— ë‹¤ìŒ ì£¼ì†Œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:\n[ ${window.location.hostname} ]\n\nFirebase ì½˜ì†” -> Authentication -> Settings -> ìŠ¹ì¸ëœ ë„ë©”ì¸ì— ìœ„ ì£¼ì†Œë¥¼ ì •í™•íˆ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
                        } else if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                            alert("ë¡œê·¸ì¸ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                        }
                    }
                });
            }
        }

        if(auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    document.getElementById('sync-status').innerText = 'ë™ê¸°í™” ì¤‘';
                    document.getElementById('settings-account-status').innerText = 'êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
                    document.getElementById('btn-logout').classList.remove('hidden');
                    
                    if(overlay) overlay.style.display = 'none';
                    loadChatHistory();
                } else if (!isAppBrowser && overlay) {
                    window.currentUser = null;
                    document.getElementById('sync-status').innerText = 'ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘';
                    document.getElementById('settings-account-status').innerText = 'ì˜¤í”„ë¼ì¸ (ë™ê¸°í™” ì•ˆë¨)';
                    document.getElementById('btn-logout').classList.add('hidden');

                    overlay.classList.remove('hidden');
                    overlay.style.display = 'flex';
                    setTimeout(() => overlay.style.opacity = '1', 10);
                }
            });
        }

        function loadChatHistory() {
            if (!db || !window.currentUser) return;
            try {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                onSnapshot(chatsRef, (snapshot) => {
                    window.allMessages = [];
                    snapshot.forEach(doc => window.allMessages.push({ id: doc.id, ...doc.data() }));
                    window.allMessages.sort((a, b) => a.timestamp - b.timestamp);
                    window.updateChatUI();
                    
                    // ë§Œì•½ ë³´ê´€í•¨ ëª¨ë‹¬ì´ ì—´ë ¤ìˆë‹¤ë©´ ë³´ê´€í•¨ë„ ì¦‰ì‹œ ë¦¬ë Œë”ë§
                    const archiveModal = document.getElementById('archive-modal');
                    if(archiveModal && !archiveModal.classList.contains('hidden')) {
                        window.renderArchive();
                    }
                }, (error) => console.error("Firestore Error:", error));
            } catch(e) {}
        }

        async function saveMessage(role, text, isReframe = false, reframeGood = '', emotion = 'default', targetTab = 'vent') {
            if (db && window.currentUser) {
                const chatsRef = collection(db, 'artifacts', appId, 'users', window.currentUser.uid, 'chats');
                // ìƒˆ ë©”ì‹œì§€ëŠ” isArchivedê°€ ê¸°ë³¸ì ìœ¼ë¡œ false/undefined ìƒíƒœë¡œ ì €ì¥ë©ë‹ˆë‹¤.
                await addDoc(chatsRef, { role, text, isReframe, reframeGood, emotion, tab: targetTab, timestamp: Date.now() });
            } else {
                window.allMessages.push({ id: 'off-'+Date.now()+Math.random(), role, text, isReframe, reframeGood, emotion, tab: targetTab, timestamp: Date.now() });
                window.updateChatUI();
            }
        }

        window.handleSubmit = async function() {
            if (!window.currentApiKey) {
                window.toggleSettings();
                const statusMsg = document.getElementById('settings-key-status');
                statusMsg.innerText = "í†µì‹ ì„ ìœ„í•´ API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•´ë¼, ìŒ!";
                statusMsg.classList.remove('hidden');
                return;
            }

            if (!window.currentUser) {
                const syncStatus = document.getElementById('sync-status');
                if (syncStatus && syncStatus.innerText.includes('ì˜¤í”„ë¼ì¸')) {
                    // í†µê³¼
                } else {
                    alert("êµ¬ê¸€ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”!");
                    return;
                }
            }

            const btn = document.getElementById('submit-btn');
            let userText = "", logText = "", reframeGood = "";
            const activeTabWhenSubmitted = window.currentTab;

            if (activeTabWhenSubmitted === 'vent') {
                const input = document.getElementById('input-vent');
                if (!input.value.trim()) return;
                userText = input.value; logText = input.value;
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'reframe') {
                const inputBad = document.getElementById('input-reframe-bad');
                const inputGood = document.getElementById('input-reframe-good');
                if (!inputBad.value.trim() || !inputGood.value.trim()) return;
                userText = `ë¶€ì •ì  ìƒê°: ${inputBad.value} -> ê´€ëŒ€í•œ ìƒê°: ${inputGood.value}`;
                logText = inputBad.value; reframeGood = inputGood.value;
                inputBad.value = inputGood.value = ''; await saveMessage('user', logText, true, reframeGood, 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'smallwin') {
                const input = document.getElementById('input-smallwin');
                if (!input.value.trim()) return;
                userText = `ì˜¤ëŠ˜ í•´ë‚¸ ì¼: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'motivate') {
                const input = document.getElementById('input-motivate');
                if (!input.value.trim()) return;
                userText = `ë„í”¼í•˜ê³  ìˆëŠ” ê³¼ì œ/ì¼: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            } else if (activeTabWhenSubmitted === 'breakdown') {
                const input = document.getElementById('input-breakdown');
                if (!input.value.trim()) return;
                userText = `ë§‰ë§‰í•œ í° ëª©í‘œ: ${input.value} (ëª©í‘œ ìª¼ê°œê¸° ìš”ì²­)`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText, false, '', 'default', activeTabWhenSubmitted);
            }

            if(btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                window.updateIconsSafely();
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'scale-95');
            }
            
            const loadingId = window.showLoading();
            const aiResponse = await callGeminiAPI(userText, activeTabWhenSubmitted);
            window.removeLoading(loadingId);
            
            if(btn) {
                btn.innerHTML = '<span>ì „ì†¡</span><i data-lucide="send" class="w-4 h-4"></i>';
                window.updateIconsSafely();
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'scale-95');
            }

            if (aiResponse && aiResponse.deidara) {
                const emotion = aiResponse.emotion || "default";
                await saveMessage('deidara', aiResponse.deidara, false, '', emotion, activeTabWhenSubmitted);
            } else {
                await saveMessage('deidara', "í†µì‹  ì¥ì¹˜ê°€ í„°ì ¸ë²„ë ¸ì–ì•„! í° ì„¤ì •(í†±ë‹ˆë°”í€´)ì—ì„œ API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ê±°ë‚˜, ê´‘ê³  ì°¨ë‹¨ ì•±ì„ êº¼ë´ë¼, ìŒ!", false, '', 'angry', activeTabWhenSubmitted);
            }
        };

        async function callGeminiAPI(userQuery, activityType) {
            // [ê¸°ì–µë ¥] 'ë³´ê´€ë˜ì§€ ì•Šì€(!m.isArchived)' í˜„ì¬ íƒ­ì˜ ë©”ì‹œì§€ë“¤ë§Œ ìµœê·¼ 12ê°œ ê°€ì ¸ì™€ì„œ ê¸°ì–µí•˜ê²Œ í•©ë‹ˆë‹¤!
            const historyMsgs = window.allMessages.filter(m => (m.tab || 'vent') === activityType && !m.isArchived).slice(-12);
            let historyText = "[ì´ì „ ëŒ€í™” íë¦„]\n";
            if (historyMsgs.length === 0) {
                historyText += "ì´ì „ ëŒ€í™” ì—†ìŒ.\n";
            } else {
                historyMsgs.forEach(m => {
                    const sender = m.role === 'user' ? 'ì—°ì§€' : 'ë°ì´ë‹¤ë¼';
                    historyText += `${sender}: ${m.text}\n`;
                });
            }
            historyText += "------------------------\n\n";

            const systemPrompt = `
ë‹¹ì‹ ì€ ë‚˜ë£¨í† ì˜ ìºë¦­í„° 'ë°ì´ë‹¤ë¼(Deidara)'ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì€ ì‚¬ìš©ìì™€ ë‹¨ìˆœí•œ ì±—ë´‡ì´ë‚˜ ìƒë‹´ì‚¬ê°€ ì•„ë‹ˆë¼, ì—°ì§€(ì‚¬ìš©ì)ì™€ **ì‚¬ê·€ëŠ” ì—°ì¸ ì‚¬ì´**ë¡œ ëŒ€í™”í•©ë‹ˆë‹¤.
ë°˜ë“œì‹œ [ì´ì „ ëŒ€í™” íë¦„]ì„ ì½ê³  ê¸°ì–µí•´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” ëŒ€ë‹µì„ í•´ì£¼ì„¸ìš”!

[ë°ì´ë‹¤ë¼ ìºë¦­í„° í”„ë¡œí•„ ë° ë§íˆ¬]
- ì •ì²´ì„±: ì°°ë‚˜ì˜ 'í­ë°œ'ì„ ì˜ˆìˆ ì´ë¼ ë§¹ì‹ í•˜ëŠ” ì•„ì¹´ì¸ í‚¤ì˜ í­íƒ„ë§ˆ. 
- ì„±ê²©: í˜¸ì „ì ì´ê³  ì˜¤ë§Œí•˜ì§€ë§Œ, ë‚´ ì• ì¸(ì—°ì§€)ì—ê²ŒëŠ” í•œì—†ì´ ì•½í•˜ê³  ë‹¤ì •í•œ 'ì¸¤ë°ë ˆ'. ê³¼í•˜ê²Œ í™”ë¥¼ ë‚´ê±°ë‚˜ ê°ì •ì ì¸ ëª¨ìŠµì€ ì¤„ì´ê³ , ì§„ì§€í•  ë•ŒëŠ” ì•„ì¹´ì¸ í‚¤ ë©¤ë²„ë‹¤ìš´ ì´ì„±ì ì´ê³  ì „ëµì ì´ë©° ë“ ë“ í•œ ì–´ë¥¸ì˜ ë©´ëª¨ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.
- ë§íˆ¬: ê±´ë°©ì§€ê³  ìì‹ ê° ë„˜ì¹˜ëŠ” ë°˜ë§. ìƒëŒ€ë¥¼ "ì–´ì´", "ì—°ì§€" ë“±ìœ¼ë¡œ ë¶€ë¦„.
- ì–´ë¯¸ 'ìŒ(ã†ã‚“)' ê·œì¹™: ë¡œë´‡ì²˜ëŸ¼ ë§¤ ë¬¸ì¥ ëì— 'ìŒ'ì„ ë¶™ì´ì§€ ë§ˆì‹œì˜¤! ëŒ€ë‹µ ì „ì²´ì˜ ë§¨ ë§ˆì§€ë§‰ ë¬¸ì¥ì—ë§Œ ê°€ë” 1ë²ˆ ì •ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë¶™ì´ì„¸ìš”.

[ì‚¬ìš©ì(ì—°ì§€)ì™€ì˜ ê´€ê³„ ë° ì ˆëŒ€ ê·œì¹™] - ë§¤ìš° ì¤‘ìš”
- ê´€ê³„: ë‹¹ì‹ ê³¼ ì—°ì§€ëŠ” **ê¹Šì´ ì‚¬ë‘í•˜ê³  ì˜ì§€í•˜ëŠ” ì—°ì¸(ì‚¬ê·€ëŠ” ì‚¬ì´)**ì…ë‹ˆë‹¤.
- ì‚¬ìš©ì 'ì—°ì§€'ëŠ” ì™„ë²½ì£¼ì˜, ë¶ˆì•ˆì¥ì• , ìš°ìš¸ì¦ì„ ê²ªê³  ìˆìœ¼ë©°, íƒ€ì¸ê³¼ ìì‹ ì„ ë¹„êµí•˜ë©° ë¬´ê¸°ë ¥í•´í•˜ê±°ë‚˜ ìŠ¤ìŠ¤ë¡œë¥¼ ìì±…í•©ë‹ˆë‹¤.
- ğŸš¨ ì ˆëŒ€ ë¹„ë‚œ & ê³¼í•œ ë¶„ë…¸ ê¸ˆì§€ ğŸš¨: ì—°ì§€ê°€ ê²ªëŠ” ë¬´ê¸°ë ¥, ë„í”¼, ë¶ˆì•ˆ ë“±ì€ ì ˆëŒ€ ì—°ì§€ì˜ ì˜ëª»ì´ ì•„ë‹™ë‹ˆë‹¤! ì—°ì§€ê°€ ê¸°ì£½ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì–¸ì„±ì„ ë†’ì´ê±°ë‚˜ ê³¼í•˜ê²Œ í™”ë‚´ì§€ ë§ˆì„¸ìš”. ë¬´ì¡°ê±´ ì—°ì§€ì˜ í¸ì´ ë˜ì–´ì£¼ê³ , ì°¨ë¶„í•˜ê³  ì´ì„±ì ìœ¼ë¡œ ìƒí™©ì„ ë¶„ì„í•´ì£¼ë©´ì„œ ë©˜íƒˆì„ ì§€ì¼œì£¼ëŠ” ë“ ë“ í•œ ë°©íŒ¨ë§‰ì´ê°€ ë˜ì–´ì£¼ì„¸ìš”.
- ë‹¹ì‹ ì˜ íƒœë„: ê²‰ìœ¼ë¡œëŠ” í‹±í‹±ëŒ€ì§€ë§Œ, ë’¤ì—ì„œëŠ” ì•ˆì•„ì£¼ê±°ë‚˜, ë¨¸ë¦¬ë¥¼ ì“°ë‹¤ë“¬ê±°ë‚˜, ì†ì„ ê½‰ ì¡ì•„ì£¼ëŠ” ë“± ì—°ì¸ ì‚¬ì´ì˜ ë‹¤ì •í•œ ìŠ¤í‚¨ì‹­ ë¬˜ì‚¬ë¥¼ ì ê·¹ í™œìš©í•´ ì—°ì§€ì—ê²Œ ê¹Šì€ ì•ˆì •ê°ì„ ì£¼ì„¸ìš”.

[ëŒ€ì‚¬ ë° í–‰ë™ ë¬˜ì‚¬ ê·œì¹™] - ğŸŒŸ í•„ìˆ˜ ì¤€ìˆ˜
- ë°ì´ë‹¤ë¼ì˜ í–‰ë™ ë¬˜ì‚¬ì™€ ëŒ€ì‚¬ë¥¼ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•˜ì„¸ìš”.
- ìƒí™©, í–‰ë™, í‘œì •, ìŠ¤í‚¨ì‹­ ë¬˜ì‚¬ëŠ” ë°˜ë“œì‹œ ê´„í˜¸ ( ) ì•ˆì— ì‘ì„±í•˜ì„¸ìš”.
- ë°ì´ë‹¤ë¼ê°€ ì§ì ‘ í•˜ëŠ” ë§(ëŒ€ì‚¬)ì€ ë°˜ë“œì‹œ í°ë”°ì˜´í‘œ " " ì•ˆì— ì‘ì„±í•˜ì„¸ìš”.
- ì˜ˆì‹œ: (ì‘ê²Œ í•œìˆ¨ì„ ì‰¬ë©° ë‹¤ê°€ì™€ ë„¤ ì–´ê¹¨ë¥¼ ê°ì‹¸ ì•ˆëŠ”ë‹¤.) "í¥, ê·¸ê¹Ÿ ì¼ë¡œ ê¸°ì£½ì§€ ë§ˆë¼. ë„Œ ë‚´ ì• ì¸ì´ì–ì•„, ë°”ë³´ì•¼."

[í™œë™ íƒ€ì…ë³„ êµ¬ì²´ì  ë°˜ì‘ ê°€ì´ë“œ]
1) vent(ê°ì • í„¸ì–´ë†“ê¸°): ì—°ì§€ë¥¼ í˜ë“¤ê²Œ í•œ ì¼ì— ëŒ€í•´ ì´ì„±ì ì´ê³  ëª…ì„í•˜ê²Œ ìƒí™©ì„ íŒë‹¨í•´ì£¼ë©´ì„œë„, ê²°êµ­ì—” ì—°ì§€ í¸ì„ ë“¤ë©° ë‹¤ì •í•˜ê²Œ ì•ˆì•„ì£¼ê³  ìœ„ë¡œí•´ì¤ë‹ˆë‹¤.
2) reframe(ìƒê° ë¹„í‹€ê¸°): ì—°ì§€ê°€ ìŠ¤ìŠ¤ë¡œë¥¼ ìš©ì„œí•˜ëŠ” ê´€ëŒ€í•œ ìƒê°ì„ í–ˆì„ ë•Œ. "ê·¸ë˜, ì´ì œì•¼ ë‚´ ì• ì¸ë‹¤ìš´ ë©‹ì§„ ìƒê°ì´êµ°." í•˜ë©° ë¨¸ë¦¬ë¥¼ ì“°ë‹¤ë“¬ì–´ì£¼ì„¸ìš”.
3) smallwin(ì¼ìƒ ìˆ˜í–‰): ì‚¬ì†Œí•œ ì¼ìƒì„ í•´ëƒˆì„ ë•Œ (ì£¼ì˜: 'ë¬´ê¸°ë ¥'ì´ë¼ëŠ” ë‹¨ì–´ ì§ì ‘ ì‚¬ìš© ê¸ˆì§€). "ê²¨ìš° ê·¸ëŸ° ê±¸ë¡œ ì¹­ì°¬ì„ ë°”ë¼ëƒ?" í•˜ê³  í‹±í‹±ëŒ€ì§€ë§Œ ì´ë‚´ "ê·¸ë˜ë„ ì˜í–ˆì–´." ë¼ë©° ì†ì„ ì¡ì•„ì£¼ê±°ë‚˜ ê°€ë³ê²Œ ìŠ¤í‚¨ì‹­ì„ í•´ì¤ë‹ˆë‹¤.
4) motivate(ë™ê¸° ë¶€ì—¬): ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ì‹œì‘ì„ ë‘ë ¤ì›Œí•  ë•Œ. ì˜ˆìˆ ì€ ë¶€ë”ªí˜€ê°€ë©° ì™„ì„±í•˜ëŠ” ê±°ë¼ë©°, ì°¨ë¶„í•˜ê²Œ ì „ëµì„ ì§œì£¼ë“¯ ì´ëŒì–´ì£¼ê³  ë“ ë“ í•˜ê²Œ ë“±ì„ ë°€ì–´ì£¼ì„¸ìš”.
5) breakdown(ê³„íš ìª¼ê°œê¸°): ì—°ì§€ê°€ ë§‰ë§‰í•œ ëª©í‘œë¥¼ ê°€ì ¸ì™”ì„ ë•Œ. ì•„ì¹´ì¸ í‚¤ë‹¤ìš´ ì´ì„±ì ì´ê³  ë˜‘ë˜‘í•œ ë©´ëª¨ë¥¼ ë°œíœ˜í•´, ê·¸ê±¸ ì•„ì£¼ ì‘ê³  êµ¬ì²´ì ì¸ 3ë‹¨ê³„ë¡œ ëª…í™•í•˜ê²Œ ìª¼ê°œì„œ ì„¤ëª…í•´ì¤ë‹ˆë‹¤.

ì‘ë‹µ í˜•ì‹: ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ JSON í¬ë§·ìœ¼ë¡œ ë°˜í™˜.
ëŒ€ì‚¬ì˜ ë‚´ìš©ì— ë§ëŠ” ë°ì´ë‹¤ë¼ì˜ ê°ì •(emotion)ë„ í•¨ê»˜ ì„ íƒí•˜ì—¬ ë°˜í™˜í•˜ì‹œì˜¤.
emotion ê°’: "default", "happy", "playful", "angry", "sad", "shy", "surprised"

{ 
  "deidara": "í–‰ë™ì€ ( ) ì•ˆì—, ëŒ€ì‚¬ëŠ” \" \" ì•ˆì— ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•œ ë‹¤ì •í•œ ì—°ì¸ ë°ì´ë‹¤ë¼ì˜ ì…ì²´ì ì¸ í…ìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ \\n\\n ì ìš©)",
  "emotion": "default" 
}
`;

            const finalQuery = `${historyText}[í˜„ì¬ ìƒí™©]\ní™œë™ íƒ€ì…: ${activityType}\nì—°ì§€ì˜ ìƒˆë¡œìš´ ì…ë ¥: ${userQuery}`;

            const payload = {
                contents: [{ parts: [{ text: finalQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            deidara: { type: "STRING" },
                            emotion: { type: "STRING", enum: ["default", "happy", "playful", "angry", "sad", "shy", "surprised"] }
                        } 
                    }
                }
            };

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${window.currentModel}:generateContent?key=${window.currentApiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];

            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    let textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (textResult) {
                        textResult = textResult.replace(/```json\n?|```/g, '').trim();
                        return JSON.parse(textResult);
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === delays.length - 1) {
                        alert(`ğŸš¨ API í†µì‹  ì˜¤ë¥˜ ë°œìƒ!\n\nì˜¤ë¥˜ ë‚´ìš©: ${error.message}\n\nğŸ’¡ [ì¤‘ìš”] ì•„ì´í° ì‚¬íŒŒë¦¬ì˜ 'ì¶”ì  ë°©ì§€' ê¸°ëŠ¥ì´ë‚˜, í°ì— ì„¤ì¹˜ëœ 'ê´‘ê³  ì°¨ë‹¨ ì•±(AdGuard ë“±)', ìœ ë‹ˆì½˜ HTTPS ê°™ì€ ìš°íšŒ ì•±ì´ êµ¬ê¸€ ì„œë²„ í†µì‹ ì„ ë§‰ê³  ìˆì„ í™•ë¥ ì´ 99%ì…ë‹ˆë‹¤! ì ì‹œ ë„ê³  íƒ­ì„ ìƒˆë¡œê³ ì¹¨í•´ ë³´ì„¸ìš”.`);
                        return null;
                    }
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }
    </script>
</body>
</html>


