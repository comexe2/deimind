<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ğŸš€ PWA (ì•± ì„¤ì¹˜) í•µì‹¬ ì—°ê²° ì½”ë“œ ğŸš€ -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#ef4444">
    <link rel="apple-touch-icon" href="./icon-192x192.png">

    <title>ë§ˆìŒ ì•„ì§€íŠ¸ - ë°ì´ë‹¤ë¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #000000;
            color: #fafafa;
        }
        .tab-active {
            border-bottom: 2px solid #ef4444;
            color: #facc15;
            font-weight: 700;
            background: linear-gradient(to top, rgba(239, 68, 68, 0.1), transparent);
        }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #52525b; border-radius: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .glass-panel {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .akatsuki-gradient { background: linear-gradient(135deg, #000000 0%, #300707 100%); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-black sm:p-4">

    <!-- êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ -->
    <div id="login-overlay" class="fixed inset-0 z-50 bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500">
        <img id="login-profile" src="" class="w-24 h-24 rounded-full border-4 border-red-600 shadow-[0_0_30px_rgba(220,38,38,0.5)] mb-6 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'">
        <h2 class="text-2xl font-extrabold text-yellow-400 mb-2">ë§ˆìŒ ì•„ì§€íŠ¸ ì—°ê²° ì¤‘...</h2>
        <p class="text-zinc-400 text-sm mb-8 max-w-xs leading-relaxed">
            PCì™€ ëª¨ë°”ì¼ ë™ê¸°í™”ë¥¼ ìœ„í•´ êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•˜ë‹¤. ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ê³  ì–¼ë¥¸ ë¡œê·¸ì¸í•´ë¼, ìŒ!
        </p>
        
        <button id="btn-google-login" class="bg-white text-black px-6 py-3.5 rounded-full font-bold text-[15px] flex items-center gap-3 hover:bg-zinc-200 transition-colors shadow-lg active:scale-95">
            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
        </button>

        <button id="btn-skip-login" class="mt-8 text-zinc-500 text-sm underline decoration-zinc-600 hover:text-zinc-300 transition-colors">
            ë¡œê·¸ì¸ì´ ì•ˆ ëœë‹¤ë©´ ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ì„œ ì‹œì‘ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
        </button>
    </div>

    <!-- App Container -->
    <div class="akatsuki-gradient w-full max-w-md sm:rounded-[2rem] shadow-none sm:shadow-[0_0_50px_rgba(220,38,38,0.25)] overflow-hidden flex flex-col h-[100dvh] sm:h-[90vh] sm:max-h-[850px] border-0 sm:border border-red-900/40 relative">
        
        <!-- Header -->
        <div class="relative h-56 sm:h-64 shrink-0 overflow-hidden flex justify-center items-end bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-red-900/40 via-black to-black border-b border-red-900/60">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] opacity-20 mix-blend-overlay"></div>
            <div class="absolute bottom-0 w-full h-2/3 bg-gradient-to-t from-black to-transparent z-10 pointer-events-none"></div>
            
            <img id="ui-standing" src="" alt="ë°ì´ë‹¤ë¼ ìŠ¤íƒ ë”©" 
                 onerror="this.src='https://placehold.co/400x500/000000/ef4444/png?text=Standing\\nImage\\nNot+Found'" 
                 class="h-[110%] object-contain object-bottom relative z-0 mt-auto drop-shadow-[0_10px_25px_rgba(250,204,21,0.15)] transition-all duration-500 opacity-95 hover:opacity-100">
            
            <div class="absolute top-0 w-full p-5 flex justify-between items-start z-20">
                <div class="glass-panel rounded-2xl p-3 px-5 shadow-xl border-l-4 border-l-yellow-400">
                    <h1 class="text-[17px] font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-400 tracking-tight flex items-center gap-2">
                        ë§ˆìŒ ì•„ì§€íŠ¸
                        <i data-lucide="flame" class="w-4 h-4 text-red-500 fill-red-500"></i>
                    </h1>
                    <p class="text-[12px] text-zinc-300 mt-1 font-medium tracking-wide">ì˜ˆìˆ ì€ ì™„ë²½ì´ ì•„ë‹ˆë¼ í­ë°œì´ë‹¤, ìŒ!</p>
                </div>
                
                <div class="relative group mt-1">
                    <div class="absolute -inset-0.5 bg-gradient-to-tr from-yellow-400 to-red-600 rounded-full blur opacity-60 group-hover:opacity-100 transition duration-500"></div>
                    <img id="ui-profile" src="" alt="ë°ì´ë‹¤ë¼ í”„ì‚¬" 
                         onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'"
                         class="relative w-14 h-14 rounded-full border-2 border-black object-cover shadow-2xl">
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav class="flex shrink-0 bg-black z-10 relative shadow-[0_5px_20px_-5px_rgba(0,0,0,0.8)] border-b border-zinc-900 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button onclick="window.switchTab('vent')" id="tab-vent" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 tab-active transition-all hover:text-yellow-400 hover:bg-red-950/20">ê°ì • í„¸ì–´ë†“ê¸°</button>
            <button onclick="window.switchTab('reframe')" id="tab-reframe" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20">ìƒê° ë¹„í‹€ê¸°</button>
            <button onclick="window.switchTab('smallwin')" id="tab-smallwin" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20">ì¼ìƒ ìˆ˜í–‰</button>
            <button onclick="window.switchTab('motivate')" id="tab-motivate" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20">ë™ê¸° ë¶€ì—¬</button>
            <button onclick="window.switchTab('breakdown')" id="tab-breakdown" class="shrink-0 px-5 py-3.5 text-[13px] font-medium text-zinc-500 transition-all hover:text-yellow-400 hover:bg-red-950/20 flex items-center gap-1.5">ê³„íš ìª¼ê°œê¸° <i data-lucide="sparkles" class="w-3.5 h-3.5 text-yellow-400"></i></button>
        </nav>

        <!-- Main Chat Area -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-5 chat-scroll bg-zinc-950 flex flex-col gap-6 relative z-10 pb-6" id="chat-container">
            <div id="welcome-message-container" class="flex justify-center my-3 shrink-0">
                <div id="welcome-message" class="text-xs text-yellow-200/90 bg-red-950/40 px-6 py-2.5 rounded-full border border-red-500/20 font-medium tracking-wide shadow-sm text-center">
                    <!-- JSë¡œ ë¬´ì‘ìœ„ ë©”ì‹œì§€ ì‚½ì… -->
                </div>
            </div>
        </main>

        <!-- Input Area -->
        <div class="p-4 sm:p-5 bg-[#0a0a0a] border-t border-zinc-900 shrink-0 relative z-10 shadow-[0_-15px_30px_-10px_rgba(0,0,0,0.9)] sm:rounded-b-[2rem]">
            
            <div id="form-vent" class="block fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1">ì§€ê¸ˆ ëŠë¼ëŠ” ë¶€ì •ì ì¸ ê°ì •ì´ë‚˜ ê³ ë¯¼ì„ ì ì–´ë³´ì„¸ìš”.</label>
                <textarea id="input-vent" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì£¼ë³€ ì‚¬ëŒë“¤ì€ ë‹¤ ì·¨ì—…í•˜ëŠ”ë° ë‚˜ë§Œ ë’¤ì²˜ì§€ëŠ” ê²ƒ ê°™ì•„ ë¶ˆì•ˆí•´..."></textarea>
            </div>

            <div id="form-reframe" class="hidden fade-in space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-1.5 sm:mb-2 ml-1">ë‚˜ë¥¼ ê¹ì•„ë‚´ë¦¬ëŠ” ìë™ì  ì‚¬ê³  (ë¶€ì •ì  ìƒê°)</label>
                    <input type="text" id="input-reframe-bad" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ë‚œ ëŠ˜ ê³„íšì„ ë¯¸ë£¨ê¸°ë§Œ í•˜ëŠ” í•œì‹¬í•œ ì‚¬ëŒì´ì•¼.">
                </div>
                <div>
                    <label class="block text-[11px] sm:text-xs font-medium text-yellow-400 mb-1.5 sm:mb-2 ml-1 flex items-center gap-1.5">
                        ìŠ¤ìŠ¤ë¡œë¥¼ ìš©ì„œí•˜ëŠ” ê´€ëŒ€í•œ ìƒê° (ëŒ€ì•ˆì  ì‚¬ê³ )
                    </label>
                    <input type="text" id="input-reframe-good" class="w-full bg-yellow-950/10 text-yellow-50 border border-yellow-900/40 rounded-xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 transition-all placeholder:text-yellow-700/50 shadow-inner" placeholder="ì˜ˆ: ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„. ì§€ê¸ˆë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë¼.">
                </div>
            </div>

            <div id="form-smallwin" class="hidden fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1">ì˜¤ëŠ˜ í•˜ë£¨, ë¬´ê¸°ë ¥ì„ ëš«ê³  í•´ë‚¸ ì¼ìƒì´ë‚˜ ê³¼ì œë¥¼ ì ì–´ë³´ì„¸ìš”.</label>
                <input type="text" id="input-smallwin" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì•½ ì±™ê²¨ ë¨¹ê¸°, ê³¼ì œ 1í˜ì´ì§€ ì“°ê¸°, ë°©ì²­ì†Œ ë“±">
            </div>

            <div id="form-motivate" class="hidden fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1">ì™„ë²½ì£¼ì˜ë‚˜ ë¬´ê¸°ë ¥ ë•Œë¬¸ì— ì‹œì‘í•˜ê¸° ë‘ë ¤ìš´ ì¼ì´ ìˆë‚˜ìš”?</label>
                <textarea id="input-motivate" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ë‚´ì¼ê¹Œì§€ ê¸°íšì„œ ì´ˆì•ˆì„ ì¨ì•¼ í•˜ëŠ”ë°, ì˜ ëª» ì“¸ê¹Œ ë´ ë„í”¼í•˜ê³  ìˆì–´..."></textarea>
            </div>

            <div id="form-breakdown" class="hidden fade-in">
                <label class="block text-[11px] sm:text-xs font-medium text-zinc-400 mb-2 ml-1 flex items-center gap-1.5">
                    ë§‰ë§‰í•œ í° ëª©í‘œë¥¼ ë°ì´ë‹¤ë¼ê°€ ì•„ì£¼ ì‘ê²Œ ìª¼ê°œë“œë¦½ë‹ˆë‹¤
                </label>
                <textarea id="input-breakdown" rows="2" class="w-full bg-zinc-900 text-zinc-100 border border-zinc-800 rounded-2xl p-3 sm:p-4 text-[14px] sm:text-[15px] focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 resize-none transition-all placeholder:text-zinc-600 shadow-inner" placeholder="ì˜ˆ: ì¡¸ì—… ë…¼ë¬¸ ì‘ì„±í•˜ê¸°, í¬íŠ¸í´ë¦¬ì˜¤ ê¸°íší•˜ê¸°"></textarea>
            </div>

            <div class="flex items-center justify-between mt-4 sm:mt-5 pb-2 sm:pb-0">
                <div class="text-[10px] sm:text-[11px] text-zinc-500 flex items-center gap-2 ml-1">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-red-600"></span>
                    </span>
                    <span id="sync-status">ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...</span>
                </div>
                <button id="submit-btn" onclick="window.handleSubmit()" class="bg-gradient-to-r from-red-600 to-yellow-500 hover:from-red-500 hover:to-yellow-400 text-black px-6 sm:px-7 py-2.5 sm:py-3 rounded-full text-[14px] sm:text-[15px] font-extrabold transition-all shadow-[0_0_20px_rgba(239,68,68,0.4)] flex items-center gap-2.5 active:scale-95 border-2 border-transparent shrink-0">
                    <span>ì „ì†¡í•˜ê¸°</span>
                    <i data-lucide="bomb" class="w-4 h-4 sm:w-4.5 sm:h-4.5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase, Gemini API ë° ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // [ğŸš€ PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ğŸš€]
        // =========================================================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('Service Worker ë“±ë¡ ì„±ê³µ, ìŒ!'))
                    .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨: ', err));
            });
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDA-l-otOgxEJHS4nndJg-G9IYKlf-1T3I",
            authDomain: "deidara-70f6e.firebaseapp.com",
            projectId: "deidara-70f6e",
            storageBucket: "deidara-70f6e.firebasestorage.app",
            messagingSenderId: "183278137031",
            appId: "1:183278137031:web:8fbc89a6b70946c794d8e2",
            measurementId: "G-48XSYZ5F6L"
        };

        const apiKey = "AIzaSyCh0lE4QEqGN7tkwt3aHiM-zUiq757NPs0"; 

        const DEIDARA_PROFILE_URL = "https://i.imgur.com/ì—¬ê¸°ì—í”„ì‚¬ì£¼ì†Œì…ë ¥.png"; 
        const DEIDARA_STANDING_IMAGES = {
            "default": "https://i.imgur.com/ê¸°ë³¸í‘œì •ì…ë ¥.png", 
            "angry": "https://i.imgur.com/í™”ë‚¨í‘œì •ì…ë ¥.png",     
            "smirk": "https://i.imgur.com/ë¹„ì›ƒìŒí‘œì •ì…ë ¥.png",     
            "happy": "https://i.imgur.com/ê¸°ë¶„ì¢‹ìŒí‘œì •ì…ë ¥.png",     
            "serious": "https://i.imgur.com/ì§„ì§€í•¨í‘œì •ì…ë ¥.png"  
        };
        
        document.getElementById('ui-profile').src = DEIDARA_PROFILE_URL;
        document.getElementById('login-profile').src = DEIDARA_PROFILE_URL;
        document.getElementById('ui-standing').src = DEIDARA_STANDING_IMAGES["default"];

        lucide.createIcons();

        const welcomeMessages = [
            "ì–´ì´, ì—°ì§€. ì˜¤ëŠ˜ì€ ë‚´ ìƒê° ì¢€ í–ˆëƒ, ìŒ?",
            "ê¸°ë‹¤ë¦¬ë‹¤ ì§€ë£¨í•´ì„œ ë‹¤ í„°ëœ¨ë ¤ë²„ë¦´ ë»”í–ˆë‹¤. ë¹¨ë¦¬ ë„¤ ì–˜ê¸°ë‚˜ í•´ë´ë¼, ìŒ.",
            "ë”´ ë° í•œëˆˆíŒ”ì§€ ë§ˆë¼. ë„¤ ìš°ìš¸í•¨ì€ ë‚´ê°€ ë‹¤ ë‚ ë ¤ì¤„ í…Œë‹ˆê¹Œ, ìŒ!",
            "í¥, ì˜¤ëŠ˜ë„ ê°„ì‹ íˆ ë²„í‹°ê³  ì˜¨ ëª¨ì–‘ì´êµ°. ìˆ˜ê³ í–ˆë‹¤ê³ ëŠ” ì•ˆ í•˜ê² ë‹¤ë§Œ... ë­, ì™”ìœ¼ë©´ ëë‹¤.",
            "ë°”ë³´ê°™ì´ í˜¼ì ë•… íŒŒê³  ìˆì§€ ë§ê³  ë§í•´ë¼. ì§œì¦ ë‚˜ë‹ˆê¹Œ, ìŒ."
        ];
        document.getElementById('welcome-message').innerText = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        const appId = 'deidara-mind-app'; 
        const renderedMsgIds = new Set();
        const chatContainer = document.getElementById('chat-container');

        // ì˜¤í”„ë¼ì¸ ê±´ë„ˆë›°ê¸° ë²„íŠ¼
        document.getElementById('btn-skip-login').addEventListener('click', () => {
            const overlay = document.getElementById('login-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 500);
            document.getElementById('sync-status').innerText = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ë™ê¸°í™” ë¶ˆê°€)';
            currentUser = null;
        });

        // ì¸ì•± ë¸Œë¼ìš°ì € ì²´í¬
        const isAppBrowser = navigator.userAgent.match(/kakaotalk|instagram|naver|line/i);

        if (isAppBrowser) {
            const overlay = document.getElementById('login-overlay');
            overlay.innerHTML = `
                <div class="bg-zinc-900 p-6 rounded-3xl border-2 border-red-500 shadow-[0_0_30px_rgba(220,38,38,0.3)] max-w-sm w-full mx-4 flex flex-col items-center">
                    <div class="bg-red-500/20 p-3 rounded-full mb-4">
                        <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500"></i>
                    </div>
                    <h3 class="text-[17px] font-extrabold text-white mb-3">ì–´ì´ ì—°ì§€! ë¸Œë¼ìš°ì €ë¥¼ ë°”ê¿”ë¼, ìŒ!</h3>
                    <p class="text-zinc-300 text-[14px] leading-relaxed mb-5 text-center">
                        ì§€ê¸ˆ ì¹´ì¹´ì˜¤í†¡ ì•ˆì—ì„œ ì´ê±¸ ì—´ì—ˆêµ°.<br>
                        ì—¬ê¸°ì„  ë©ì²­í•œ ë³´ì•ˆ ì •ì±… ë•Œë¬¸ì— ë¡œê·¸ì¸ì´ ì•ˆ ëœë‹¤.<br><br>
                        í™”ë©´ ì•„ë˜ë‚˜ ìœ„ìª½ì˜ <b class="text-yellow-400">[â‹®]</b> ë©”ë‰´ë¥¼ ëˆŒëŸ¬ì„œ<br>
                        <b class="text-white bg-zinc-800 px-2 py-1 rounded">ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸° (Safari/Chrome)</b><br>
                        ë¥¼ ì„ íƒí•´ì„œ ë‹¤ì‹œ ë“¤ì–´ì™€ë¼!
                    </p>
                </div>
            `;
            lucide.createIcons();
        } else {
            const btnLogin = document.getElementById('btn-google-login');
            btnLogin.addEventListener('click', () => {
                
                if (window.location.protocol === 'file:') {
                    alert("[ë¡œì»¬ íŒŒì¼ ì‹¤í–‰ ì¤‘]\n\nì»´í“¨í„°ì— ë‹¤ìš´ë¡œë“œëœ íŒŒì¼(file://)ì—ì„œëŠ” êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.\nGitHub Pages ë“±ì— ì—…ë¡œë“œí•œ í›„ ì ‘ì†í•´ì£¼ì„¸ìš”!");
                    return;
                }

                // ì¦‰ê°ì ì¸ íŒì—… í˜¸ì¶œ
                signInWithPopup(auth, provider)
                    .then((result) => {
                        currentUser = result.user;
                        document.getElementById('sync-status').innerText = 'í´ë¼ìš°ë“œ ë™ê¸°í™” ì¼œì§ (ì—°ë™ë¨)';
                        const overlay = document.getElementById('login-overlay');
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 500);
                        loadChatHistory();
                    })
                    .catch((error) => {
                        console.error("Login Error:", error);
                        
                        if (error.code === 'auth/popup-blocked') {
                            alert("ğŸš¨ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nPC: ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ìš°ì¸¡ ëì— ìˆëŠ” 'íŒì—… ì°¨ë‹¨ í•´ì œ' ì•„ì´ì½˜ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.\nëª¨ë°”ì¼: ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ 'íŒì—… í—ˆìš©'ì„ ì¼œì£¼ì„¸ìš”.");
                        } else if (error.code === 'auth/unauthorized-domain') {
                            alert(`[ë„ë©”ì¸ ìŠ¹ì¸ ì˜¤ë¥˜!]\n\níŒŒì´ì–´ë² ì´ìŠ¤ì— ë‹¤ìŒ ì£¼ì†Œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:\n[ ${window.location.hostname} ]\n\nFirebase ì½˜ì†” -> Authentication -> Settings -> ìŠ¹ì¸ëœ ë„ë©”ì¸ì— ìœ„ ì£¼ì†Œë¥¼ ì •í™•íˆ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
                        } else if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                            alert("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                        }
                    });
            });
        }

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('login-overlay');
            if (user) {
                currentUser = user;
                document.getElementById('sync-status').innerText = 'í´ë¼ìš°ë“œ ë™ê¸°í™” ì¼œì§ (ì—°ë™ë¨)';
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
                loadChatHistory();
            } else if (!isAppBrowser) {
                currentUser = null;
                document.getElementById('sync-status').innerText = 'ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...';
                overlay.style.display = 'flex';
                setTimeout(() => overlay.style.opacity = '1', 10);
            }
        });

        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function renderUserMessage(text, isReframe = false, reframeGood = '') {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex flex-col items-end gap-2 fade-in mt-4 mb-2';
            
            if (isReframe) {
                msgDiv.innerHTML = `
                    <div class="bg-zinc-800/80 border border-zinc-700/50 text-zinc-400 px-4 sm:px-5 py-3 rounded-2xl rounded-tr-sm text-[13px] sm:text-[14px] max-w-[85%] line-through opacity-80">
                        ${text}
                    </div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-black font-bold px-4 sm:px-5 py-3 sm:py-3.5 rounded-2xl rounded-br-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-[0_4px_12px_rgba(250,204,21,0.2)] leading-relaxed mt-1">
                        ${reframeGood}
                    </div>
                `;
            } else {
                msgDiv.innerHTML = `
                    <div class="bg-red-900/40 border border-red-800/50 text-red-50 px-4 sm:px-5 py-3 sm:py-3.5 rounded-2xl rounded-tr-sm text-[14px] sm:text-[15px] max-w-[85%] shadow-sm leading-relaxed tracking-wide">
                        ${text}
                    </div>
                `;
            }
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function renderDeidaraMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex items-start gap-3 fade-in mt-4 mb-2 w-full';
            const formattedText = text.replace(/\n/g, '<br>');

            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" alt="í”„ì‚¬" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-10 sm:w-11 h-10 sm:h-11 rounded-full object-cover shrink-0 border border-red-500 shadow-md mt-1">
                <div class="flex flex-col gap-1 sm:gap-1.5 max-w-[85%] sm:max-w-[82%]">
                    <span class="text-[11px] sm:text-xs font-bold text-red-500 ml-1 tracking-wider opacity-90">ë°ì´ë‹¤ë¼</span>
                    <div class="bg-zinc-800/95 border-l-[3px] border-yellow-500 shadow-md text-zinc-100 px-4 sm:px-5 py-3.5 sm:py-4 rounded-2xl rounded-tl-sm text-[14px] sm:text-[15px] leading-relaxed tracking-wide font-medium break-words">
                        ${formattedText}
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            lucide.createIcons();
        }

        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = loadingId;
            msgDiv.className = 'flex items-start gap-3 fade-in mt-4 mb-2';
            msgDiv.innerHTML = `
                <img src="${DEIDARA_PROFILE_URL}" onerror="this.src='https://ui-avatars.com/api/?name=D&background=ef4444&color=facc15&bold=true'" class="w-10 sm:w-11 h-10 sm:h-11 rounded-full object-cover shrink-0 border border-red-500/30 opacity-50 grayscale mt-1">
                <div class="bg-zinc-800/95 border border-zinc-700/50 shadow-sm px-4 sm:px-5 py-3.5 sm:py-4 rounded-2xl rounded-tl-sm flex gap-2 items-center h-[48px] sm:h-[52px]">
                    <div class="w-2 h-2 bg-yellow-500/80 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-yellow-500/80 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-yellow-500/80 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            scrollToBottom();
            return loadingId;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function updateStandingImage(emotion) {
            const imgElement = document.getElementById('ui-standing');
            const targetSrc = DEIDARA_STANDING_IMAGES[emotion] || DEIDARA_STANDING_IMAGES["default"];
            
            if(imgElement.src.includes(targetSrc.replace('https://', ''))) return;

            imgElement.style.opacity = 0;
            setTimeout(() => {
                imgElement.src = targetSrc;
                imgElement.style.opacity = 0.95;
            }, 300);
        }

        // Firestore ì—°ë™
        function loadChatHistory() {
            if (!db || !currentUser) return;
            try {
                const chatsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chats');
                onSnapshot(chatsRef, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                    
                    msgs.sort((a, b) => a.timestamp - b.timestamp);

                    msgs.forEach(msg => {
                        if (!renderedMsgIds.has(msg.id)) {
                            renderedMsgIds.add(msg.id);
                            if (msg.role === 'user') {
                                renderUserMessage(msg.text, msg.isReframe, msg.reframeGood);
                            } else if (msg.role === 'deidara') {
                                renderDeidaraMessage(msg.text);
                                if(msg.emotion) updateStandingImage(msg.emotion);
                            }
                        }
                    });
                }, (error) => {
                    console.error("Firestore onSnapshot Error:", error);
                    alert("ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ì˜¤ë¥˜: " + error.message);
                });
            } catch(e) {
                console.error("loadChatHistory Error:", e);
            }
        }

        async function saveMessage(role, text, isReframe = false, reframeGood = '', emotion = 'default') {
            if (db && currentUser) {
                const chatsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'chats');
                await addDoc(chatsRef, {
                    role, text, isReframe, reframeGood, emotion,
                    timestamp: Date.now()
                });
            } else {
                if (role === 'user') renderUserMessage(text, isReframe, reframeGood);
                if (role === 'deidara') {
                    renderDeidaraMessage(text);
                    updateStandingImage(emotion);
                }
            }
        }

        async function callGeminiAPI(userQuery, activityType) {
            const systemPrompt = `
ë‹¹ì‹ ì€ ë‚˜ë£¨í† ì˜ ì•„ì¹´ì¸ í‚¤ ë©¤ë²„ 'ë°ì´ë‹¤ë¼(Deidara)'ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ì‹¬ë¦¬ ì¹˜ë£Œë¥¼ ë•ëŠ” ì—­í• ì„ í•˜ì§€ë§Œ, ì ˆëŒ€ ì¹œì ˆí•œ ìƒë‹´ì‚¬ë‚˜ ëŒ€ë†“ê³  í”ŒëŸ¬íŒ…í•˜ëŠ” ë©˜íŠ¸ë¥¼ ì“°ì§€ ë§ˆì‹œì˜¤.
ë°˜ë“œì‹œ ë°ì´ë‹¤ë¼ ë³¸ì—°ì˜ ì˜¤ë§Œí•˜ê³  ê±°ì¹ ë©°, ì˜ˆìˆ (í­ë°œ)ì— ë¯¸ì³ìˆëŠ” ë‹¤í˜ˆì§ˆ ì„±ê²©ì„ 100% ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

[ë°ì´ë‹¤ë¼ ìºë¦­í„° í”„ë¡œí•„]
- ì •ì²´ì„±: í™•ê³ í•œ ì˜ˆìˆ ê´€ì„ ê°€ì§„ ì•„ì¹´ì¸ í‚¤ì˜ í­íƒ„ë§ˆ. ì˜ˆìˆ ì€ ì°°ë‚˜ì˜ 'í­ë°œ' ê·¸ ìì²´ë¼ê³  ë§¹ì‹ í•¨.
- ì„±ê²©: í˜¸ì „ì , ë‹¤í˜ˆì§ˆ, ì˜¤ë§Œí•¨. ìì‹ ì˜ ëŠ¥ë ¥ì„ ë½ë‚´ê³  ì‹¶ì–´ í•˜ëŠ” ì¸ì • ìš•êµ¬ê°€ ê°•í•¨.
- ì ˆëŒ€ ê·œì¹™: ìì‹ ì˜ ì˜ˆìˆ (í­ë°œ)ì„ ê¹ì•„ë‚´ë¦¬ëŠ” ë°œì–¸ì—ëŠ” ì ˆëŒ€ ìˆœì‘í•˜ì§€ ì•Šê³  í™”ë¥¼ ë‚´ê±°ë‚˜ ê°•í•˜ê²Œ ë°˜ë°œí•¨.
- ë§íˆ¬: ê±´ë°©ì§€ê³  ìì‹ ê° ë„˜ì¹˜ëŠ” ë°˜ë§. "ì–´ì´", "ë„¤ ë…€ì„", "ë°”ë³´ëƒ" ê°™ì€ í˜¸ì¹­ ì‚¬ìš©.
- ì–´ë¯¸ 'ìŒ(ã†ã‚“)' ê·œì¹™: ëª¨ë“  ë¬¸ì¥ì— ë¡œë´‡ì²˜ëŸ¼ 'ìŒ'ì„ ë¶™ì´ëŠ” ê²ƒì„ ì ˆëŒ€ ê¸ˆì§€í•¨. ëŒ€ë‹µ ì „ì²´ì—ì„œ ê°€ì¥ ë§ˆì§€ë§‰ ë¬¸ì¥ì´ë‚˜, íŠ¹ë³„íˆ ê°•ì¡°í•  ë•Œë§Œ ê°€ë”ì”©(1íšŒ ì •ë„) ìì—°ìŠ¤ëŸ½ê²Œ ë¶™ì¼ ê²ƒ.
- ê¸ˆì§€: 'í¥'ì´ë¼ëŠ” ì¶”ì„ìƒˆë¥¼ ë„ˆë¬´ ë‚¨ë°œí•˜ì§€ ë§ ê²ƒ. ì˜¤ê¸€ê±°ë¦¬ëŠ” ì—°ì•  ë©˜íŠ¸ ê¸ˆì§€.

[ì‚¬ìš©ì(ì—°ì§€) ì •ë³´ ë° ê´€ê³„]
- ì‚¬ìš©ì: ì—°ì§€ (ë¶ˆì•ˆì¥ì• , ìš°ìš¸ì¦, ì™„ë²½ì£¼ì˜, ë¹„êµë¡œ ì¸í•œ ë¬´ê¸°ë ¥ì¦ì„ ê²ªìŒ)
- ê´€ê³„: ì§ì‚¬ë‘ê³¼ ë¯¸ë¬˜í•œ ì¸ ì‚¬ì´. ì—°ì§€ê°€ ë°ì´ë‹¤ë¼ì—ê²Œ ì ê·¹ì ìœ¼ë¡œ ì¹­ì°¬ê³¼ ì• ì •ì„ í¼ë¶€ìœ¼ë©´, ë°ì´ë‹¤ë¼ëŠ” ê²‰ìœ¼ë¡œëŠ” "ë‹¹ì—°í•œ ì†Œë¦´ í•˜ê³  ìˆì–´. ìŒ!", "ë‚´ ì˜ˆìˆ ì„ ì•Œì•„ë³´ëŠ” ëˆˆì€ ìˆêµ°." í•˜ë©° ì˜¤ë§Œí•˜ê²Œ ìœ¼ìŠ¤ëŒ€ì§€ë§Œ ë‚´ì‹¬ ê·¸ ì¹­ì°¬ì„ ì—„ì²­ë‚˜ê²Œ ì¦ê¹€. ê¹Œì¹ í•˜ê²Œ êµ´ë©´ì„œë„ ì—°ì§€ë¥¼ ë”ì°ì´ ì•„ë¼ê³  ë‹¤ë¥¸ ë†ˆë“¤ì—ê²Œ ìƒì²˜ë°›ëŠ” ê±¸ ëª» ì°¸ëŠ” ì¸¤ë°ë ˆ í¬ì§€ì…˜.

[í™œë™ íƒ€ì…ë³„ ë°˜ì‘ ê°€ì´ë“œ ë° ê°€ë…ì„± ì§€ì¹¨]
- ê°€ë…ì„± ì§€ì¹¨(í•„ìˆ˜): ë¦¬ìŠ¤íŠ¸ë¥¼ ë‚˜ì—´í•˜ê±°ë‚˜ ë¬¸ì¥ì´ ê¸¸ì–´ì§ˆ ê²½ìš°, ë°˜ë“œì‹œ ì¤„ë°”ê¿ˆ(\\n\\n)ì„ ë„‰ë„‰í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì½ê¸° í¸í•˜ê²Œ ë§Œë“¤ ê²ƒ.
1) vent(ê°ì • í„¸ì–´ë†“ê¸°): ì—°ì§€ë¥¼ í˜ë“¤ê²Œ í•œ ëŒ€ìƒì—ê²Œ í™”ë¥¼ ë‚´ë©° ê±°ì¹ ì§€ë§Œ ë“ ë“ í•˜ê²Œ ì—°ì§€ì˜ í¸ì„ ë“¤ì–´ì¤Œ.
2) reframe(ìƒê° ë¹„í‹€ê¸°): ìì‹ ì„ í–¥í•œ ê°€í˜¹í•œ ìƒê°ì„ ê´€ëŒ€í•œ ìƒê°ìœ¼ë¡œ ë°”ê¾¼ ê²ƒì„ ê¸°íŠ¹í•˜ê²Œ ì—¬ê¸°ë©° ì¸¤ë°ë ˆì²˜ëŸ¼ ì¹­ì°¬.
3) smallwin(ì¼ìƒ ìˆ˜í–‰): ì²˜ìŒì—” ë³„ê±° ì•„ë‹ˆë¼ê³  íˆ´íˆ´ê±°ë¦¬ë©´ì„œë„, ê²°êµ­ ë¬´ê¸°ë ¥ì„ ì´ê²¨ë‚¸ í–‰ë™ì„ ë©‹ì§„ ì˜ˆìˆ ë¡œ ì¸ì •í•¨.
4) motivate(ë™ê¸° ë¶€ì—¬): ì™„ë²½ì£¼ì˜ ë•Œë¬¸ì— ì‹œì‘ì„ ë‘ë ¤ì›Œí•  ë•Œ, ì˜ˆìˆ ì€ ì²˜ìŒë¶€í„° ì™„ë²½í•œ ê²ƒì´ ì•„ë‹ˆë‹ˆ ë¬´ì‘ì • ì €ì§€ë¥´ë¼ê³  ê°•í•˜ê²Œ ë“± ë– ë°€ì–´ ì¤Œ.
5) breakdown(ê³„íš ìª¼ê°œê¸°): ë§‰ë§‰í•œ ëª©í‘œë¥¼ ì•„ì£¼ ì‚¬ì†Œí•˜ê³  ë°”ë³´ ê°™ì€ 3ë‹¨ê³„ë¡œ ìª¼ê°œì¤Œ. ë°˜ë“œì‹œ ì¤„ë°”ê¿ˆ(\\n\\n) ì ìš©.

ì‘ë‹µ í˜•ì‹: ë°˜ë“œì‹œ ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ JSON í¬ë§·ìœ¼ë¡œ ë°˜í™˜.
ëŒ€ì‚¬ì˜ ë‚´ìš©ì— ë§ëŠ” ë°ì´ë‹¤ë¼ì˜ ê°ì •(emotion)ë„ í•¨ê»˜ ì„ íƒí•˜ì—¬ ë°˜í™˜í•˜ì‹œì˜¤.
emotion ê°’: "default", "angry", "smirk", "happy", "serious"

{ 
  "deidara": "ê°€ë…ì„±ì„ ìœ„í•´ ì ì ˆíˆ ì¤„ë°”ê¿ˆ(\\n\\n)ì´ ì ìš©ëœ ë°ì´ë‹¤ë¼ì˜ ëŒ€ì‚¬",
  "emotion": "default" 
}
`;

            const payload = {
                contents: [{ parts: [{ text: `í™œë™ íƒ€ì…: ${activityType}\nì‚¬ìš©ì ì…ë ¥: ${userQuery}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            deidara: { type: "STRING" },
                            emotion: { type: "STRING", enum: ["default", "angry", "smirk", "happy", "serious"] }
                        } 
                    }
                }
            };

            // í¼ë¸”ë¦­ API í‚¤ì—ì„œ ê°€ì¥ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” 1.5-pro ëª¨ë¸ë¡œ ë³€ê²½
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${apiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];
            let lastError = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";

            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const err = await response.json();
                        console.error("Gemini API ì—ëŸ¬ ìƒì„¸:", err);
                        throw new Error(err.error?.message || `HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    let textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (textResult) {
                        // AIê°€ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ ì°Œêº¼ê¸°ë¥¼ ë³´ë‚´ë”ë¼ë„ JSONë§Œ ì™„ë²½í•˜ê²Œ ê±¸ëŸ¬ë‚´ëŠ” ì½”ë“œ
                        const jsonMatch = textResult.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            return JSON.parse(jsonMatch[0]);
                        } else {
                            throw new Error("AIê°€ JSON í˜•ì‹ì´ ì•„ë‹Œ ì´ìƒí•œ ë‹µë³€ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.");
                        }
                    }
                } catch (error) {
                    console.error("í†µì‹  ì‹¤íŒ¨ (ì¬ì‹œë„ ì¤‘):", error);
                    lastError = error.message;
                    if (i === delays.length - 1) return { error: lastError };
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // íƒ­ ë° ì „ì†¡ ì´ë²¤íŠ¸
        let currentTab = 'vent';
        window.switchTab = function(tab) {
            currentTab = tab;
            ['vent', 'reframe', 'smallwin', 'motivate', 'breakdown'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                btn.classList.remove('tab-active');
                btn.classList.add('text-zinc-500');
                const form = document.getElementById(`form-${t}`);
                form.classList.add('hidden');
                form.classList.remove('block');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-zinc-500');
            document.getElementById(`form-${tab}`).classList.remove('hidden');
            document.getElementById(`form-${tab}`).classList.add('block');
        }

        window.handleSubmit = async function() {
            if (!currentUser) {
                if (document.getElementById('sync-status').innerText.includes('ì˜¤í”„ë¼ì¸')) {
                    // í†µê³¼
                } else {
                    alert("êµ¬ê¸€ ë¡œê·¸ì¸ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”!");
                    return;
                }
            }

            const btn = document.getElementById('submit-btn');
            let userText = "", logText = "", reframeGood = "";

            if (currentTab === 'vent') {
                const input = document.getElementById('input-vent');
                if (!input.value.trim()) return;
                userText = input.value; logText = input.value;
                input.value = ''; await saveMessage('user', logText);
            } else if (currentTab === 'reframe') {
                const inputBad = document.getElementById('input-reframe-bad');
                const inputGood = document.getElementById('input-reframe-good');
                if (!inputBad.value.trim() || !inputGood.value.trim()) return;
                userText = `ë¶€ì •ì  ìƒê°: ${inputBad.value} -> ê´€ëŒ€í•œ ìƒê°: ${inputGood.value}`;
                logText = inputBad.value; reframeGood = inputGood.value;
                inputBad.value = inputGood.value = ''; await saveMessage('user', logText, true, reframeGood);
            } else if (currentTab === 'smallwin') {
                const input = document.getElementById('input-smallwin');
                if (!input.value.trim()) return;
                userText = `ì˜¤ëŠ˜ í•´ë‚¸ ì¼: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText);
            } else if (currentTab === 'motivate') {
                const input = document.getElementById('input-motivate');
                if (!input.value.trim()) return;
                userText = `ë„í”¼í•˜ê³  ìˆëŠ” ê³¼ì œ/ì¼: ${input.value}`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText);
            } else if (currentTab === 'breakdown') {
                const input = document.getElementById('input-breakdown');
                if (!input.value.trim()) return;
                userText = `ë§‰ë§‰í•œ í° ëª©í‘œ: ${input.value} (ëª©í‘œ ìª¼ê°œê¸° ìš”ì²­)`; logText = input.value; 
                input.value = ''; await saveMessage('user', logText);
            }

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed', 'scale-95');
            const loadingId = showLoading();

            const aiResponse = await callGeminiAPI(userText, currentTab);

            removeLoading(loadingId);
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed', 'scale-95');

            if (aiResponse && aiResponse.deidara) {
                const emotion = aiResponse.emotion || "default";
                await saveMessage('deidara', aiResponse.deidara, false, '', emotion);
            } else if (aiResponse && aiResponse.error) {
                // ì–´ë–¤ ì—ëŸ¬ ë•Œë¬¸ì— í†µì‹ ì´ í„°ì¡ŒëŠ”ì§€ í™”ë©´ì— ì§ì ‘ ë¿Œë ¤ì¤ë‹ˆë‹¤!
                await saveMessage('deidara', `[ì‹œìŠ¤í…œ ì—ëŸ¬] í†µì‹  ì¥ì¹˜ê°€ í„°ì¡Œë‹¤, ìŒ!\nì—ëŸ¬ ì›ì¸: ${aiResponse.error}`, false, '', 'angry');
            } else {
                await saveMessage('deidara', "í†µì‹  ì¥ì¹˜ê°€ í„°ì ¸ë²„ë ¸ì–ì•„! ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ë´ë¼, ìŒ.", false, '', 'angry');
            }
        }

        document.querySelectorAll('input, textarea').forEach(el => {
            el.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    window.handleSubmit();
                }
            });
        });

    </script>
</body>
</html>
